[
    {
        "content": "<p>I'm writing some Lean4 FFI bindings for sqlite <a href=\"https://github.com/badly-drawn-wizards/sqlean/blob/5110ba57b95b41bd098981fb537c4441a168a7a7/lakefile.lean#L24\">here</a>. I have managed to get it to compile and <code>#eval</code> as a lean_lib, but I don't know how to set the linking options for building a lean_exe.</p>",
        "id": 412697634,
        "sender_full_name": "ohhaimark",
        "timestamp": 1705142903
    },
    {
        "content": "<p>Dug around and solved with <code>module_facet</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Lake</span>\n<span class=\"kn\">open</span> <span class=\"n\">Lake</span> <span class=\"n\">DSL</span>\n\n<span class=\"n\">package</span> <span class=\"n\">sqlean</span> <span class=\"n\">where</span>\n\n<span class=\"n\">target</span> <span class=\"n\">sqlean.o</span> <span class=\"n\">pkg</span> <span class=\"o\">:</span> <span class=\"n\">FilePath</span> <span class=\"o\">:=</span> <span class=\"k\">do</span>\n  <span class=\"k\">let</span> <span class=\"n\">oFile</span> <span class=\"o\">:=</span> <span class=\"n\">pkg.buildDir</span> <span class=\"bp\">/</span> <span class=\"s2\">\"c\"</span> <span class=\"bp\">/</span> <span class=\"s2\">\"sqlean.o\"</span>\n  <span class=\"k\">let</span> <span class=\"n\">srcJob</span> <span class=\"bp\">←</span> <span class=\"n\">inputFile</span> <span class=\"bp\">&lt;|</span> <span class=\"n\">pkg.dir</span> <span class=\"bp\">/</span> <span class=\"s2\">\"c\"</span> <span class=\"bp\">/</span> <span class=\"s2\">\"sqlean.cpp\"</span>\n  <span class=\"k\">let</span> <span class=\"n\">weakArgs</span> <span class=\"o\">:=</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-I\"</span><span class=\"o\">,</span> <span class=\"o\">(</span><span class=\"bp\">←</span> <span class=\"n\">getLeanIncludeDir</span><span class=\"o\">)</span><span class=\"bp\">.</span><span class=\"n\">toString</span><span class=\"o\">]</span>\n  <span class=\"n\">buildO</span> <span class=\"s2\">\"sqlean.cpp\"</span> <span class=\"n\">oFile</span> <span class=\"n\">srcJob</span> <span class=\"n\">weakArgs</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-fPIC\"</span><span class=\"o\">]</span> <span class=\"s2\">\"c++\"</span> <span class=\"n\">getLeanTrace</span>\n\n<span class=\"n\">target</span> <span class=\"n\">libsqlean</span> <span class=\"n\">pkg</span> <span class=\"o\">:</span> <span class=\"n\">FilePath</span> <span class=\"o\">:=</span> <span class=\"k\">do</span>\n  <span class=\"k\">let</span> <span class=\"n\">name</span> <span class=\"o\">:=</span> <span class=\"n\">nameToSharedLib</span> <span class=\"s2\">\"sqlean\"</span>\n  <span class=\"k\">let</span> <span class=\"n\">sqleanO</span> <span class=\"bp\">←</span> <span class=\"n\">fetch</span> <span class=\"bp\">&lt;|</span> <span class=\"n\">pkg.target</span> <span class=\"bp\">``</span><span class=\"n\">sqlean.o</span>\n  <span class=\"n\">buildLeanSharedLib</span> <span class=\"o\">(</span><span class=\"n\">pkg.nativeLibDir</span> <span class=\"bp\">/</span> <span class=\"n\">name</span><span class=\"o\">)</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"n\">sqleanO</span><span class=\"o\">]</span>\n\n<span class=\"n\">module_facet</span> <span class=\"n\">sqlean</span> <span class=\"n\">mod</span> <span class=\"o\">:</span> <span class=\"n\">FilePath</span> <span class=\"o\">:=</span> <span class=\"n\">libsqlean.fetch</span>\n\n<span class=\"kd\">@[</span><span class=\"n\">default_target</span><span class=\"kd\">]</span>\n<span class=\"n\">lean_lib</span> <span class=\"n\">Sqlean</span> <span class=\"n\">where</span>\n  <span class=\"n\">precompileModules</span> <span class=\"o\">:=</span> <span class=\"n\">true</span>\n  <span class=\"n\">extraDepTargets</span> <span class=\"o\">:=</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">``</span><span class=\"n\">libsqlean</span><span class=\"o\">]</span>\n  <span class=\"n\">nativeFacets</span> <span class=\"o\">:=</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"bp\">`</span><span class=\"n\">sqlean</span><span class=\"o\">,</span> <span class=\"n\">Module.oFacet</span><span class=\"o\">]</span>\n  <span class=\"n\">moreLinkArgs</span> <span class=\"o\">:=</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-lsqlite3\"</span><span class=\"o\">]</span>\n\n<span class=\"n\">lean_exe</span> <span class=\"n\">sqlean_test</span> <span class=\"n\">where</span>\n  <span class=\"n\">root</span> <span class=\"o\">:=</span> <span class=\"bp\">`</span><span class=\"n\">examples.test</span>\n  <span class=\"n\">moreLinkArgs</span> <span class=\"o\">:=</span> <span class=\"bp\">#</span><span class=\"o\">[</span><span class=\"s2\">\"-lsqlite3\"</span><span class=\"o\">]</span>\n</code></pre></div>",
        "id": 412719185,
        "sender_full_name": "ohhaimark",
        "timestamp": 1705160550
    }
]