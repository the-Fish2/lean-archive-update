[
    {
        "content": "<p>I'm hitting a weird bug in VSCode which makes it hard to add new lemmas to a simp list (which is a thing I do a lot!).  Basically, if I type something like <code>\\left </code> (space at the end) to enter a unicode character, after the space the cursor position is wrong (and thus continuing to type does weird stuff.  Here's a movie showing the cursor position issue:</p>\n<p><a href=\"/user_uploads/3121/wnwWs-fKV4aPmN7IW6jhLB9Z/vscode-lean-bug.mov\">vscode-lean-bug.mov</a></p>\n<p>Anyone else hitting this?  I can file it if it seems new.</p>\n<p>I'm using</p>\n<ol>\n<li>Version: 1.85.2 (Universal)Commit: 8b3775030ed1a69b13e4f4c628c612</li>\n<li>VSCode Lean plugin v0.0.125</li>\n<li>VSCode Vim plugin v1.27.2</li>\n<li>Lean (version 4.5.0-rc1, commit b614ff1d12bc, Release)</li>\n</ol>\n<p>This is new: I think it started today or yesterday.</p>",
        "id": 418713344,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1706559622
    },
    {
        "content": "<p>I've been experiencing similar problems for quite some time. It appears to be somewhat random whether the cursor is where you expect it or one position to the left. See <a href=\"https://github.com/leanprover-community/vscode-lean4/pull/332\">vscode-lean4#332</a> and <a href=\"#narrow/stream/113488-general/topic/.22Unable.20to.20replace.20abbreviation.22/near/411715240\">here</a>.</p>",
        "id": 418716200,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1706560613
    },
    {
        "content": "<p>Yes, I was getting the off by one thing too: sometimes it would appear right after the unicode character (no space), and sometimes it would leave a space.  But now it's full haywire and it's often several steps to the right, on top of other text.</p>",
        "id": 418716333,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1706560680
    },
    {
        "content": "<p>Ah, neat, and it was just (hopefully) fixed!</p>",
        "id": 418716463,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1706560727
    },
    {
        "content": "<p>Though it seems the <code>v0.0.125</code> version that I'm using includes those fixes (<a href=\"https://github.com/leanprover/vscode-lean4/releases/tag/v0.0.125\">https://github.com/leanprover/vscode-lean4/releases/tag/v0.0.125</a>), so it's possible those fixes are what recently made the problem way worse.</p>",
        "id": 418716886,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1706560910
    },
    {
        "content": "<p>Are you using any other extensions that may affect input?</p>",
        "id": 418717638,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1706561273
    },
    {
        "content": "<p>OK; I wasn't reading carefully enough. Come to think of it, I don't think I had the \"off-by-one\" problem recently...</p>",
        "id": 418717717,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1706561300
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221921\">Marc Huisinga</span> <a href=\"#narrow/stream/270676-lean4/topic/vscode.20cursor.20position.20bug/near/418717638\">said</a>:</p>\n<blockquote>\n<p>Are you using any other extensions that may affect input?</p>\n</blockquote>\n<p>Yes, VSCode Vim plugin v1.27.2 as mentioned.</p>",
        "id": 418717759,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1706561318
    },
    {
        "content": "<p>Yes, it looks like that's the culprit. I can't reproduce the issue without the Vim plugin but I can reproduce it with it.</p>",
        "id": 418717865,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1706561387
    },
    {
        "content": "<p>Also observing this, I kinda assumed it must be some local oddity (vim extension), because if it'd affect the default setup, it would be known already :-)</p>",
        "id": 418718733,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1706561736
    },
    {
        "content": "<p>Before the mitigation for the abbreviation issues, the VS Code extension would execute an edit against the text editor and then always manually displace the cursor afterwards. Since the text can change in-between those two points in time, the cursor placement was sometimes wrong.<br>\nThe mitigation now instead uses VS Code's builtin method of moving the cursor, so that the cursor move and text edit occur atomically.<br>\nEither the Vim plugin does some manual cursor manipulation of its own, or the edits that it sends to VS Code somehow interfere with that of vscode-lean4, making VS Code decide that the cursor now needs to be placed after that word.</p>",
        "id": 418718751,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1706561744
    },
    {
        "content": "<p>I'll look into it tomorrow, but I suspect that there might be no good fix for this. Maybe I can add a fallback to the old behavior for Vim plugin users, though that will still exhibit the race condition bugs that occurred before.</p>",
        "id": 418718959,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1706561836
    },
    {
        "content": "<p>Thank you!  The new behavior is quite difficult to work with, so while it would be nice to have determinism the new behavior is reliably bad.</p>",
        "id": 418719130,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1706561906
    },
    {
        "content": "<p>So, interestingly, I have all the same info as Geoffrey, except I'm on VS Code 1.85.1 instead of 1.85.2, and I use the Vim extension, but I <em>don't</em> reproduce his issue.</p>",
        "id": 418719590,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1706562077
    },
    {
        "content": "<p>Using <a href=\"https://github.com/vscode-neovim/vscode-neovim\">https://github.com/vscode-neovim/vscode-neovim</a> as the Vim plugin instead seems to fix it (hard to wait for a fix since it's hard for me to type without working vim + unicode).</p>",
        "id": 418721234,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1706562685
    },
    {
        "content": "<p>So I am set for now. :)</p>",
        "id": 418721257,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1706562694
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/stream/270676-lean4/topic/vscode.20cursor.20position.20bug/near/418719590\">said</a>:</p>\n<blockquote>\n<p>So, interestingly, I have all the same info as Geoffrey, except I'm on VS Code 1.85.1 instead of 1.85.2, and I use the Vim extension, but I <em>don't</em> reproduce his issue.</p>\n</blockquote>\n<p>There's a chance that it's affected by the order in which VS Code decides to execute both extensions, but I don't think that we can change that regardless.</p>",
        "id": 418724396,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1706563840
    },
    {
        "content": "<p>Thank you for struggling through what sounds like broken surrounding software!  The lack of transactions seems like a major glitch.</p>",
        "id": 418725957,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1706564504
    },
    {
        "content": "<p>The mitigation suggested above has been released now and you should be able to use vscode-lean4 together with VSCodeVim again. Nonetheless, using the NeoVim plugin instead is preferable because it is not subject to abbreviation race conditions.</p>",
        "id": 419004778,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1706695482
    },
    {
        "content": "<p>I do think the neovim plugin feels quite a bit snappier, possibly because of those race conditions.  Though it does have some other (much less bad) bugs: <a href=\"https://github.com/vscode-neovim/vscode-neovim/issues/1766\">https://github.com/vscode-neovim/vscode-neovim/issues/1766</a></p>",
        "id": 419004925,
        "sender_full_name": "Geoffrey Irving",
        "timestamp": 1706695539
    }
]