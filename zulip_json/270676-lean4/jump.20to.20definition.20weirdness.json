[
    {
        "content": "<p>Can anyone else reproduce this? I've had this problem for ages with this repo. It's kind of a magic trick.</p>\n<p>Step 1: surf your way to <a href=\"https://github.com/kbuzzard/MweSkeletons\">https://github.com/kbuzzard/MweSkeletons</a> and install the repo. It has mathlib as a dependency (for convenience when minimising, the purpose of this repo) but if you click around the files in the repo you'll convince yourself that no mathlib file is ever imported.</p>\n<p>Step 2: fire up the repo and open the file <code>MweSkeletons.broken_jump_to_def</code></p>\n<p>Step 3: Verify that the only import in that file is <code>MweSkeletons.CommRing</code> which itself has no imports at all (it builds up a chunk of the alegbra heirarchy up to about <code>CommRing</code>). </p>\n<p>Step 4: In the <code>#check CommRing</code> in that file, observe that hovering over <code>CommRing</code> tells you that it's coming from file <code>MweSkeletons.CommRing</code>, as expected. Now, make sure that the file MweSkeletons.CommRing isn't open in VS Code.</p>\n<p>Step 5: Now jump to definition <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span>  Thank you very much, I've been Kevin Buzzard and you are now in mathlib.</p>",
        "id": 419547118,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706913881
    },
    {
        "content": "<p>Oh -- much easier repro: fire up a local copy of mathlib, make two new files <code>Mathlib/foo.lean</code> containing <code>def CommRing := Nat</code> and <code>Mathlib/bar.lean</code> containing two lines <code>import Mathlib.foo</code> and then <code>#check CommRing</code>, make sure <code>foo</code> isn't open in VS Code and then go to step 4 above. Lean jumps to the wrong CommRing. Here I'm a bit more confused about things because you shouldn't have two definitions of CommRing in one repo I guess...</p>",
        "id": 419548023,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706914338
    },
    {
        "content": "<p>(this all stems from trying to minimise <a href=\"#narrow/stream/270676-lean4/topic/typeclass.20inference.20failure/near/419350197\">this</a> BTW, this \"feature\" is a real pain when manually minimising).</p>",
        "id": 419548606,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706914678
    },
    {
        "content": "<p>trying it now... should I really click \"Yes, I trust the authors\"? ;)</p>",
        "id": 419551448,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706916197
    },
    {
        "content": "<p>ha ha, there is nothing up my sleeve! You can just try it with mathlib if you like :-)</p>",
        "id": 419551510,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706916239
    },
    {
        "content": "<p>for me it jumps to the definition in the repo</p>",
        "id": 419551559,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706916246
    },
    {
        "content": "<p>?! Are you sure you had the correct target file closed in VS Code when you jumped? It works for me iff the correct file is open.</p>",
        "id": 419551607,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706916279
    },
    {
        "content": "<p>... now it just jumped to mathlib.</p>",
        "id": 419551704,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706916342
    },
    {
        "content": "<p>WTF</p>",
        "id": 419551707,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706916344
    },
    {
        "content": "<p>Wooah -- for me it's just started jumping to the repo CommRing?!</p>",
        "id": 419551829,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706916410
    },
    {
        "content": "<p>wait, now I restarted vscode and it jumped to the correct place again</p>",
        "id": 419551831,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706916412
    },
    {
        "content": "<p>something really strange is happening!</p>",
        "id": 419551855,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706916426
    },
    {
        "content": "<p>Looks like it's not the most reliable of magic tricks but still...</p>",
        "id": 419551904,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706916469
    },
    {
        "content": "<p>I can't get it to jump to mathlib anymore</p>",
        "id": 419551975,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706916499
    },
    {
        "content": "<p>Maybe it never happened</p>",
        "id": 419551993,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706916515
    },
    {
        "content": "<p>Yeah, I can't get it to happen either. Maybe it depends on how many minutes past the hour you are or something.</p>",
        "id": 419552088,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706916600
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/KoFMSeDx-8MvIBuVoSrAUL4y/Peek-2024-02-02-16-30.gif\">Peek-2024-02-02-16-30.gif</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/KoFMSeDx-8MvIBuVoSrAUL4y/Peek-2024-02-02-16-30.gif\" title=\"Peek-2024-02-02-16-30.gif\"><img src=\"/user_uploads/3121/KoFMSeDx-8MvIBuVoSrAUL4y/Peek-2024-02-02-16-30.gif\"></a></div>",
        "id": 419552180,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706916640
    },
    {
        "content": "<p>now it's backwards</p>",
        "id": 419552186,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706916644
    },
    {
        "content": "<p>wooah I've never got the import statement on hover to be mathlib.</p>",
        "id": 419552254,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706916702
    },
    {
        "content": "<p>I switched the import!</p>",
        "id": 419552327,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706916736
    },
    {
        "content": "<p>So the hover always indicates the correct import, but the CommRing which you land on is random.</p>",
        "id": 419552431,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706916798
    },
    {
        "content": "<p>I don't think it's random. But I don't see a pattern yet.</p>",
        "id": 419552487,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706916839
    },
    {
        "content": "<p>Is this just explained by the fact that there are two definitions of <code>CommRing</code> in the repo (one of them only in a dependency)</p>",
        "id": 419552515,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706916843
    },
    {
        "content": "<p>Oh lol what happens if you jump to definition on the actual mathlib definition of CommRing??</p>",
        "id": 419552658,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706916950
    },
    {
        "content": "<p>it seems to jump to your repo again.</p>",
        "id": 419552755,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706916994
    },
    {
        "content": "<p>Yeah, me too. But I can't jump back for some reason.</p>",
        "id": 419552796,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706917021
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/1KsjCrBGJ5S2bLqbqmH1jwb4/Peek-2024-02-02-16-37.gif\">Peek-2024-02-02-16-37.gif</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/1KsjCrBGJ5S2bLqbqmH1jwb4/Peek-2024-02-02-16-37.gif\" title=\"Peek-2024-02-02-16-37.gif\"><img src=\"/user_uploads/3121/1KsjCrBGJ5S2bLqbqmH1jwb4/Peek-2024-02-02-16-37.gif\"></a></div>",
        "id": 419552845,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706917051
    },
    {
        "content": "<p>clearly a bug... the question is where?</p>",
        "id": 419552878,
        "sender_full_name": "Adam Topaz",
        "timestamp": 1706917073
    },
    {
        "content": "<p>So that is a reliable repro for me -- this CommRing file has no imports and gives new definitions of <code>CommRing</code>, <code>CommSemiring</code> etc, and then when you're in the definition of CommSemiring in the dependency you can still jump to definition (which should be a no op) and then you jump to the local one.</p>",
        "id": 419553120,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706917210
    },
    {
        "content": "<p>So here's a video of the weirdness from first principles in mathlib:</p>\n<p><a href=\"/user_uploads/3121/jvJufyi8sLcy1FbTLZAnEgQ2/jump_to_def_weirdness.gif\">jump_to_def_weirdness.gif</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/jvJufyi8sLcy1FbTLZAnEgQ2/jump_to_def_weirdness.gif\" title=\"jump_to_def_weirdness.gif\"><img src=\"/user_uploads/3121/jvJufyi8sLcy1FbTLZAnEgQ2/jump_to_def_weirdness.gif\"></a></div><p>You define <code>Group</code> again, in a file which isn't imported by anything, and then jump to definition on mathlib's actual Group jumps to the not-imported file.</p>",
        "id": 419553587,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706917496
    },
    {
        "content": "<p>Thanks Adam for confirming that it wasn't just me!</p>",
        "id": 419553765,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1706917632
    },
    {
        "content": "<p>This is somewhat expected, or at least the mechanisms for the bug all exist. Have you ever noticed that you can run go-to-definition on an identifier <em>before</em> the yellow bar reaches the line in question?</p>",
        "id": 419554615,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706918243
    },
    {
        "content": "<p>(Also: <a href=\"https://github.com/leanprover/lean4/pull/1170\">lean4#1170</a>)</p>",
        "id": 419554694,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1706918285
    },
    {
        "content": "<p>The reason is because the lean server uses <code>.ilean</code> files to resolve identifiers, which may be out of date and/or not match up with the import structure</p>",
        "id": 419554752,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706918339
    },
    {
        "content": "<p>How do I update them? Sometimes emacs jumps to the location of the definition on master branch while I'm working on a branch where I edited that file and the definition went up or down.</p>",
        "id": 423286130,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1708889414
    },
    {
        "content": "<p>With <code>lake build</code>. The server should auto-reload the files, though Emacs sometimes asks you whether you want to deactivate that, for big directories</p>",
        "id": 423294405,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1708897784
    }
]