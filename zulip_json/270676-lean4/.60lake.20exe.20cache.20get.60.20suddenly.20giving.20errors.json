[
    {
        "content": "<p>I just attempted to run <code>lake exe cache get</code>, which I run all the time in <code>mathlib</code>, and I got this error:</p>\n<p><code>/home/wrobson/.elan/toolchains/leanprover--lean4---v4.5.0/bin/lake: error while loading shared libraries: libleanshared.so: cannot open shared object file: No such file or directory</code></p>\n<p>I don't know how to fix this, or how I might go about uninstalling elan/lake from scratch to fix it.</p>",
        "id": 419212385,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1706782047
    },
    {
        "content": "<p>I tried just getting rid of my toolchain dir in <code>.elan</code> but that didn't work, it just complained about there being no toolchain.</p>",
        "id": 419213156,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1706782295
    },
    {
        "content": "<p>I note that 4.5.0 just released - could there be some issue with it?</p>",
        "id": 419213443,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1706782392
    },
    {
        "content": "<p>don't forget to remove the corresponding file in <code>.elan/update-hashes</code> too, or else you will break your elan install</p>",
        "id": 419213583,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706782445
    },
    {
        "content": "<p>Aha</p>",
        "id": 419213619,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1706782461
    },
    {
        "content": "<p>I mean I suppose I could try just nuking elan?</p>",
        "id": 419213683,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1706782490
    },
    {
        "content": "<p>the better approach is to use <code>elan toolchain uninstall ...</code> which does this for you</p>",
        "id": 419213687,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706782490
    },
    {
        "content": "<p>Ta. Tried <code>elan toolchain uninstall leanprover/lean4:v4.5.0</code>, now running <code>lake exe cache get</code> again which will reinstall it and hopefully not flip up whatever it flipped up last time.</p>",
        "id": 419213916,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1706782575
    },
    {
        "content": "<p>Yeah this is looking more promising. Weird that it happened though.</p>",
        "id": 419213952,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1706782592
    },
    {
        "content": "<p>That <em>is</em> pretty weird, I can only assume a corrupted download. If someone wants to investigate why elan seemingly doesn't catch those...</p>",
        "id": 419216356,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1706783553
    },
    {
        "content": "<p>seems hard to reproduce</p>",
        "id": 419217439,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706783940
    },
    {
        "content": "<p>Yes, but as a first step we can double-check the logic that <em>should</em> catch this, perhaps also compare with current rustup</p>",
        "id": 419217699,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1706784044
    },
    {
        "content": "<p>my guess would be that elan (or tar?) was killed in the middle of unpacking</p>",
        "id": 419217829,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706784097
    },
    {
        "content": "<p>I don't see how elan could possibly catch that, or recover from it unless it is doing checksums every time</p>",
        "id": 419218000,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706784146
    },
    {
        "content": "<p>Without checking it wouldn't surprise me if rustup made that atomic at some point</p>",
        "id": 419218005,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1706784148
    },
    {
        "content": "<p>isn't unpacking impossible to do atomically since it touches multiple files?</p>",
        "id": 419218096,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706784176
    },
    {
        "content": "<p>The usual way I'd say: unpack into temp directory, move into place atomically</p>",
        "id": 419218100,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1706784177
    },
    {
        "content": "<p>or that</p>",
        "id": 419218117,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706784183
    },
    {
        "content": "<p>Okay, there's still the update hash file but that's a tiny race condition window and will eventually be removed anyway</p>",
        "id": 419218203,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1706784206
    },
    {
        "content": "<p>what is even in it?</p>",
        "id": 419218229,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706784217
    },
    {
        "content": "<p>Some kinda hash :)</p>",
        "id": 419218264,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1706784228
    },
    {
        "content": "<p>It only exists because we currently have mutable toolchain directories like <code>stable</code></p>",
        "id": 419218361,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1706784248
    },
    {
        "content": "<p>How does elan know where to download things?</p>",
        "id": 419218479,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706784296
    },
    {
        "content": "<p>are all the release sources hard coded?</p>",
        "id": 419218509,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706784305
    },
    {
        "content": "<p>The original error sounds like something I'd expect after running <code>nix-collect-garbage</code>, but it's pretty unlikely that Nix is being used here.</p>",
        "id": 419218623,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1706784351
    },
    {
        "content": "<p>the error message is consistent with the .so file being missing, which makes sense since it's one of the largest files in the download, so if tar was interrupted during unpacking you would be likely to not have it</p>",
        "id": 419218841,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706784419
    }
]