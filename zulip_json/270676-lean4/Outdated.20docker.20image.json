[
    {
        "content": "<p>Annoyingly, the update to elan 3.1.0 is transitive on gitpod, so I get asked whether I want to update elan every time I open a workspace</p>",
        "id": 441492493,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1717084517
    },
    {
        "content": "<p>I think that means a docker image needs rebuilding / invalidating</p>",
        "id": 441494541,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1717084925
    },
    {
        "content": "<p>I agree, but I don't know which one, where, nor how</p>",
        "id": 441501338,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1717086588
    },
    {
        "content": "<p>I've been poking around for an hour but I literally cannot even figure <em>where the docker image is stored</em> <span aria-label=\"frowning\" class=\"emoji emoji-1f626\" role=\"img\" title=\"frowning\">:frowning:</span></p>",
        "id": 441810254,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1717191124
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/blob/master/.docker/gitpod/Dockerfile\">https://github.com/leanprover-community/mathlib4/blob/master/.docker/gitpod/Dockerfile</a></p>",
        "id": 441815113,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1717192873
    },
    {
        "content": "<p>Based on <a href=\"https://stackoverflow.com/a/72971216/102441\">https://stackoverflow.com/a/72971216/102441</a>, the error is that we used <code>RUN</code> and not <code>ADD</code> there</p>",
        "id": 441815388,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1717192995
    },
    {
        "content": "<p>The former caches the url, the latter caches the result pointed to by the url</p>",
        "id": 441815418,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1717193011
    },
    {
        "content": "<p>Or alternatively, we should hard-code a version, to avoid rebuilding an image for every elan update</p>",
        "id": 441816353,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1717193425
    },
    {
        "content": "<p>I guess the release cadence is low enough for it to not matter</p>",
        "id": 441816437,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1717193477
    },
    {
        "content": "<p>The easiest option is to add some no-op command to the docker file before the elan installation, to cause a one-off cache invalidation</p>",
        "id": 441819733,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1717195041
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310045\">Eric Wieser</span> <a href=\"#narrow/stream/270676-lean4/topic/Better.20setup.20diagnostics.20in.20VS.20Code/near/441815113\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/leanprover-community/mathlib4/blob/master/.docker/gitpod/Dockerfile\">https://github.com/leanprover-community/mathlib4/blob/master/.docker/gitpod/Dockerfile</a></p>\n</blockquote>\n<p>That's not the image. That's the dockerfile.</p>",
        "id": 441866777,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1717224483
    },
    {
        "content": "<p>Sky answered my question: Apparently the image is hidden in some gitpod server and there's a way to ask for a regeneration, which I'm going to try now</p>",
        "id": 441866829,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1717224545
    },
    {
        "content": "<p>I think we would do better to change the dockerfile to bust their (and anyone else's) cache</p>",
        "id": 441869195,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1717226639
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/270676-lean4/topic/Better.20setup.20diagnostics.20in.20VS.20Code/near/441866829\">said</a>:</p>\n<blockquote>\n<p>there's a way to ask for a regeneration, which I'm going to try now</p>\n</blockquote>\n<p>It did regenerate the image but I ended up with <code>elan 3.0.0</code> again <span aria-label=\"frowning\" class=\"emoji emoji-1f626\" role=\"img\" title=\"frowning\">:frowning:</span> Are we pinning the version of elan somehow?</p>",
        "id": 441870668,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1717227575
    },
    {
        "content": "<p>I just found <a href=\"https://hub.docker.com/r/leanprovercommunity/mathlib\">https://hub.docker.com/r/leanprovercommunity/mathlib</a>... which hasn't been updated in a year and is Lean 3?</p>",
        "id": 441882232,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1717235013
    },
    {
        "content": "<p>Original problem fixed in <a href=\"https://github.com/leanprover-community/mathlib4/pull/13439\">#13439</a></p>",
        "id": 441885567,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1717236773
    },
    {
        "content": "<p>I think it's inadvisable to update the Docker image, as then it'll need to be rebuilt after every elan update. Since elan self-updates really fast (&lt;1s), I just added a step to <code>gitpod.yml</code> to do the update on workspace initialisation.</p>",
        "id": 441886190,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1717237171
    },
    {
        "content": "<p>(At least for gitpod's Dockerfile - if anyone's using the Dockerfile for other things maybe it's worth changing.)</p>",
        "id": 441886294,
        "sender_full_name": "Sky Wilshaw",
        "timestamp": 1717237222
    }
]