[
    {
        "content": "<p>My Lean server either crashes or doesn't update at all whenever I create a new file. Here's an example error log:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">Watchdog</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">cannot</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"kn\">open</span><span class=\"w\"> </span><span class=\"n\">document</span><span class=\"w\"> </span><span class=\"bp\">'</span><span class=\"n\">file</span><span class=\"o\">:</span><span class=\"bp\">///</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">bmehta</span><span class=\"bp\">/</span><span class=\"n\">Documents</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">carleson</span><span class=\"bp\">/</span><span class=\"n\">Carleson</span><span class=\"bp\">/</span><span class=\"n\">blank</span><span class=\"bp\">.</span><span class=\"n\">lean'</span>\n<span class=\"o\">[</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"o\">:</span><span class=\"mi\">26</span><span class=\"o\">:</span><span class=\"mi\">07</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Client</span><span class=\"w\"> </span><span class=\"n\">Lean</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">connection</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">erroring</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">Shutting</span><span class=\"w\"> </span><span class=\"n\">down</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"bp\">.</span>\n<span class=\"o\">[</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"o\">:</span><span class=\"mi\">26</span><span class=\"o\">:</span><span class=\"mi\">07</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Sending</span><span class=\"w\"> </span><span class=\"n\">document</span><span class=\"w\"> </span><span class=\"n\">notification</span><span class=\"w\"> </span><span class=\"n\">textDocument</span><span class=\"bp\">/</span><span class=\"n\">didChange</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n<span class=\"n\">Error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Cannot</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">write</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">stream</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">destroyed</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">NodeError</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">:</span><span class=\"n\">internal</span><span class=\"bp\">/</span><span class=\"n\">errors</span><span class=\"o\">:</span><span class=\"mi\">406</span><span class=\"o\">:</span><span class=\"mi\">5</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">write</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">:</span><span class=\"n\">internal</span><span class=\"bp\">/</span><span class=\"n\">streams</span><span class=\"bp\">/</span><span class=\"n\">writable</span><span class=\"o\">:</span><span class=\"mi\">380</span><span class=\"o\">:</span><span class=\"mi\">11</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">Socket</span><span class=\"bp\">.</span><span class=\"n\">Writable</span><span class=\"bp\">.</span><span class=\"n\">write</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">:</span><span class=\"n\">internal</span><span class=\"bp\">/</span><span class=\"n\">streams</span><span class=\"bp\">/</span><span class=\"n\">writable</span><span class=\"o\">:</span><span class=\"mi\">393</span><span class=\"o\">:</span><span class=\"mi\">10</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">bmehta</span><span class=\"bp\">/.</span><span class=\"n\">vscode</span><span class=\"bp\">/</span><span class=\"n\">extensions</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">.</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"mf\">0.0</span><span class=\"bp\">.</span><span class=\"m\">168</span><span class=\"bp\">/</span><span class=\"n\">dist</span><span class=\"bp\">/</span><span class=\"n\">extension</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">606745</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">Promise</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&lt;</span><span class=\"n\">anonymous</span><span class=\"bp\">&gt;</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">write</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">bmehta</span><span class=\"bp\">/.</span><span class=\"n\">vscode</span><span class=\"bp\">/</span><span class=\"n\">extensions</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">.</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"mf\">0.0</span><span class=\"bp\">.</span><span class=\"m\">168</span><span class=\"bp\">/</span><span class=\"n\">dist</span><span class=\"bp\">/</span><span class=\"n\">extension</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">606663</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">doWrite</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">bmehta</span><span class=\"bp\">/.</span><span class=\"n\">vscode</span><span class=\"bp\">/</span><span class=\"n\">extensions</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">.</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"mf\">0.0</span><span class=\"bp\">.</span><span class=\"m\">168</span><span class=\"bp\">/</span><span class=\"n\">dist</span><span class=\"bp\">/</span><span class=\"n\">extension</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">594277</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">bmehta</span><span class=\"bp\">/.</span><span class=\"n\">vscode</span><span class=\"bp\">/</span><span class=\"n\">extensions</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">.</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"mf\">0.0</span><span class=\"bp\">.</span><span class=\"m\">168</span><span class=\"bp\">/</span><span class=\"n\">dist</span><span class=\"bp\">/</span><span class=\"n\">extension</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">594172</span>\n<span class=\"o\">[</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"o\">:</span><span class=\"mi\">26</span><span class=\"o\">:</span><span class=\"mi\">07</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Connection</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"w\"> </span><span class=\"n\">got</span><span class=\"w\"> </span><span class=\"n\">closed</span><span class=\"bp\">.</span><span class=\"w\"> </span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">restarted</span><span class=\"bp\">.</span>\n<span class=\"o\">[</span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"o\">:</span><span class=\"mi\">26</span><span class=\"o\">:</span><span class=\"mi\">07</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"n\">Sending</span><span class=\"w\"> </span><span class=\"n\">document</span><span class=\"w\"> </span><span class=\"n\">notification</span><span class=\"w\"> </span><span class=\"n\">textDocument</span><span class=\"bp\">/</span><span class=\"n\">didChange</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n<span class=\"n\">Error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">Cannot</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">write</span><span class=\"w\"> </span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">stream</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">destroyed</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">NodeError</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">:</span><span class=\"n\">internal</span><span class=\"bp\">/</span><span class=\"n\">errors</span><span class=\"o\">:</span><span class=\"mi\">406</span><span class=\"o\">:</span><span class=\"mi\">5</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">_</span><span class=\"n\">write</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">:</span><span class=\"n\">internal</span><span class=\"bp\">/</span><span class=\"n\">streams</span><span class=\"bp\">/</span><span class=\"n\">writable</span><span class=\"o\">:</span><span class=\"mi\">380</span><span class=\"o\">:</span><span class=\"mi\">11</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">Socket</span><span class=\"bp\">.</span><span class=\"n\">Writable</span><span class=\"bp\">.</span><span class=\"n\">write</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"n\">node</span><span class=\"o\">:</span><span class=\"n\">internal</span><span class=\"bp\">/</span><span class=\"n\">streams</span><span class=\"bp\">/</span><span class=\"n\">writable</span><span class=\"o\">:</span><span class=\"mi\">393</span><span class=\"o\">:</span><span class=\"mi\">10</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">bmehta</span><span class=\"bp\">/.</span><span class=\"n\">vscode</span><span class=\"bp\">/</span><span class=\"n\">extensions</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">.</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"mf\">0.0</span><span class=\"bp\">.</span><span class=\"m\">168</span><span class=\"bp\">/</span><span class=\"n\">dist</span><span class=\"bp\">/</span><span class=\"n\">extension</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">606745</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">Promise</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">&lt;</span><span class=\"n\">anonymous</span><span class=\"bp\">&gt;</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"bp\">.</span><span class=\"n\">write</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">bmehta</span><span class=\"bp\">/.</span><span class=\"n\">vscode</span><span class=\"bp\">/</span><span class=\"n\">extensions</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">.</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"mf\">0.0</span><span class=\"bp\">.</span><span class=\"m\">168</span><span class=\"bp\">/</span><span class=\"n\">dist</span><span class=\"bp\">/</span><span class=\"n\">extension</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">606663</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"bp\">.</span><span class=\"n\">doWrite</span><span class=\"w\"> </span><span class=\"o\">(</span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">bmehta</span><span class=\"bp\">/.</span><span class=\"n\">vscode</span><span class=\"bp\">/</span><span class=\"n\">extensions</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">.</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"mf\">0.0</span><span class=\"bp\">.</span><span class=\"m\">168</span><span class=\"bp\">/</span><span class=\"n\">dist</span><span class=\"bp\">/</span><span class=\"n\">extension</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">594277</span><span class=\"o\">)</span>\n<span class=\"w\">    </span><span class=\"k\">at</span><span class=\"w\"> </span><span class=\"bp\">/</span><span class=\"n\">Users</span><span class=\"bp\">/</span><span class=\"n\">bmehta</span><span class=\"bp\">/.</span><span class=\"n\">vscode</span><span class=\"bp\">/</span><span class=\"n\">extensions</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">.</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"mf\">0.0</span><span class=\"bp\">.</span><span class=\"m\">168</span><span class=\"bp\">/</span><span class=\"n\">dist</span><span class=\"bp\">/</span><span class=\"n\">extension</span><span class=\"bp\">.</span><span class=\"n\">js</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">594172</span>\n</code></pre></div>\n<p>I've had this on 4.9.0-rc1 and 4.9.0-rc2, in different projects, and on different machines with different OSes and different installation setups. It reproduces for me on gitpod too.<br>\nHere are the steps I take to reliably crash Lean on my usual setup</p>\n<p>1) Have a running Lean server, working on a Lean file <br>\n2) Open a new file in VSCode in the same directory <br>\n3) Save it as <code>test.lean</code> <br>\n4) Write <code>example : 1 = 1 := rfl</code> in the file <br>\n5) Save the file <br>\n6) Lean server crashes</p>\n<p>Doing the same thing on gitpod, but with 1 = 2 in place of step 4 gives no error and no changes in the infoview. Both of these are solved by restarting lean, but this usually has a big time cost. </p>\n<p>How can I debug this further?</p>",
        "id": 446419086,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719149372
    },
    {
        "content": "<p>Same here</p>",
        "id": 446419843,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1719149992
    },
    {
        "content": "<p>The error should only occur before rc2, but I can reproduce that the language server doesn't work on the file when using rc2 (i.e. the Gitpod case you mention). I'll investigate.</p>",
        "id": 446420885,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1719150810
    },
    {
        "content": "<p>Looks like this is another edge case in the series of VS Code bugs and API deficiencies that lead to <a href=\"https://github.com/leanprover-community/vscode-lean4/pull/460\">vscode-lean4#460</a>.<br>\nApparently, in this particular way of opening documents, VS Code does not update the <code>window.tabGroups</code> field before the language client library attempts to send a <code>didOpen</code> request to the server, so we conclude that it is one of those \"invisible\" Lean documents that VS Code sometimes tries to open in the background that we don't want to spam the language server with.<br>\nI'm not sure how to fix this yet. <code>window.tabGroups</code> is the closest approximation I know of to filter the invisible documents that VS Code often attempts to open, but it doesn't allow us to distinguish the new document in this case from actual invisible documents. VS Code doesn't provide any alternative API to deal with this issue, either.</p>\n<p>I'll think some more about it tomorrow, but the workaround for this on rc2 is that you can close <code>test.lean</code> and then re-open it. Then, when the language client attempts to open the document, VS Code will already have updated <code>window.tabGroups</code>.</p>",
        "id": 446422739,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1719152465
    },
    {
        "content": "<p>I see, thanks for the workaround. I would make an issue for this but I don't know enough about the actual cause to be able to explain it properly, would you mind?</p>",
        "id": 446423717,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719153014
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/stream/270676-lean4/topic/Server.20crashes.20on.20new.20file/near/446423717\">said</a>:</p>\n<blockquote>\n<p>I see, thanks for the workaround. I would make an issue for this but I don't know enough about the actual cause to be able to explain it properly, would you mind?</p>\n</blockquote>\n<p>An issue with the reproduction steps above and a link to this thread is perfectly sufficient!</p>",
        "id": 446423879,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1719153133
    },
    {
        "content": "<p>It should be an issue on <a href=\"https://github.com/leanprover/vscode-lean4\">vscode-lean4</a> rather than lean4 itself right?</p>",
        "id": 446423970,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719153231
    },
    {
        "content": "<p>Yes, the problem is VS Code being broken and vscode-lean4 desperately and insufficiently trying to work around it. The language server is doing the right thing here.</p>",
        "id": 446424088,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1719153304
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/vscode-lean4/issues/484\">https://github.com/leanprover/vscode-lean4/issues/484</a></p>",
        "id": 446424494,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719153582
    },
    {
        "content": "<p>Since I don't really see a way forward to fix this issue on our end at the moment in a way that meets all requirements, I've <a href=\"https://github.com/microsoft/vscode-languageserver-node/issues/848#issuecomment-2185043021\">asked the VS Code developers for clarification</a>. Let's see what comes of this; the most likely way forward that I see is that VS Code fixes whatever issue causes <code>window.tabGroups</code> to not be up-to-date here.</p>",
        "id": 446432833,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1719157333
    },
    {
        "content": "<p>I seem to still get (a milder version of) this, where I open an existing file but the server doesn't seem to register it. Closing the file and re-opening it doesn't help, only restarting the server with the second file open works. Is there a workaround better than restarting the server? I presume it's the same root cause as the above</p>",
        "id": 447351002,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719442445
    },
    {
        "content": "<p>rc2, v0.0.169, macOS</p>",
        "id": 447351077,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719442483
    },
    {
        "content": "<p>Can you give a repro?</p>",
        "id": 447379538,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719459420
    },
    {
        "content": "<p>1) Have file open with Lean working as normal<br>\n2) Open a different, existing file<br>\n3) About 30% of the time, for me, the info view doesn't react to the new file, including no errors on obvious problems</p>",
        "id": 447438594,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719482938
    },
    {
        "content": "<p>When this happens, is there an error in the debug console? (Ctrl+Shift+P &gt; Developer: Toggle Developer Tools, and then the output in the \"Console\" tab)</p>",
        "id": 447442930,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1719484200
    },
    {
        "content": "<p>I don't think so, but I will double check later today.</p>",
        "id": 447507385,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719501909
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"246273\">@Bhavik Mehta</span>, is this in gitpod? If not, which OS? I think we're going to have to get more specific about your system to be able to help here.</p>",
        "id": 447647519,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719547278
    },
    {
        "content": "<p>MacOS monterrey, version 12.5</p>",
        "id": 447737826,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719573334
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"221921\">Marc Huisinga</span> <a href=\"#narrow/stream/270676-lean4/topic/Server.20crashes.20on.20new.20file/near/447442930\">said</a>:</p>\n<blockquote>\n<p>When this happens, is there an error in the debug console? (Ctrl+Shift+P &gt; Developer: Toggle Developer Tools, and then the output in the \"Console\" tab)</p>\n</blockquote>\n<p>Just double checked, and there's no error in the debug console.</p>",
        "id": 447738201,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719573439
    },
    {
        "content": "<p>Please let me know if there's any other debug information I can provide!</p>",
        "id": 447738243,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719573450
    },
    {
        "content": "<p>I just had it on gitpod too - opening a new file from cmd-click an import, and the infoview has no reaction</p>",
        "id": 447739765,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719573857
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/270676-lean4/topic/Server.20crashes.20on.20new.20file/near/447379538\">said</a>:</p>\n<blockquote>\n<p>Can you give a repro?</p>\n</blockquote>\n<p>Hopefully this helps: <a href=\"https://www.youtube.com/watch?v=2z-0eypIQuk\">https://www.youtube.com/watch?v=2z-0eypIQuk</a></p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"2z-0eypIQuk\" href=\"https://www.youtube.com/watch?v=2z-0eypIQuk\"><img src=\"https://uploads.zulipusercontent.net/3944e72c51969342ac96009b83543d6fafc1f109/68747470733a2f2f692e7974696d672e636f6d2f76692f327a2d306579704951756b2f64656661756c742e6a7067\"></a></div>",
        "id": 447743184,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719574931
    },
    {
        "content": "<p>Hmmm. DId you ever encounter this issue when not using SSH?</p>",
        "id": 447743724,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1719575108
    },
    {
        "content": "<p>Yes, it also happens for me locally (that's what the original macos, rc2, v0.0.169 was referring to)</p>",
        "id": 447743977,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719575192
    },
    {
        "content": "<p>Most frustrating is the fact that closing the (second) file and re-opening it doesn't make the infoview respond, neither does closing the second file and restarting the server; nor closing the second file and reloading vscode. The only fix seems to be to restart the server after opening the second file, which means I need to restart the server about one in every three files I open and want to get any information for. As an aside, this means I'm finding the #align statements really useful to tell me what the right namespace is to use a lemma, since Lean can't tell me this!</p>",
        "id": 447744381,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719575313
    },
    {
        "content": "<p>I have experienced this as well (on Linux): I restart the server fairly frequently.</p>",
        "id": 447745283,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1719575583
    },
    {
        "content": "<p>I can reproduce this in gitpod!</p>",
        "id": 447746023,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719575802
    },
    {
        "content": "<p>(Works fine locally)</p>",
        "id": 447746034,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719575807
    },
    {
        "content": "<p>Is there any further information I can give to help debug the local issue?</p>",
        "id": 447782171,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719583920
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/stream/270676-lean4/topic/Server.20crashes.20on.20new.20file/near/447782171\">said</a>:</p>\n<blockquote>\n<p>Is there any further information I can give to help debug the local issue?</p>\n</blockquote>\n<p>I still can't reproduce the issue myself (I have a suspicion that it has to do with latency, and perhaps I'm just too close to the GitPod servers), but I'm preparing a custom version of the extension for you to try so that we can figure out whether it has something to do with VS Code having additional bugs related to <code>tabGroups</code>, perhaps some which are affected by latency.</p>",
        "id": 447782845,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1719584062
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"246273\">@Bhavik Mehta</span> <br>\n<a href=\"/user_uploads/3121/v5j79OfZpNftfkiuplOfObr9/lean4-0.0.171.vsix\">lean4-0.0.171.vsix</a></p>\n<ol>\n<li>Go to a fresh Gitpod instance and open your desktop VS Code instance like you did in the video.</li>\n<li>\n<p>Navigate to the Extensions menu and select \"Install from VSIX\" and then \"Show local\"<br>\n<a href=\"/user_uploads/3121/lyWfFEOcBjbS9lesUV9DV6vQ/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/lyWfFEOcBjbS9lesUV9DV6vQ/image.png\" title=\"image.png\"><img src=\"/user_uploads/3121/lyWfFEOcBjbS9lesUV9DV6vQ/image.png\"></a></div></li>\n<li>\n<p>After installing the VSIX, when VS Code offers to reload the window, reload it.</p>\n</li>\n<li>\n<p>Confirm that the extension is installed by checking whether the version of the extension in the list of SSH extensions is 0.0.171 <br>\n<a href=\"/user_uploads/3121/l2ULVvavwn7b41xeDGYF85g1/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/l2ULVvavwn7b41xeDGYF85g1/image.png\" title=\"image.png\"><img src=\"/user_uploads/3121/l2ULVvavwn7b41xeDGYF85g1/image.png\"></a></div></li>\n<li>\n<p>See if you can still reproduce the issue with this extension version.</p>\n</li>\n</ol>\n<p>Since VS Code caches these VSIX files sometimes, it may be difficult to uninstall this Lean 4 extension version later, so you should ideally do this on a disposable Gitpod instance just to be safe.</p>\n<p>Thanks for your patience.</p>",
        "id": 447789831,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1719585522
    },
    {
        "content": "<p>This does indeed seem to fix it on gitpod - I haven't tried locally because of the vsix cache issue you mentioned!</p>",
        "id": 447798155,
        "sender_full_name": "Bhavik Mehta",
        "timestamp": 1719587768
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"246273\">Bhavik Mehta</span> <a href=\"#narrow/stream/270676-lean4/topic/Server.20crashes.20on.20new.20file/near/447798155\">said</a>:</p>\n<blockquote>\n<p>This does indeed seem to fix it on gitpod - I haven't tried locally because of the vsix cache issue you mentioned!</p>\n</blockquote>\n<p>That's great to hear, even though this confirms that VS Code's tab API is practically broken (and to be honest, I still don't understand how it manages to be broken in such a non-deterministic manner). Since the current state of the discussion at <a href=\"https://github.com/microsoft/vscode-languageserver-node/issues/848#issuecomment-2185043021\">vscode-languageserver-node#848</a> seems to be that the tab API being broken is intended behavior, I don't think this will change soon, either.</p>\n<p>I think we may just need to take the potential performance hit that the language server will occasionally start processing invisible files in the background when using Ctrl+Hover and add some additional debouncing for the language server in future Lean versions so that this is less likely to occur from that point onwards. I'll release the fix on Monday after <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> has confirmed that it also reliably fixes the issue on their setup.</p>",
        "id": 447800477,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1719588361
    },
    {
        "content": "<p>Sorry for the slow confirmation, but yes, this also fixes it for me in gitpod!</p>",
        "id": 448223298,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719810668
    },
    {
        "content": "<p>The fix for both of the issues reported above has now been released as part of 0.0.171.</p>",
        "id": 448282226,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1719828237
    }
]