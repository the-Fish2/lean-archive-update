[
    {
        "content": "<p>It probably doesn't need to be a monad since it works pretty well as-is. However, I wonder if there is a reason why it shouldn't be a monad.</p>\n<p>I noticed when I tried to write <code>def foo : Thunk α := do ...</code> but I realized that I needed to write <code>def foo : Thunk α := Id.run do ...</code> and rely on the coercion from <code>α</code> to <code>Thunk α</code>.</p>",
        "id": 321669870,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1673883513
    },
    {
        "content": "<p>Of course it \"is\" a monad since there are <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Thunk.pure#doc\">docs4#Thunk.pure</a> <a href=\"https://leanprover-community.github.io/mathlib4_docs/find/?pattern=Thunk.bind#doc\">docs4#Thunk.bind</a> (to be pedantic/annoying), but I'm also wondering if there's any reason there shouldn't be a <code>Monad</code> instance.</p>\n<p>Relying on the coercion feels weird since it obscures when computations are happening.</p>",
        "id": 321671227,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1673883945
    },
    {
        "content": "<p>I just checked that this works:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">Monad</span> <span class=\"n\">Thunk</span> <span class=\"n\">where</span>\n  <span class=\"n\">pure</span> <span class=\"o\">:=</span> <span class=\"n\">Thunk.pure</span>\n  <span class=\"n\">bind</span> <span class=\"o\">:=</span> <span class=\"n\">Thunk.bind</span>\n  <span class=\"n\">map</span>  <span class=\"o\">:=</span> <span class=\"n\">Thunk.map</span>\n\n<span class=\"kd\">instance</span> <span class=\"o\">:</span> <span class=\"n\">LawfulMonad</span> <span class=\"n\">Thunk</span> <span class=\"n\">where</span>\n  <span class=\"n\">map_const</span>      <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">intros</span><span class=\"bp\">;</span> <span class=\"n\">rfl</span>\n  <span class=\"n\">id_map</span>         <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">intros</span><span class=\"bp\">;</span> <span class=\"n\">rfl</span>\n  <span class=\"n\">bind_assoc</span>     <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">intros</span><span class=\"bp\">;</span> <span class=\"n\">rfl</span>\n  <span class=\"n\">bind_pure_comp</span> <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">intros</span><span class=\"bp\">;</span> <span class=\"n\">rfl</span>\n  <span class=\"n\">bind_map</span>       <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">intros</span><span class=\"bp\">;</span> <span class=\"n\">rfl</span>\n  <span class=\"n\">pure_bind</span>      <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">intros</span><span class=\"bp\">;</span> <span class=\"n\">rfl</span>\n  <span class=\"n\">pure_seq</span>       <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">intros</span><span class=\"bp\">;</span> <span class=\"n\">rfl</span>\n  <span class=\"n\">seqLeft_eq</span>     <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">intros</span><span class=\"bp\">;</span> <span class=\"n\">rfl</span>\n  <span class=\"n\">seqRight_eq</span>    <span class=\"o\">:=</span> <span class=\"kd\">by</span> <span class=\"n\">intros</span><span class=\"bp\">;</span> <span class=\"n\">rfl</span>\n</code></pre></div>\n<p>So it really is a monad. There could still be issues related to the special support for <code>Thunk</code> in runtime which would make it ill-behaved.</p>",
        "id": 321679229,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1673886483
    },
    {
        "content": "<p>The compiler does not currently know anything about eliminating <code>Thunk.pure _ &gt;&gt;= _</code>. Which to be fair is mostly an issue if you then go on to define <code>ThunkT</code> and get implicit <code>Thunk.pure</code>s from monad lifting everywhere.</p>",
        "id": 321680164,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1673886828
    },
    {
        "content": "<p>We could easily add that as a rewrite rule for the new compiler <span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span></p>",
        "id": 321692660,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1673891582
    },
    {
        "content": "<p>So it would be mostly harmless and potentially useful to add.  I made a quick PR to add it in Std.</p>",
        "id": 321698433,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1673893964
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119741\">@François G. Dorais</span> I just re-did the exact same thing: <code>Monad</code> and <code>LawfulMonad</code> instances for <code>Thunk</code>. I'm not sure about what happened to your PR, I can't find a <code>Monad Thunk</code> instance anywhere (core/std/mathlib)</p>",
        "id": 424030359,
        "sender_full_name": "Adrien Champion",
        "timestamp": 1709216810
    },
    {
        "content": "<p>Is std still interested in a PR on this? I don't mind opening the PR</p>",
        "id": 424030391,
        "sender_full_name": "Adrien Champion",
        "timestamp": 1709216818
    },
    {
        "content": "<p>Also, as far as I can tell std mentions <code>Thunk</code> exactly thrice</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Std/Data/MLList/Basic.lean\n41:  | thunk : Thunk (MLListImpl m α) → MLListImpl m α\n\nStd/Tactic/Omega/Core.lean\n310:  explanation? : Thunk String := \"\"\n352:        explanation? := Thunk.mk fun _ =&gt; j.toString\n</code></pre></div>\n<p>Wouldn't it make more sense to have the <code>Monad</code> instance in core?</p>",
        "id": 424030943,
        "sender_full_name": "Adrien Champion",
        "timestamp": 1709216964
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"380302\">@Adrien Champion</span> <a href=\"https://github.com/leanprover/std4/pull/88\">std4#88</a> suffered from bit rot so it was closed. I think it's better off in core since it needs compiler support to be useful.</p>",
        "id": 424342819,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1709336173
    },
    {
        "content": "<p>I'm not clear on what you mean by \"compiler support\". I can open a similar PR to yours on core easily, but if I have to fiddle with internals for \"compiler support\" that's another story, would probably need some mentoring at least</p>",
        "id": 424519395,
        "sender_full_name": "Adrien Champion",
        "timestamp": 1709481031
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119741\">François G. Dorais</span> <a href=\"#narrow/stream/270676-lean4/topic/Why.20isn't.20Thunk.20a.20Monad.3F/near/424342819\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"380302\">Adrien Champion</span> <a href=\"https://github.com/leanprover/std4/pull/88\">std4#88</a> suffered from bit rot so it was closed. I think it's better off in core since it needs compiler support to be useful.</p>\n</blockquote>\n<p>Since getting things into core requires quite a strong motivation, would it make sense to have it reside in Std or Mathlib in the meantime?</p>",
        "id": 424519794,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1709481378
    },
    {
        "content": "<p>The compiler issue was described by <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span>  in this thread. <span class=\"user-mention\" data-user-id=\"395550\">@Henrik Böving</span> showed this will be easy to fix in the new compiler. I think the issue is that parts of the old compiler are basically frozen, so pure-bind elimination for <code>Thunk</code> will probably only happen in the new compiler.</p>",
        "id": 424545851,
        "sender_full_name": "François G. Dorais",
        "timestamp": 1709502270
    }
]