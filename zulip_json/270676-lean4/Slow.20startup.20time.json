[
    {
        "content": "<p>Lean is very slow to start, I believe especially on Windows.</p>\n<p>I just timed it and it can take 49 seconds to start Lean in a file with no imports (after 48 seconds the \"yellow bars\" appear). <br>\nAfter Lean is running, it can take 97 seconds to import Mathlib. <br>\nAs an example, I recorded a low-quality video of me waiting for Lean and the import on my laptop (there's nothing to see other than me waiting).<br>\n<a href=\"/user_uploads/3121/Cd3V9OtnH0Fc2_4NxZNM_sTs/2024-03-01-19-25-21.mkv\">2024-03-01-19-25-21.mkv</a></p>\n<p>On some students' laptops the performance is worse, and it's quite frustrating.<br>\nIt would be great if the startup time of Lean can be improved.</p>",
        "id": 424310774,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1709320448
    },
    {
        "content": "<p>There is a known regression in Lean 4.6.0 that is meant to be fixed in the next version.</p>",
        "id": 424319234,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1709324071
    },
    {
        "content": "<p>See <a href=\"https://github.com/leanprover/lean4/pull/3552\">https://github.com/leanprover/lean4/pull/3552</a></p>",
        "id": 424319345,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1709324135
    },
    {
        "content": "<p>But the timing you report are a lot more extreme than what I saw. On my computer I got 15 seconds before the yellow bars.</p>",
        "id": 424319464,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1709324187
    },
    {
        "content": "<p>Could you try with the fix?</p>",
        "id": 424319519,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1709324219
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> if this commit indeed fixes the issue, do you think we should have a version 4.6.1?</p>",
        "id": 424319619,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1709324280
    },
    {
        "content": "<p>Yes, loading Lean on <code>4.7.0-nightly-2024-03-01</code> is about 3x as fast for me. That is a huge improvement! Great!</p>\n<p>I hope that more improvements can be found though, since the issue of Lean starting slow for me and my students has already existed for many months.</p>",
        "id": 424332038,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1709330255
    },
    {
        "content": "<p>Yes this is clearly a regression compared to Lean 3. It doesnâ€™t matter too much when expert users use Lean on brand new machines that were bought for that specific purpose. But students tend to have really crappy machines (unsurprisingly).</p>",
        "id": 424334154,
        "sender_full_name": "Patrick Massot",
        "timestamp": 1709331289
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"111080\">Floris van Doorn</span> <a href=\"#narrow/stream/270676-lean4/topic/Slow.20startup.20time/near/424332038\">said</a>:</p>\n<blockquote>\n<p>Yes, loading Lean on <code>4.7.0-nightly-2024-03-01</code> is about 3x as fast for me. That is a huge improvement! Great!</p>\n<p>I hope that more improvements can be found though, since the issue of Lean starting slow for me and my students has already existed for many months.</p>\n</blockquote>\n<p>The fix above is not in <code>nightly-2024-03-01</code> because it landed today.</p>",
        "id": 424341745,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1709335573
    },
    {
        "content": "<p>Interesting. I did notice that there was a huge variance in the starting time of Lean, I didn't guess it was this big :-)</p>",
        "id": 424346220,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1709338241
    },
    {
        "content": "<p>The OS filesystem cache likely plays a huge role when it comes to reading many small files like this</p>",
        "id": 424393631,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1709370045
    },
    {
        "content": "<p>For me, startup time is on the order of 10 seconds for the first file that I open in emacs. I'm puzzled as to why I don't observe a similar startup time when I do <code>lake build</code> from the command line.</p>",
        "id": 424423344,
        "sender_full_name": "David Renshaw",
        "timestamp": 1709395547
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"243791\">David Renshaw</span> <a href=\"#narrow/stream/270676-lean4/topic/Slow.20startup.20time/near/424423344\">said</a>:</p>\n<blockquote>\n<p>For me, startup time is on the order of 10 seconds for the first file that I open in emacs. I'm puzzled as to why I don't observe a similar startup time when I do <code>lake build</code> from the command line.</p>\n</blockquote>\n<p>Which Lean 4 version are you using?</p>",
        "id": 424423442,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1709395584
    },
    {
        "content": "<p>v4.6.0</p>",
        "id": 424423462,
        "sender_full_name": "David Renshaw",
        "timestamp": 1709395603
    },
    {
        "content": "<p>on Linux</p>",
        "id": 424423473,
        "sender_full_name": "David Renshaw",
        "timestamp": 1709395607
    },
    {
        "content": "<p>Try nightly-2024-03-02.</p>",
        "id": 424423483,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1709395620
    },
    {
        "content": "<p>ah, right. OK, I suppose I should wait for that to arrive.</p>",
        "id": 424423594,
        "sender_full_name": "David Renshaw",
        "timestamp": 1709395684
    },
    {
        "content": "<p>But even if it's a 3x improvement as reported above, I'm curious about what work <code>lake serve</code> is doing that <code>lake build</code> is not.</p>",
        "id": 424423614,
        "sender_full_name": "David Renshaw",
        "timestamp": 1709395708
    },
    {
        "content": "<p>is it just the infotrees?</p>",
        "id": 424423621,
        "sender_full_name": "David Renshaw",
        "timestamp": 1709395715
    },
    {
        "content": "<p>Ah, reading <a href=\"https://github.com/leanprover/lean4/pull/3552\">https://github.com/leanprover/lean4/pull/3552</a> now...</p>",
        "id": 424423774,
        "sender_full_name": "David Renshaw",
        "timestamp": 1709395825
    },
    {
        "content": "<p>As described above, Floris didn't actually test the fix.</p>",
        "id": 424423783,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1709395829
    },
    {
        "content": "<p>Oh, I missed that. And <a href=\"https://github.com/leanprover-community/mathlib4/pull/11070\">mathlib4#11070</a> is still on nightly-2024-02-29.</p>",
        "id": 424424298,
        "sender_full_name": "David Renshaw",
        "timestamp": 1709396350
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"243791\">@David Renshaw</span>: If you don't already have these customizations, they might help.</p>\n<div class=\"codehilite\" data-code-language=\"EmacsLisp\"><pre><span></span><code><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"p\">(</span><span class=\"nv\">lsp-enable-file-watchers</span><span class=\"w\"> </span><span class=\"no\">nil</span><span class=\"p\">)</span>\n<span class=\"w\"> </span><span class=\"o\">'</span><span class=\"p\">(</span><span class=\"nv\">lsp-enable-imenu</span><span class=\"w\"> </span><span class=\"no\">nil</span><span class=\"p\">)</span>\n</code></pre></div>",
        "id": 424438766,
        "sender_full_name": "Richard Copley",
        "timestamp": 1709407622
    },
    {
        "content": "<p>Now on <code>4.7.0-nightly-2024-03-02</code>. The yellow bars in VSCode appear near-instantaneously! A file without imports is ready in ~1 second! This is amazing!</p>",
        "id": 424440143,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1709408576
    },
    {
        "content": "<p>I tried it a few times just to be sure.</p>",
        "id": 424440175,
        "sender_full_name": "Floris van Doorn",
        "timestamp": 1709408611
    }
]