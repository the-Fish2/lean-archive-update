[
    {
        "content": "<p>I'm setting up the repository for my undergrad course and I'm attempting to explain a command-line-free installation process. It all goes really smoothly until the very end, when I tell people to click on the upside-down A, then Open Project -&gt; Project: Download project, and then download the course repository. This procedure ends with the following message (I can't seem to cut and paste it, sorry for screenshot):</p>\n<p><a href=\"/user_uploads/3121/Zxu0RCY2JSqbTHECfQVCssFa/installfail.png\">installfail.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/Zxu0RCY2JSqbTHECfQVCssFa/installfail.png\" title=\"installfail.png\"><img src=\"/user_uploads/3121/Zxu0RCY2JSqbTHECfQVCssFa/installfail.png\"></a></div><p>What I am concerned about is that this message is completely misleading and inaccurate. Firstly it claims that that the message \"usually\" means something. I have seen this message personally loads of times and as far as I know it <em>never</em> means that (at least for me -- it means that that there's some mess with proofwidgets or something, that I don't understand). Secondly, the advice given to \"fix\" the problem is completely meaningless; I don't want my undergraduates pushing anything to anything, let alone to mathlib4 (at least on day 1 of the course!)</p>\n<p>Is this message likely to still be appearing in early January when the course starts? If so I'll just add a note in my local install docs telling the students to ignore it. I should say that in general the fact that I can get everything installed onto a students' computer with no command line is a <strong>huge</strong> improvement on what I had last year (although I am a bit hazy about what will happen if they don't have git installed...).</p>",
        "id": 409817544,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1703426686
    },
    {
        "content": "<p>Of course \"usually\" is dependent on your workflow, but I think it is actually correct for, say, regular mathlib contributors, this is not a porting thing nor anything to do with updating mathlib or proofwidgets etc. The scenario that it's talking about is when you are working on mathlib and make a change to a file somewhere in the middle of the import hierarchy and save it, then <code>lake exe cache get</code> and you only get results for 1/3 of mathlib because the rest of it has been invalidated by your change. So it suggests that you push your file to mathlib on a branch and then wait an hour for CI to finish, then run <code>lake exe cache get</code> and you will get the results of compilation on all the other files.</p>\n<p>This is probably not your workflow. In particular, it only applies if you are working <em>on mathlib</em> and making modifications that can affect the validity of the cache files themselves. One easy thing we can do to detect that this message is misplaced is to ask whether we are currently running <code>cache</code> in mathlib or in a dependency (we already need to know this for other reasons), and only give the above message when in mathlib.</p>",
        "id": 409818395,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703427568
    },
    {
        "content": "<p>I would be curious to know what the scenario <em>actually</em> is under which you get that message though. Why would some files not be in the cache if you just pulled mathlib master or really any mathlib commit which has already been processed?</p>",
        "id": 409818564,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703427725
    },
    {
        "content": "<p>(By the way, in case it wasn't clear, this isn't actually a vscode-lean4 message, it's just regurgitating what <code>lake exe cache get</code> said on the command line. You get exactly the same message if you run the command from the CLI instead.)</p>",
        "id": 409818716,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703427881
    },
    {
        "content": "<p>My course repo is currently private and not ready, but I bumped it to mathlib master to see if this fixed the problem, and it didn't. <br>\nThe output is this:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>&gt; git clone https://github.com/ImperialCollegeLondon/formalising-mathematics-2024 /home/buzzard/crap/fm3\nCloning into '/home/buzzard/crap/fm3'...\n/home/buzzard/crap/fm3&gt; lake exe cache get\ninfo: mathlib: cloning https://github.com/leanprover-community/mathlib4.git to './.lake/packages/mathlib'\ninfo: std: cloning https://github.com/leanprover/std4 to './.lake/packages/std'\ninfo: Qq: cloning https://github.com/leanprover-community/quote4 to './.lake/packages/Qq'\ninfo: aesop: cloning https://github.com/leanprover-community/aesop to './.lake/packages/aesop'\ninfo: Cli: cloning https://github.com/leanprover/lean4-cli to './.lake/packages/Cli'\ninfo: proofwidgets: cloning https://github.com/leanprover-community/ProofWidgets4 to './.lake/packages/proofwidgets'\ninfo: [0/9] Fetching proofwidgets cloud release\ninfo: [1/9] Building Cache.IO\ninfo: [2/9] Compiling Cache.IO\ninfo: [2/9] Building Cache.Hashing\ninfo: [3/9] Compiling Cache.Hashing\ninfo: [3/9] Building Cache.Requests\ninfo: [6/9] Compiling Cache.Requests\ninfo: [6/9] Building Cache.Main\ninfo: [7/9] Compiling Cache.Main\ninfo: [9/9] Linking cache\nAttempting to download 9 file(s)\n\nDownloaded: 0 file(s) [attempted 1/9 = 11%]\n\nDownloaded: 0 file(s) [attempted 9/9 = 100%] (0% success)\nWarning: some files were not found in the cache.\nThis usually means that your local checkout of mathlib4 has diverged from upstream.\nIf you push your commits to a branch of the mathlib4 repository, CI will build the oleans and they will be available later.\nDecompressing 3919 file(s)\nunpacked in 10346 ms\n</code></pre></div>",
        "id": 409818749,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1703427919
    },
    {
        "content": "<p>and now try <code>lake build</code>?</p>",
        "id": 409818761,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703427949
    },
    {
        "content": "<p>what are the 9 files</p>",
        "id": 409818767,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703427955
    },
    {
        "content": "<p>I'm guessing something about proofwidgets?</p>",
        "id": 409818808,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703427964
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>[2333/3871] Building ProofWidgets.Compat\n[3910/3927] Building ProofWidgets.Component.Basic\n[3911/3927] Building ProofWidgets.Data.Html\n[3911/3927] Building ProofWidgets.Component.MakeEditLink\n[3911/3927] Building ProofWidgets.Component.Panel.Basic\n[3914/3927] Building ProofWidgets.Component.OfRpcMethod\n[3914/3927] Building ProofWidgets.Component.PenroseDiagram\n[3914/3927] Building ProofWidgets.Presentation.Expr\n[3922/3927] Building ProofWidgets.Component.Panel.SelectionPanel\n[3926/3927] Building FormalisingMathematics2024\n</code></pre></div>",
        "id": 409818839,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1703428019
    },
    {
        "content": "<p>try <code>lake exe cache get!</code> and see if that helps</p>",
        "id": 409818864,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703428041
    },
    {
        "content": "<p>We're still working out some distribution issues that happen after a mathlib update if <code>ProofWidgets</code> has not updated yet. That's why the issue seems to recur every month. I think they have been fixed now but because the issue results in bad cache files with the right cache keys you have to run <code>lake exe cache get!</code> to forcibly overwrite them if you pulled during the bad period</p>",
        "id": 409819062,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703428210
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/obscure.20message.20produced.20by.20lean4.20extension/near/409818864\">said</a>:</p>\n<blockquote>\n<p>try <code>lake exe cache get!</code> and see if that helps</p>\n</blockquote>\n<p>Nope:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>buzzard@buster:~/crap/fm5$ lake exe cache get!\nAttempting to download 3928 file(s)\nDownloaded: 3919 file(s) [attempted 3928/3928 = 100%] (99% success)\nWarning: some files were not found in the cache.\nThis usually means that your local checkout of mathlib4 has diverged from upstream.\nIf you push your commits to a branch of the mathlib4 repository, CI will build the oleans and they will be available later.\nDecompressing 3919 file(s)\nunpacked in 15462 ms\n</code></pre></div>",
        "id": 409819200,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1703428376
    },
    {
        "content": "<p>Having said that,</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>buzzard@buster:~/crap/fm5$ lake build\n[1/2] Building FormalisingMathematics2024\n</code></pre></div>\n<p>works fine</p>",
        "id": 409819238,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1703428432
    },
    {
        "content": "<p>are you not on master? I tried pulling just now and I got 4053 files, not 3928</p>",
        "id": 409819330,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703428510
    },
    {
        "content": "<p>The following is a subset of my <code>lake-manifest.json</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code>  <span class=\"o\">{</span><span class=\"s2\">\"url\"</span><span class=\"o\">:</span> <span class=\"s2\">\"https://github.com/leanprover-community/mathlib4.git\"</span><span class=\"o\">,</span>\n   <span class=\"s2\">\"type\"</span><span class=\"o\">:</span> <span class=\"s2\">\"git\"</span><span class=\"o\">,</span>\n   <span class=\"s2\">\"subDir\"</span><span class=\"o\">:</span> <span class=\"n\">null</span><span class=\"o\">,</span>\n   <span class=\"s2\">\"rev\"</span><span class=\"o\">:</span> <span class=\"s2\">\"92bfd3b2326aa002705452daf19026ecf3a30ead\"</span><span class=\"o\">,</span>\n   <span class=\"s2\">\"name\"</span><span class=\"o\">:</span> <span class=\"s2\">\"mathlib\"</span><span class=\"o\">,</span>\n   <span class=\"s2\">\"manifestFile\"</span><span class=\"o\">:</span> <span class=\"s2\">\"lake-manifest.json\"</span><span class=\"o\">,</span>\n   <span class=\"s2\">\"inputRev\"</span><span class=\"o\">:</span> <span class=\"n\">null</span><span class=\"o\">,</span>\n   <span class=\"s2\">\"inherited\"</span><span class=\"o\">:</span> <span class=\"n\">false</span><span class=\"o\">,</span>\n   <span class=\"s2\">\"configFile\"</span><span class=\"o\">:</span> <span class=\"s2\">\"lakefile.lean\"</span><span class=\"o\">}</span>\n</code></pre></div>",
        "id": 409819423,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1703428592
    },
    {
        "content": "<p>My guess regarding \"works fine\" is that the 9 files that failed to be downloaded in your last command were left in their original state, which since you ran <code>lake build</code> are actually up to date</p>",
        "id": 409819474,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703428652
    },
    {
        "content": "<p>Oh what the heck, that's from November? I followed the instructions on the mathlib repo? Maybe this is my fault after all?</p>",
        "id": 409819484,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1703428662
    },
    {
        "content": "<p>oh maybe you haven't run <code>lake update</code>?</p>",
        "id": 409819500,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703428680
    },
    {
        "content": "<p>I thought I did what it said <a href=\"https://github.com/leanprover-community/mathlib4/wiki/Using-mathlib4-as-a-dependency\">here</a> -- hang on.</p>",
        "id": 409819573,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1703428716
    },
    {
        "content": "<p>so your lakefile has something like <code>require mathlib from \".../mathlib4.git\"</code></p>",
        "id": 409819609,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703428752
    },
    {
        "content": "<p>yeah, I updated mathlib but didn't push <span aria-label=\"face palm\" class=\"emoji emoji-1f926\" role=\"img\" title=\"face palm\">:face_palm:</span> . Let me run the test again...</p>",
        "id": 409819629,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1703428786
    },
    {
        "content": "<p>or maybe <code>@ \"master\"</code> at the end</p>",
        "id": 409819630,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703428786
    },
    {
        "content": "<p>or did you put <code>@ \"&lt;commit SHA&gt;\"</code> in the lakefile?</p>",
        "id": 409819712,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703428849
    },
    {
        "content": "<p>the docs you linked don't say anything about setting the revision but people do that sometimes if they want to make sure <code>lake update</code> doesn't break the project</p>",
        "id": 409819766,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703428919
    },
    {
        "content": "<p>No this is entirely my fault -- I was getting the warning with November mathlib, I updated mathlib, failed to push, and then kept getting the warning when downloading a fresh copy of the repo. Sorry for wasting your time and well spotted about the number of files being wrong -- thanks a lot!</p>",
        "id": 409819886,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1703429029
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> has marked this topic as resolved.</p>",
        "id": 409819974,
        "sender_full_name": "Notification Bot",
        "timestamp": 1703429110
    },
    {
        "content": "<p>I think I will still change the error message for people in downstream projects though, you are right that the advice is misleading. I don't really know what to suggest instead though, maybe just \"something seems to be wrong with the cache infrastructure, maybe ask someone on Zulip\"?</p>",
        "id": 409820066,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703429205
    },
    {
        "content": "<p>I'm getting the same message <code>This usually means that your local checkout of mathlib4 has diverged from upstream.</code> but reading the conversation I  can quite figure out what the fix is. I guess I did something wrong, but I'm not sure what.</p>",
        "id": 410737463,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1704127208
    },
    {
        "content": "<p>The fix is for your branch to have fully compiled mathlib, aka a green tick in CI.</p>",
        "id": 410737894,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704127543
    },
    {
        "content": "<p>but I'm not on a branch, I'm getting this with mathlib4 (master)</p>",
        "id": 410738022,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1704127658
    },
    {
        "content": "<p>The fix is to become a cache wizard and fix the ProofWidgets caching issue.</p>",
        "id": 410738116,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704127730
    },
    {
        "content": "<p>...so just wait?</p>",
        "id": 410738289,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1704127887
    },
    {
        "content": "<p>Wait, when did you start getting this error?</p>",
        "id": 410738645,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704128180
    },
    {
        "content": "<p>Just today, I made made a new clone of mathlbi4  and when I try running <code>lake exe cache get</code> I get that message</p>",
        "id": 410738795,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1704128321
    },
    {
        "content": "<p>Hmm, I'm also not managing to download any cache today</p>",
        "id": 410738826,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704128360
    },
    {
        "content": "<p>This seems to be happening with <code>v4.5.0-rc1</code>. I tried with <code>v4.4.0-rc1</code> and it works fine.</p>",
        "id": 410738952,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1704128480
    },
    {
        "content": "<p>I think this is irrelevant to this topic. See <a href=\"#narrow/stream/113488-general/topic/The.20cache.20doesn't.20work\">https://leanprover.zulipchat.com/#narrow/stream/113488-general/topic/The.20cache.20doesn't.20work</a> instead.</p>",
        "id": 410738972,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704128512
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/113488-general/topic/.E2.9C.94.20obscure.20message.20produced.20by.20lean4.20extension/near/409817544\">said</a>:</p>\n<blockquote>\n<p>I can't seem to cut and paste it, sorry for screenshot</p>\n</blockquote>\n<p>By the way, you can open the output by clicking the '(Details)' link and copy+paste from there.</p>",
        "id": 411694644,
        "sender_full_name": "Marc Huisinga",
        "timestamp": 1704704397
    }
]