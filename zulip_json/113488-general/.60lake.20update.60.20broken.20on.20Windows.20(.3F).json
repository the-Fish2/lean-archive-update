[
    {
        "content": "<p>When <code>lake upgrade</code> is used to perform an upgrade (as opposed to installing from scratch), it fails due to assuming the wrong path separator:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">&gt;</span> <span class=\"n\">lake</span> <span class=\"n\">update</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">category</span><span class=\"o\">:</span> <span class=\"n\">could</span> <span class=\"n\">not</span> <span class=\"n\">rename</span> <span class=\"n\">packages</span> <span class=\"n\">directory</span> <span class=\"o\">(</span><span class=\"bp\">.\\.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span> <span class=\"bp\">-&gt;</span> <span class=\"bp\">.\\.</span><span class=\"n\">lake</span><span class=\"bp\">\\</span><span class=\"n\">packages</span><span class=\"o\">):</span> <span class=\"n\">no</span> <span class=\"n\">error</span> <span class=\"o\">(</span><span class=\"n\">error</span> <span class=\"n\">code</span><span class=\"o\">:</span> <span class=\"mi\">0</span><span class=\"o\">)</span>\n</code></pre></div>\n<p>I can pretty easily work around this by deleting the <code>.lake</code> folder and installing from scratch, in which case it doesn't seem bothered, but as it seems to need to recompile a large chunk of Mathlib every time I do this (I don't seem to be getting the precompiled exes) this is mildly annoying. </p>\n<p>I should probably make an issue on the lean4 github, but I thought I'd check and see if anyone else had the problem/knew something I'm doing wrong first.</p>",
        "id": 429126203,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1711236513
    },
    {
        "content": "<p>There's no such thing as <code>lake upgrade</code> as far as I know. Can you explain what you're trying to do? Are you trying to update a dependency for example? Is the dependency mathlib? If so, have you read <a href=\"https://github.com/leanprover-community/mathlib4/wiki/Using-mathlib4-as-a-dependency\">this</a>? And if you delete <code>.lake</code> then you should be able to get the precompiled mathlib exes back with <code>lake exe cache get</code>.</p>",
        "id": 429126250,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1711236593
    },
    {
        "content": "<p>Is this on windows or unix?</p>",
        "id": 429126764,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711237005
    },
    {
        "content": "<p>I meant <code>lake update</code>, yes. I was updating lean itself, actually, but then that broke <code>paperproof</code> (I think because it was expecting <code>Json.lean</code> to be in <code>Std</code> and it got moved to <code>Lean</code> itself?)</p>",
        "id": 429133852,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1711242801
    },
    {
        "content": "<p>so I had to run <code>lake update</code> to fix that, which is when I get the error</p>",
        "id": 429133856,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1711242818
    },
    {
        "content": "<p>this is on Windows</p>",
        "id": 429134167,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1711243109
    },
    {
        "content": "<p>I think the path separators are a distraction, windows is happy with either</p>",
        "id": 429134334,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711243239
    },
    {
        "content": "<p><code>no error (error code: 0)</code> is pretty weird though</p>",
        "id": 429134341,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711243245
    },
    {
        "content": "<p>I have run <code>lake exe cache get</code>; I think I'm misunderstanding something, because even afterwards it's saying it needs to build ~1937 files of mathlib</p>",
        "id": 429134356,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1711243261
    },
    {
        "content": "<p>currently about 1400 files in</p>",
        "id": 429134384,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1711243267
    },
    {
        "content": "<p>Regarding the error 0; I think there is perhaps a bug with <code>errno</code> in <a href=\"https://github.com/leanprover/lean4/blob/655ec964f5d6b0810ce0e517a6b3bbb3d5186d25/src/runtime/io.cpp#L797-L800\">these lines</a>, and it is not being read quickly enough.</p>",
        "id": 429134745,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711243421
    },
    {
        "content": "<p>mm<br>\nif I <code>mv Documents\\foo Documents/foo</code>, it doesn't complain in either direction, so I guess you're right</p>",
        "id": 429135097,
        "sender_full_name": "Robert Maxton",
        "timestamp": 1711243689
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/lean4/pull/3753\">lean4#3753</a> probably fixes the \"no error\" message</p>",
        "id": 429135394,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1711243934
    },
    {
        "content": "<p>That aside, it would be good to avoid this rename by normalizing the filepaths before comparing them (in <code>Workspace.updateAndMaterialize</code>). And <span class=\"user-mention\" data-user-id=\"359992\">@Robert Maxton</span>, you might need to ensure there are no <code>lake</code> and <code>lean</code> processes with open handles to files in the package directory, for example by closing the editor before running <code>lake update</code> and/or <code>lake exe cache unpack</code>.</p>",
        "id": 429142048,
        "sender_full_name": "Richard Copley",
        "timestamp": 1711248760
    },
    {
        "content": "<p>I'm experiencing this error also (and I believe it was previously also reported at <a href=\"https://github.com/leanprover/lean4/issues/3502\">https://github.com/leanprover/lean4/issues/3502</a> ).  Is there a known workaround, or should I just wait for the next patch?  EDIT: restarting my computer helped (I guess by closing all active lake/lean processes)</p>",
        "id": 429143831,
        "sender_full_name": "Terence Tao",
        "timestamp": 1711250175
    }
]