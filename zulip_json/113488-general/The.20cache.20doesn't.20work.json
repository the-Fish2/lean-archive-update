[
    {
        "content": "<p>The cache for mathlib is currently not working. I thought this was an error that was recently fixed, but the cache on master doesn't work right now (on Ubuntu).</p>",
        "id": 409580845,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703250719
    },
    {
        "content": "<p>Did you try <code>lake exe cache get!</code>?</p>",
        "id": 409581762,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1703251134
    },
    {
        "content": "<p>Ah no! Let me try</p>",
        "id": 409581874,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703251186
    },
    {
        "content": "<p>I confirm: it does not work with <code>lake exe cache get!</code></p>",
        "id": 409582617,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703251475
    },
    {
        "content": "<p>what is the first file that is recompiled?</p>",
        "id": 409582898,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703251625
    },
    {
        "content": "<p>and assuming it is <code>ProofWidgets.Compat</code>, what is the result of <code>lake exe cache lookup ProofWidgets.Compat</code></p>",
        "id": 409582986,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703251669
    },
    {
        "content": "<p>It's too fast for me to read, but it's <code>[1/...]</code> so I assume everything gets recompiled.</p>",
        "id": 409583005,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703251678
    },
    {
        "content": "<p>oh that's new</p>",
        "id": 409583066,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703251691
    },
    {
        "content": "<p>just pipe it to a log</p>",
        "id": 409583096,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703251706
    },
    {
        "content": "<p>I am trying to nuke <code>lake-packages</code> just to see whether it's not my install being botched.</p>",
        "id": 409583129,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703251725
    },
    {
        "content": "<p>hold on a bit, I want to diagnose the issue for others</p>",
        "id": 409583159,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703251746
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/The.20cache.20doesn't.20work/near/409583096\">said</a>:</p>\n<blockquote>\n<p>just pipe it to a log</p>\n</blockquote>\n<p>How does one do that? <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 409583172,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703251755
    },
    {
        "content": "<p><code>lake exe cache get</code> does what</p>",
        "id": 409583184,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703251762
    },
    {
        "content": "<p>Don't worry, the issue is still here after nuking</p>",
        "id": 409583202,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703251771
    },
    {
        "content": "<p>OS?</p>",
        "id": 409583210,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703251779
    },
    {
        "content": "<p>Gitpod, so Ubuntu</p>",
        "id": 409583233,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703251796
    },
    {
        "content": "<p>and what is the master commit</p>",
        "id": 409583298,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703251810
    },
    {
        "content": "<p>The latest: <a href=\"https://github.com/leanprover-community/mathlib4/commit/98067b25fcb5c00c13b4ac74ab781e2ef6689812\">https://github.com/leanprover-community/mathlib4/commit/98067b25fcb5c00c13b4ac74ab781e2ef6689812</a></p>",
        "id": 409583382,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703251860
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">$</span> <span class=\"n\">lake</span> <span class=\"n\">exe</span> <span class=\"n\">cache</span> <span class=\"n\">get</span>\n<span class=\"n\">Attempting</span> <span class=\"n\">to</span> <span class=\"n\">download</span> <span class=\"mi\">264</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">Downloaded</span><span class=\"o\">:</span> <span class=\"mi\">264</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">attempted</span> <span class=\"mi\">264</span><span class=\"bp\">/</span><span class=\"mi\">264</span> <span class=\"bp\">=</span> <span class=\"mi\">100</span><span class=\"bp\">%</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">100</span><span class=\"bp\">%</span> <span class=\"n\">success</span><span class=\"o\">)</span>\n<span class=\"n\">Decompressing</span> <span class=\"mi\">4050</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">unpacked</span> <span class=\"k\">in</span> <span class=\"mi\">6518</span> <span class=\"n\">ms</span>\n</code></pre></div>",
        "id": 409583424,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703251878
    },
    {
        "content": "<p>and then <code>lake build | head -20</code></p>",
        "id": 409583464,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703251896
    },
    {
        "content": "<p>you don't need to let it finish, I just want to see what it starts with</p>",
        "id": 409583620,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703251973
    },
    {
        "content": "<p><code>lake build | head -20</code> finishes instantly</p>",
        "id": 409583745,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703252043
    },
    {
        "content": "<p>what does it print</p>",
        "id": 409583781,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252049
    },
    {
        "content": "<p>Nothing</p>",
        "id": 409583793,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703252056
    },
    {
        "content": "<p>nothing?</p>",
        "id": 409583795,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252056
    },
    {
        "content": "<p>in that case it worked...?</p>",
        "id": 409583805,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252065
    },
    {
        "content": "<p>try <code>lake build</code></p>",
        "id": 409583823,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252074
    },
    {
        "content": "<p>I wonder whether it's not the server that somehow didn't restart between switching branches</p>",
        "id": 409583831,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703252077
    },
    {
        "content": "<p>Ahah, I restarted the server and now I get a new error:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">failed</span> <span class=\"n\">to</span> <span class=\"n\">read</span> <span class=\"n\">file</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Lean</span><span class=\"bp\">/</span><span class=\"n\">Exception.olean'</span><span class=\"o\">,</span> <span class=\"n\">invalid</span> <span class=\"n\">header</span>\n</code></pre></div>",
        "id": 409583909,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703252127
    },
    {
        "content": "<p>either the server or the console is using the wrong version</p>",
        "id": 409584065,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252201
    },
    {
        "content": "<p>maybe try restarting again?</p>",
        "id": 409584081,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252209
    },
    {
        "content": "<p>Can you run <code>#eval Lean.versionString</code> in the server in a file with no imports?</p>",
        "id": 409584283,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252293
    },
    {
        "content": "<p>and <code>lean --version</code> on the console</p>",
        "id": 409584312,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252314
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"k\">#eval</span> <span class=\"n\">Lean.versionString</span> <span class=\"c1\">-- \"4.5.0-rc1\"</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">gitpod</span> <span class=\"bp\">/</span><span class=\"n\">workspace</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"o\">(</span><span class=\"n\">master</span><span class=\"o\">)</span> <span class=\"bp\">$</span> <span class=\"n\">lean</span> <span class=\"c1\">--version</span>\n<span class=\"n\">Lean</span> <span class=\"o\">(</span><span class=\"n\">version</span> <span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">5</span><span class=\"bp\">.</span><span class=\"mi\">0</span><span class=\"bp\">-</span><span class=\"n\">rc1</span><span class=\"o\">,</span> <span class=\"n\">commit</span> <span class=\"n\">b614ff1d12bc</span><span class=\"o\">,</span> <span class=\"n\">Release</span><span class=\"o\">)</span>\n</code></pre></div>",
        "id": 409584572,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703252430
    },
    {
        "content": "<p>and <code>lake exe cache lookup Mathlib/Lean/Exception.lean</code></p>",
        "id": 409584648,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252481
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Lean</span><span class=\"bp\">/</span><span class=\"n\">Exception.lean</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">gitpod</span><span class=\"bp\">/.</span><span class=\"n\">cache</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/</span><span class=\"n\">ed8fc46412d2d359.ltar</span>\n  <span class=\"n\">comment</span><span class=\"o\">:</span> <span class=\"n\">git</span><span class=\"bp\">=</span><span class=\"n\">mathlib4</span><span class=\"bp\">@</span><span class=\"mi\">3</span><span class=\"n\">fc009bb61c66914059e00af4c7c3ab08badfa78</span>\n</code></pre></div>",
        "id": 409584696,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703252514
    },
    {
        "content": "<p>do you have <code>xxd</code>?</p>",
        "id": 409584764,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252532
    },
    {
        "content": "<p>unfortunately it doesn't print the actual lean commit but we can squint at the result of <code>xxd .lake/build/lib/Mathlib/Lean/Exception.olean | head -5</code></p>",
        "id": 409584868,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252591
    },
    {
        "content": "<p>No idea. I used the standard gitpod configuration from the mathlib4 repo.</p>",
        "id": 409584889,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703252604
    },
    {
        "content": "<p>well I already know the answer, that olean was in fact compiled on <code>4.5.0-rc1</code></p>",
        "id": 409585064,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252696
    },
    {
        "content": "<p>but <code>import Mathlib.Lean.Exception</code> still fails?</p>",
        "id": 409585110,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252718
    },
    {
        "content": "<p>Indeed, with the same error as previously</p>",
        "id": 409585223,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703252766
    },
    {
        "content": "<p>very strange</p>",
        "id": 409585243,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252784
    },
    {
        "content": "<p><code>#eval Lean.githash</code>?</p>",
        "id": 409585255,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252791
    },
    {
        "content": "<p>for the record this is what the xxd invocation looks like for me, and I'm expecting it to be the same for you</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">$</span> <span class=\"n\">xxd</span> <span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Lean</span><span class=\"bp\">/</span><span class=\"n\">Exception.olean</span> <span class=\"bp\">|</span> <span class=\"n\">head</span> <span class=\"bp\">-</span><span class=\"mi\">5</span>\n<span class=\"mi\">00000000</span><span class=\"o\">:</span> <span class=\"mi\">6</span><span class=\"n\">f6c</span> <span class=\"mi\">6561</span> <span class=\"mi\">6</span><span class=\"n\">e01</span> <span class=\"mi\">6236</span> <span class=\"mi\">3134</span> <span class=\"mi\">6666</span> <span class=\"mi\">3164</span> <span class=\"mi\">3132</span>  <span class=\"n\">olean.b614ff1d12</span>\n<span class=\"mi\">00000010</span><span class=\"o\">:</span> <span class=\"mi\">6263</span> <span class=\"mi\">3338</span> <span class=\"mi\">6633</span> <span class=\"mi\">3930</span> <span class=\"mi\">3737</span> <span class=\"mi\">6639</span> <span class=\"mi\">6365</span> <span class=\"mi\">3966</span>  <span class=\"n\">bc38f39077f9ce9f</span>\n<span class=\"mi\">00000020</span><span class=\"o\">:</span> <span class=\"mi\">3264</span> <span class=\"mi\">3438</span> <span class=\"mi\">6234</span> <span class=\"mi\">3263</span> <span class=\"mi\">3030</span> <span class=\"mi\">3361</span> <span class=\"mi\">6430</span> <span class=\"mi\">0000</span>  <span class=\"mi\">2</span><span class=\"n\">d48b42c003ad0..</span>\n<span class=\"mi\">00000030</span><span class=\"o\">:</span> <span class=\"mi\">0000</span> <span class=\"mi\">7880</span> <span class=\"n\">c74a</span> <span class=\"mi\">0000</span> <span class=\"mi\">18</span><span class=\"n\">c8</span> <span class=\"mi\">7880</span> <span class=\"n\">c74a</span> <span class=\"mi\">0000</span>  <span class=\"bp\">..</span><span class=\"n\">x..J....x..J..</span>\n<span class=\"mi\">00000040</span><span class=\"o\">:</span> <span class=\"mi\">0000</span> <span class=\"mi\">0000</span> <span class=\"mi\">0100</span> <span class=\"mi\">00</span><span class=\"n\">f9</span> <span class=\"mi\">0500</span> <span class=\"mi\">0000</span> <span class=\"mi\">0000</span> <span class=\"mi\">0000</span>  <span class=\"bp\">................</span>\n</code></pre></div>",
        "id": 409585319,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252824
    },
    {
        "content": "<p><code>b614ff1d12bc38f39077f9ce9f2d48b42c003ad0</code></p>",
        "id": 409585331,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703252831
    },
    {
        "content": "<p>and you can see that exact number written in the file I just posted</p>",
        "id": 409585389,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252868
    },
    {
        "content": "<p>what about <code>lake env lean Test.lean</code> where <code>Test.lean</code> has any mathlib imports</p>",
        "id": 409585507,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703252919
    },
    {
        "content": "<p>No output for <code>Test.lean</code> containing</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Mathlib.Order.Basic</span>\n</code></pre></div>",
        "id": 409585751,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703253060
    },
    {
        "content": "<p>The import works though. Let me try again with a later file.</p>",
        "id": 409585798,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703253091
    },
    {
        "content": "<p>With</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Mathlib.RingTheory.Artinian</span>\n</code></pre></div>\n<p>I get</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">gitpod</span> <span class=\"bp\">/</span><span class=\"n\">workspace</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"o\">(</span><span class=\"n\">master</span><span class=\"o\">)</span> <span class=\"bp\">$</span> <span class=\"n\">lake</span> <span class=\"n\">env</span> <span class=\"n\">lean</span> <span class=\"n\">Test.lean</span>\n<span class=\"n\">Test.lean</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">failed</span> <span class=\"n\">to</span> <span class=\"n\">read</span> <span class=\"n\">file</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Lean</span><span class=\"bp\">/</span><span class=\"n\">Exception.olean'</span><span class=\"o\">,</span> <span class=\"n\">invalid</span> <span class=\"n\">header</span>\n</code></pre></div>",
        "id": 409585996,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703253175
    },
    {
        "content": "<p>Oh so only some of the files are rejected?</p>",
        "id": 409586059,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703253209
    },
    {
        "content": "<p>if you import Mathlib.Lean.Exception does it work</p>",
        "id": 409586084,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703253221
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">gitpod</span> <span class=\"bp\">/</span><span class=\"n\">workspace</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"o\">(</span><span class=\"n\">master</span><span class=\"o\">)</span> <span class=\"bp\">$</span> <span class=\"n\">lake</span> <span class=\"n\">env</span> <span class=\"n\">lean</span> <span class=\"n\">Test.lean</span>\n<span class=\"n\">Test.lean</span><span class=\"o\">:</span><span class=\"mi\">1</span><span class=\"o\">:</span><span class=\"mi\">0</span><span class=\"o\">:</span> <span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">failed</span> <span class=\"n\">to</span> <span class=\"n\">read</span> <span class=\"n\">file</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Lean</span><span class=\"bp\">/</span><span class=\"n\">Exception.olean'</span><span class=\"o\">,</span> <span class=\"n\">invalid</span> <span class=\"n\">header</span>\n</code></pre></div>\n<p>again</p>",
        "id": 409586170,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703253247
    },
    {
        "content": "<p>you should try the <code>xxd</code> invocation after all</p>",
        "id": 409586192,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703253260
    },
    {
        "content": "<p>you may need to install it if you don't already have it</p>",
        "id": 409586217,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703253273
    },
    {
        "content": "<p><span aria-label=\"sweat\" class=\"emoji emoji-1f613\" role=\"img\" title=\"sweat\">:sweat:</span> </p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">gitpod</span> <span class=\"bp\">/</span><span class=\"n\">workspace</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"o\">(</span><span class=\"n\">master</span><span class=\"o\">)</span> <span class=\"bp\">$</span> <span class=\"n\">sudo</span> <span class=\"n\">apt</span> <span class=\"n\">install</span> <span class=\"n\">xxd</span>\n<span class=\"n\">Reading</span> <span class=\"n\">package</span> <span class=\"n\">lists...</span> <span class=\"n\">Done</span>\n<span class=\"n\">Building</span> <span class=\"n\">dependency</span> <span class=\"n\">tree...</span> <span class=\"n\">Done</span>\n<span class=\"n\">Reading</span> <span class=\"n\">state</span> <span class=\"n\">information...</span> <span class=\"n\">Done</span>\n<span class=\"n\">The</span> <span class=\"n\">following</span> <span class=\"n\">NEW</span> <span class=\"n\">packages</span> <span class=\"n\">will</span> <span class=\"n\">be</span> <span class=\"n\">installed</span><span class=\"o\">:</span>\n  <span class=\"n\">xxd</span>\n<span class=\"mi\">0</span> <span class=\"n\">upgraded</span><span class=\"o\">,</span> <span class=\"mi\">1</span> <span class=\"n\">newly</span> <span class=\"n\">installed</span><span class=\"o\">,</span> <span class=\"mi\">0</span> <span class=\"n\">to</span> <span class=\"n\">remove</span> <span class=\"n\">and</span> <span class=\"mi\">0</span> <span class=\"n\">not</span> <span class=\"n\">upgraded.</span>\n<span class=\"n\">Need</span> <span class=\"n\">to</span> <span class=\"n\">get</span> <span class=\"mi\">54</span><span class=\"bp\">.</span><span class=\"mi\">2</span> <span class=\"n\">kB</span> <span class=\"n\">of</span> <span class=\"n\">archives.</span>\n<span class=\"n\">After</span> <span class=\"n\">this</span> <span class=\"n\">operation</span><span class=\"o\">,</span> <span class=\"mi\">285</span> <span class=\"n\">kB</span> <span class=\"n\">of</span> <span class=\"n\">additional</span> <span class=\"n\">disk</span> <span class=\"n\">space</span> <span class=\"n\">will</span> <span class=\"n\">be</span> <span class=\"n\">used.</span>\n<span class=\"n\">Ign</span><span class=\"o\">:</span><span class=\"mi\">1</span> <span class=\"n\">http</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">archive.ubuntu.com</span><span class=\"bp\">/</span><span class=\"n\">ubuntu</span> <span class=\"n\">jammy</span><span class=\"bp\">-</span><span class=\"n\">updates</span><span class=\"bp\">/</span><span class=\"n\">main</span> <span class=\"n\">amd64</span> <span class=\"n\">xxd</span> <span class=\"n\">amd64</span> <span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"mi\">8</span><span class=\"bp\">.</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">3995</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"n\">ubuntu2.12</span>\n<span class=\"n\">Err</span><span class=\"o\">:</span><span class=\"mi\">1</span> <span class=\"n\">http</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">security.ubuntu.com</span><span class=\"bp\">/</span><span class=\"n\">ubuntu</span> <span class=\"n\">jammy</span><span class=\"bp\">-</span><span class=\"n\">updates</span><span class=\"bp\">/</span><span class=\"n\">main</span> <span class=\"n\">amd64</span> <span class=\"n\">xxd</span> <span class=\"n\">amd64</span> <span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"mi\">8</span><span class=\"bp\">.</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">3995</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"n\">ubuntu2.12</span>\n  <span class=\"mi\">404</span>  <span class=\"n\">Not</span> <span class=\"n\">Found</span> <span class=\"o\">[</span><span class=\"n\">IP</span><span class=\"o\">:</span> <span class=\"mi\">91</span><span class=\"bp\">.</span><span class=\"mi\">189</span><span class=\"bp\">.</span><span class=\"mi\">91</span><span class=\"bp\">.</span><span class=\"mi\">83</span> <span class=\"mi\">80</span><span class=\"o\">]</span>\n<span class=\"n\">E</span><span class=\"o\">:</span> <span class=\"n\">Failed</span> <span class=\"n\">to</span> <span class=\"n\">fetch</span> <span class=\"n\">http</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">security.ubuntu.com</span><span class=\"bp\">/</span><span class=\"n\">ubuntu</span><span class=\"bp\">/</span><span class=\"n\">pool</span><span class=\"bp\">/</span><span class=\"n\">main</span><span class=\"bp\">/</span><span class=\"n\">v</span><span class=\"bp\">/</span><span class=\"n\">vim</span><span class=\"bp\">/</span><span class=\"n\">xxd_8.2.3995</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"n\">ubuntu2.12_amd64.deb</span>  <span class=\"mi\">404</span>  <span class=\"n\">Not</span> <span class=\"n\">Found</span> <span class=\"o\">[</span><span class=\"n\">IP</span><span class=\"o\">:</span> <span class=\"mi\">91</span><span class=\"bp\">.</span><span class=\"mi\">189</span><span class=\"bp\">.</span><span class=\"mi\">91</span><span class=\"bp\">.</span><span class=\"mi\">83</span> <span class=\"mi\">80</span><span class=\"o\">]</span>\n<span class=\"n\">E</span><span class=\"o\">:</span> <span class=\"n\">Unable</span> <span class=\"n\">to</span> <span class=\"n\">fetch</span> <span class=\"n\">some</span> <span class=\"n\">archives</span><span class=\"o\">,</span> <span class=\"n\">maybe</span> <span class=\"n\">run</span> <span class=\"n\">apt</span><span class=\"bp\">-</span><span class=\"n\">get</span> <span class=\"n\">update</span> <span class=\"n\">or</span> <span class=\"n\">try</span> <span class=\"k\">with</span> <span class=\"c1\">--fix-missing?</span>\n</code></pre></div>",
        "id": 409586424,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703253368
    },
    {
        "content": "<p>what about <code>strings</code>, does this command exist?</p>",
        "id": 409586510,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703253402
    },
    {
        "content": "<p>We can kind of use it for the same purpose:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">$</span> <span class=\"n\">strings</span> <span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Lean</span><span class=\"bp\">/</span><span class=\"n\">Exception.olean</span> <span class=\"bp\">|</span> <span class=\"n\">head</span> <span class=\"bp\">-</span><span class=\"mi\">5</span>\n<span class=\"n\">olean</span>\n<span class=\"n\">b614ff1d12bc38f39077f9ce9f2d48b42c003ad0</span>\n<span class=\"n\">Init</span>\n<span class=\"n\">Lean</span>\n<span class=\"n\">successIfFail</span>\n</code></pre></div>",
        "id": 409586583,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703253434
    },
    {
        "content": "<p>Nope, don't have <code>strings</code></p>",
        "id": 409586599,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703253443
    },
    {
        "content": "<p>just open the file in a text editor :-)</p>",
        "id": 409586622,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1703253455
    },
    {
        "content": "<p>okay maybe just open the olean file in vscode</p>",
        "id": 409586623,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703253458
    },
    {
        "content": "<p>Where do I find it? I used to know, but things have moved recently.</p>",
        "id": 409587020,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703253613
    },
    {
        "content": "<p>I posted the path above</p>",
        "id": 409587047,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703253625
    },
    {
        "content": "<p><a href=\"/user_uploads/3121/kEqBukVVMLOBvJmp1_9nCFZ4/image.png\">I... don't have it?</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/3121/kEqBukVVMLOBvJmp1_9nCFZ4/image.png\" title=\"I... don't have it?\"><img src=\"/user_uploads/3121/kEqBukVVMLOBvJmp1_9nCFZ4/image.png\"></a></div>",
        "id": 409587506,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703253756
    },
    {
        "content": "<p>you should be able to just paste the path directly into the Ctrl-P menu</p>",
        "id": 409587670,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703253812
    },
    {
        "content": "<p>vscode hides it because it's gitignored and a binary file</p>",
        "id": 409587988,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703253930
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">olean</span><span class=\"bp\"></span><span class=\"n\">b0fe9d6cdca82723134d61f8fe23a8c674f308b7</span>\n</code></pre></div>",
        "id": 409588002,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703253934
    },
    {
        "content": "<p>is what my clipboard is willing to copy-paste</p>",
        "id": 409588029,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703253948
    },
    {
        "content": "<p>okay, that is definitely not the right hash</p>",
        "id": 409588053,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703253961
    },
    {
        "content": "<p>that is <code>v4.4.0</code></p>",
        "id": 409588168,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703254001
    },
    {
        "content": "<p>wait, but <code>lake exe cache lookup</code> said it was fine? Try <code>lake exe cache unpack!</code> and see if the number in the olean file changes</p>",
        "id": 409588282,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703254062
    },
    {
        "content": "<p>It did!</p>",
        "id": 409588488,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703254152
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/113488-general/topic/The.20cache.20doesn't.20work/near/409586424\">said</a>:</p>\n<blockquote>\n<p><span aria-label=\"sweat\" class=\"emoji emoji-1f613\" role=\"img\" title=\"sweat\">:sweat:</span> </p>\n<p><div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">gitpod</span> <span class=\"bp\">/</span><span class=\"n\">workspace</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"o\">(</span><span class=\"n\">master</span><span class=\"o\">)</span> <span class=\"bp\">$</span> <span class=\"n\">sudo</span> <span class=\"n\">apt</span> <span class=\"n\">install</span> <span class=\"n\">xxd</span>\n<span class=\"bp\">…</span>\n<span class=\"n\">E</span><span class=\"o\">:</span> <span class=\"n\">Unable</span> <span class=\"n\">to</span> <span class=\"n\">fetch</span> <span class=\"n\">some</span> <span class=\"n\">archives</span><span class=\"o\">,</span> <span class=\"n\">maybe</span> <span class=\"n\">run</span> <span class=\"n\">apt</span><span class=\"bp\">-</span><span class=\"n\">get</span> <span class=\"n\">update</span> <span class=\"n\">or</span> <span class=\"n\">try</span> <span class=\"k\">with</span> <span class=\"c1\">--fix-missing?</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Usually running <code>apt-get update</code> first (which fetches the package indices) helps indeed.</p>",
        "id": 409588510,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1703254163
    },
    {
        "content": "<p>What I think happened is that the <code>olean</code> file was old but the <code>olean.hash</code> and <code>.trace</code> files were updated, so both lake and cache think the file is up to date</p>",
        "id": 409588593,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703254199
    },
    {
        "content": "<p>Yes, but that got stuck because of missing permissions (which I assume I could have sorted out too)</p>",
        "id": 409588596,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703254201
    },
    {
        "content": "<p>I have no idea how that could have happened</p>",
        "id": 409588703,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703254221
    },
    {
        "content": "<p>Hash collision?</p>",
        "id": 409588750,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703254246
    },
    {
        "content": "<p>unlikely, the hashes are pretty large</p>",
        "id": 409588791,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703254264
    },
    {
        "content": "<p>it might have been an interrupted lake or cache process which only wrote some of the files</p>",
        "id": 409588890,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703254307
    },
    {
        "content": "<p>It's possible. I was switching branches 2-3 times per minute when that happened</p>",
        "id": 409588993,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703254343
    },
    {
        "content": "<p>side note, nuking <code>.lake</code> would have solved this problem</p>",
        "id": 409589095,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703254400
    },
    {
        "content": "<p>but at least it was a learning experience <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 409589134,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703254418
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/The.20cache.20doesn't.20work/near/409589095\">said</a>:</p>\n<blockquote>\n<p>side note, nuking <code>.lake</code> would have solved this problem</p>\n</blockquote>\n<p>But... I did that?</p>",
        "id": 409589165,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703254434
    },
    {
        "content": "<p>maybe it got messed up after you did it?</p>",
        "id": 409589264,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703254465
    },
    {
        "content": "<p>Well, the first time I nuked the old <code>lake-packages</code>. The second time, I'm pretty sure I nuked <code>.lake/build</code></p>",
        "id": 409589271,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703254468
    },
    {
        "content": "<p>Is there a lock-like protocol for writing these files atomically needed so that concurrent <code>lake build</code> and <code>cache</code> don't step on their toes? Or was that not the problem here?<br>\n(If it’s just one file you can do an atomic rename, but with three it’s a bit harder; probably delete one main one, write the others, atomically write the last one.)</p>",
        "id": 409589326,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1703254502
    },
    {
        "content": "<p>It was definitely messed up before I did it, so if you're covered it must have been messed up twice.</p>",
        "id": 409589333,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703254505
    },
    {
        "content": "<p>Yeah I was also thinking about that, possibly you had a <code>v4.4.0</code> lake process running in the background and started by the old server while you were doing your thing</p>",
        "id": 409589406,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703254547
    },
    {
        "content": "<p>and so you ended up with a mixture of files from different versions</p>",
        "id": 409589505,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1703254575
    },
    {
        "content": "<p>Good point. I restarted the server <em>after</em> nuking <code>.lake</code></p>",
        "id": 409589538,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703254589
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"#narrow/stream/113488-general/topic/The.20cache.20doesn't.20work/near/409586424\">said</a>:</p>\n<blockquote>\n<p><span aria-label=\"sweat\" class=\"emoji emoji-1f613\" role=\"img\" title=\"sweat\">:sweat:</span> </p>\n<p><div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">gitpod</span> <span class=\"bp\">/</span><span class=\"n\">workspace</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"o\">(</span><span class=\"n\">master</span><span class=\"o\">)</span> <span class=\"bp\">$</span> <span class=\"n\">sudo</span> <span class=\"n\">apt</span> <span class=\"n\">install</span> <span class=\"n\">xxd</span>\n<span class=\"n\">Reading</span> <span class=\"n\">package</span> <span class=\"n\">lists...</span> <span class=\"n\">Done</span>\n<span class=\"n\">Building</span> <span class=\"n\">dependency</span> <span class=\"n\">tree...</span> <span class=\"n\">Done</span>\n<span class=\"n\">Reading</span> <span class=\"n\">state</span> <span class=\"n\">information...</span> <span class=\"n\">Done</span>\n<span class=\"n\">The</span> <span class=\"n\">following</span> <span class=\"n\">NEW</span> <span class=\"n\">packages</span> <span class=\"n\">will</span> <span class=\"n\">be</span> <span class=\"n\">installed</span><span class=\"o\">:</span>\n  <span class=\"n\">xxd</span>\n<span class=\"mi\">0</span> <span class=\"n\">upgraded</span><span class=\"o\">,</span> <span class=\"mi\">1</span> <span class=\"n\">newly</span> <span class=\"n\">installed</span><span class=\"o\">,</span> <span class=\"mi\">0</span> <span class=\"n\">to</span> <span class=\"n\">remove</span> <span class=\"n\">and</span> <span class=\"mi\">0</span> <span class=\"n\">not</span> <span class=\"n\">upgraded.</span>\n<span class=\"n\">Need</span> <span class=\"n\">to</span> <span class=\"n\">get</span> <span class=\"mi\">54</span><span class=\"bp\">.</span><span class=\"mi\">2</span> <span class=\"n\">kB</span> <span class=\"n\">of</span> <span class=\"n\">archives.</span>\n<span class=\"n\">After</span> <span class=\"n\">this</span> <span class=\"n\">operation</span><span class=\"o\">,</span> <span class=\"mi\">285</span> <span class=\"n\">kB</span> <span class=\"n\">of</span> <span class=\"n\">additional</span> <span class=\"n\">disk</span> <span class=\"n\">space</span> <span class=\"n\">will</span> <span class=\"n\">be</span> <span class=\"n\">used.</span>\n<span class=\"n\">Ign</span><span class=\"o\">:</span><span class=\"mi\">1</span> <span class=\"n\">http</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">archive.ubuntu.com</span><span class=\"bp\">/</span><span class=\"n\">ubuntu</span> <span class=\"n\">jammy</span><span class=\"bp\">-</span><span class=\"n\">updates</span><span class=\"bp\">/</span><span class=\"n\">main</span> <span class=\"n\">amd64</span> <span class=\"n\">xxd</span> <span class=\"n\">amd64</span> <span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"mi\">8</span><span class=\"bp\">.</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">3995</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"n\">ubuntu2.12</span>\n<span class=\"n\">Err</span><span class=\"o\">:</span><span class=\"mi\">1</span> <span class=\"n\">http</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">security.ubuntu.com</span><span class=\"bp\">/</span><span class=\"n\">ubuntu</span> <span class=\"n\">jammy</span><span class=\"bp\">-</span><span class=\"n\">updates</span><span class=\"bp\">/</span><span class=\"n\">main</span> <span class=\"n\">amd64</span> <span class=\"n\">xxd</span> <span class=\"n\">amd64</span> <span class=\"mi\">2</span><span class=\"o\">:</span><span class=\"mi\">8</span><span class=\"bp\">.</span><span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">3995</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"n\">ubuntu2.12</span>\n  <span class=\"mi\">404</span>  <span class=\"n\">Not</span> <span class=\"n\">Found</span> <span class=\"o\">[</span><span class=\"n\">IP</span><span class=\"o\">:</span> <span class=\"mi\">91</span><span class=\"bp\">.</span><span class=\"mi\">189</span><span class=\"bp\">.</span><span class=\"mi\">91</span><span class=\"bp\">.</span><span class=\"mi\">83</span> <span class=\"mi\">80</span><span class=\"o\">]</span>\n<span class=\"n\">E</span><span class=\"o\">:</span> <span class=\"n\">Failed</span> <span class=\"n\">to</span> <span class=\"n\">fetch</span> <span class=\"n\">http</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">security.ubuntu.com</span><span class=\"bp\">/</span><span class=\"n\">ubuntu</span><span class=\"bp\">/</span><span class=\"n\">pool</span><span class=\"bp\">/</span><span class=\"n\">main</span><span class=\"bp\">/</span><span class=\"n\">v</span><span class=\"bp\">/</span><span class=\"n\">vim</span><span class=\"bp\">/</span><span class=\"n\">xxd_8.2.3995</span><span class=\"bp\">-</span><span class=\"mi\">1</span><span class=\"n\">ubuntu2.12_amd64.deb</span>  <span class=\"mi\">404</span>  <span class=\"n\">Not</span> <span class=\"n\">Found</span> <span class=\"o\">[</span><span class=\"n\">IP</span><span class=\"o\">:</span> <span class=\"mi\">91</span><span class=\"bp\">.</span><span class=\"mi\">189</span><span class=\"bp\">.</span><span class=\"mi\">91</span><span class=\"bp\">.</span><span class=\"mi\">83</span> <span class=\"mi\">80</span><span class=\"o\">]</span>\n<span class=\"n\">E</span><span class=\"o\">:</span> <span class=\"n\">Unable</span> <span class=\"n\">to</span> <span class=\"n\">fetch</span> <span class=\"n\">some</span> <span class=\"n\">archives</span><span class=\"o\">,</span> <span class=\"n\">maybe</span> <span class=\"n\">run</span> <span class=\"n\">apt</span><span class=\"bp\">-</span><span class=\"n\">get</span> <span class=\"n\">update</span> <span class=\"n\">or</span> <span class=\"n\">try</span> <span class=\"k\">with</span> <span class=\"c1\">--fix-missing?</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>You have to run <code>apt-get update</code> first like it says</p>",
        "id": 409614900,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1703264580
    },
    {
        "content": "<p>Another issue with cache: when download fails with error like \"Recv failure: Connection reset by peer\", <code>lake exe cache get</code> doesn't unpack the files it downloaded.</p>",
        "id": 409844554,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1703454180
    },
    {
        "content": "<p>This happened again, fyi. Same scenario: I switched between branches on different Lean versions, got cache and restarted Lean on a file before restarting the server.</p>",
        "id": 410027515,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1703598489
    },
    {
        "content": "<p>New problem: <code>lake exe cache get</code> doesn't download <em>anything</em></p>",
        "id": 410738842,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704128391
    },
    {
        "content": "<p>I've been having this problem all afternoon - even on a clean checkout of <code>master</code> nothing downloads from the cache:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">pushd</span> <span class=\"bp\">/</span><span class=\"n\">tmp</span>\n<span class=\"bp\">/</span><span class=\"n\">tmp</span> <span class=\"bp\">~/</span><span class=\"n\">Documents</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span>\n\n<span class=\"n\">git</span> <span class=\"n\">clone</span> <span class=\"n\">git</span><span class=\"bp\">@</span><span class=\"n\">github.com</span><span class=\"o\">:</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">mathlib4.git</span>\n<span class=\"n\">Cloning</span> <span class=\"n\">into</span> <span class=\"bp\">'</span><span class=\"n\">mathlib4'...</span>\n<span class=\"n\">remote</span><span class=\"o\">:</span> <span class=\"n\">Enumerating</span> <span class=\"n\">objects</span><span class=\"o\">:</span> <span class=\"mi\">250876</span><span class=\"o\">,</span> <span class=\"n\">done.</span>\n<span class=\"n\">remote</span><span class=\"o\">:</span> <span class=\"n\">Counting</span> <span class=\"n\">objects</span><span class=\"o\">:</span> <span class=\"mi\">100</span><span class=\"bp\">%</span> <span class=\"o\">(</span><span class=\"mi\">2897</span><span class=\"bp\">/</span><span class=\"mi\">2897</span><span class=\"o\">),</span> <span class=\"n\">done.</span>\n<span class=\"n\">remote</span><span class=\"o\">:</span> <span class=\"n\">Compressing</span> <span class=\"n\">objects</span><span class=\"o\">:</span> <span class=\"mi\">100</span><span class=\"bp\">%</span> <span class=\"o\">(</span><span class=\"mi\">1151</span><span class=\"bp\">/</span><span class=\"mi\">1151</span><span class=\"o\">),</span> <span class=\"n\">done.</span>\n<span class=\"n\">remote</span><span class=\"o\">:</span> <span class=\"n\">Total</span> <span class=\"mi\">250876</span> <span class=\"o\">(</span><span class=\"n\">delta</span> <span class=\"mi\">2185</span><span class=\"o\">),</span> <span class=\"n\">reused</span> <span class=\"mi\">2288</span> <span class=\"o\">(</span><span class=\"n\">delta</span> <span class=\"mi\">1733</span><span class=\"o\">),</span> <span class=\"n\">pack</span><span class=\"bp\">-</span><span class=\"n\">reused</span> <span class=\"mi\">247979</span>\n<span class=\"n\">Receiving</span> <span class=\"n\">objects</span><span class=\"o\">:</span> <span class=\"mi\">100</span><span class=\"bp\">%</span> <span class=\"o\">(</span><span class=\"mi\">250876</span><span class=\"bp\">/</span><span class=\"mi\">250876</span><span class=\"o\">),</span> <span class=\"mi\">121</span><span class=\"bp\">.</span><span class=\"mi\">35</span> <span class=\"n\">MiB</span> <span class=\"bp\">|</span> <span class=\"mi\">2</span><span class=\"bp\">.</span><span class=\"mi\">29</span> <span class=\"n\">MiB</span><span class=\"bp\">/</span><span class=\"n\">s</span><span class=\"o\">,</span> <span class=\"n\">done.</span>\n<span class=\"n\">Resolving</span> <span class=\"n\">deltas</span><span class=\"o\">:</span> <span class=\"mi\">100</span><span class=\"bp\">%</span> <span class=\"o\">(</span><span class=\"mi\">198314</span><span class=\"bp\">/</span><span class=\"mi\">198314</span><span class=\"o\">),</span> <span class=\"n\">done.</span>\n\n<span class=\"n\">cd</span> <span class=\"n\">mathlib4</span><span class=\"bp\">/</span>\n\n<span class=\"n\">lake</span> <span class=\"n\">exe</span> <span class=\"n\">cache</span> <span class=\"n\">get</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">std</span><span class=\"o\">:</span> <span class=\"n\">cloning</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github.com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">std4</span> <span class=\"n\">to</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">std'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">Qq</span><span class=\"o\">:</span> <span class=\"n\">cloning</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github.com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">quote4</span> <span class=\"n\">to</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Qq'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">aesop</span><span class=\"o\">:</span> <span class=\"n\">cloning</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github.com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">aesop</span> <span class=\"n\">to</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">aesop'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">proofwidgets</span><span class=\"o\">:</span> <span class=\"n\">cloning</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github.com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"n\">ProofWidgets4</span> <span class=\"n\">to</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">proofwidgets'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">Cli</span><span class=\"o\">:</span> <span class=\"n\">cloning</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github.com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">cli</span> <span class=\"n\">to</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Cli'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Downloading</span> <span class=\"n\">proofwidgets</span> <span class=\"n\">cloud</span> <span class=\"n\">release</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Unpacking</span> <span class=\"n\">proofwidgets</span> <span class=\"n\">cloud</span> <span class=\"n\">release</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Cache.IO</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">Cache.IO</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Cache.Hashing</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">Cache.Hashing</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Cache.Requests</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">Cache.Requests</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Cache.Main</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">Cache.Main</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">9</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Linking</span> <span class=\"n\">cache</span>\n<span class=\"n\">Attempting</span> <span class=\"n\">to</span> <span class=\"n\">download</span> <span class=\"mi\">1800</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">Downloaded</span><span class=\"o\">:</span> <span class=\"mi\">0</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">attempted</span> <span class=\"mi\">1800</span><span class=\"bp\">/</span><span class=\"mi\">1800</span> <span class=\"bp\">=</span> <span class=\"mi\">100</span><span class=\"bp\">%</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">0</span><span class=\"bp\">%</span> <span class=\"n\">success</span><span class=\"o\">)</span>\n<span class=\"n\">Warning</span><span class=\"o\">:</span> <span class=\"n\">some</span> <span class=\"n\">files</span> <span class=\"n\">were</span> <span class=\"n\">not</span> <span class=\"n\">found</span> <span class=\"k\">in</span> <span class=\"n\">the</span> <span class=\"n\">cache.</span>\n<span class=\"n\">This</span> <span class=\"n\">usually</span> <span class=\"n\">means</span> <span class=\"n\">that</span> <span class=\"n\">your</span> <span class=\"kn\">local</span> <span class=\"n\">checkout</span> <span class=\"n\">of</span> <span class=\"n\">mathlib4</span> <span class=\"n\">has</span> <span class=\"n\">diverged</span> <span class=\"k\">from</span> <span class=\"n\">upstream.</span>\n<span class=\"n\">If</span> <span class=\"n\">you</span> <span class=\"n\">push</span> <span class=\"n\">your</span> <span class=\"n\">commits</span> <span class=\"n\">to</span> <span class=\"n\">a</span> <span class=\"n\">branch</span> <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">mathlib4</span> <span class=\"n\">repository</span><span class=\"o\">,</span> <span class=\"n\">CI</span> <span class=\"n\">will</span> <span class=\"n\">build</span> <span class=\"n\">the</span> <span class=\"n\">oleans</span> <span class=\"n\">and</span> <span class=\"n\">they</span> <span class=\"n\">will</span> <span class=\"n\">be</span> <span class=\"n\">available</span> <span class=\"n\">later.</span>\n<span class=\"n\">Decompressing</span> <span class=\"mi\">2276</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">unpacked</span> <span class=\"k\">in</span> <span class=\"mi\">6085</span> <span class=\"n\">ms</span>\n</code></pre></div>",
        "id": 410744393,
        "sender_full_name": "Christopher Hoskin",
        "timestamp": 1704134125
    },
    {
        "content": "<p>Yep that's the same problem I'm having</p>",
        "id": 410746737,
        "sender_full_name": "Chris Birkbeck",
        "timestamp": 1704136421
    },
    {
        "content": "<p>This seems very high priority to me. I can't do any mathlib work right now (well, I can, but that's because I have a Lean compiler in my head) and I suppose no one else can.</p>",
        "id": 410746804,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704136493
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">$</span> <span class=\"n\">lake</span> <span class=\"n\">build</span>\n<span class=\"o\">[</span><span class=\"mi\">791</span><span class=\"bp\">/</span><span class=\"mi\">1883</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Mathlib.Algebra.GroupPower.Order</span>\n</code></pre></div>",
        "id": 410747046,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1704136758
    },
    {
        "content": "<p>Never mind, previous commits have missing files too, let me bisect it</p>",
        "id": 410747272,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1704136976
    },
    {
        "content": "<p>Bisects to 0d6117a47dd8f9fe074025146a29b195bf0230f1, but there's nothing suspicious in the <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/7377140293/job/20070765290\">corresponding staging run log</a>. <a href=\"https://lakecache.blob.core.windows.net/mathlib4/f/b828f223bf7b5621.ltar\">https://lakecache.blob.core.windows.net/mathlib4/f/b828f223bf7b5621.ltar</a> is just missing, I guess someone with Azure access will need to debug this:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">$</span> <span class=\"n\">lake</span> <span class=\"n\">exe</span> <span class=\"n\">cache</span> <span class=\"n\">lookup</span> <span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">BigOperators</span><span class=\"bp\">/</span><span class=\"n\">Order.lean</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">BigOperators</span><span class=\"bp\">/</span><span class=\"n\">Order.lean</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">collares</span><span class=\"bp\">/.</span><span class=\"n\">cache</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/</span><span class=\"n\">b828f223bf7b5621.ltar</span>\n<span class=\"n\">uncaught</span> <span class=\"n\">exception</span><span class=\"o\">:</span> <span class=\"bp\">/</span><span class=\"n\">home</span><span class=\"bp\">/</span><span class=\"n\">collares</span><span class=\"bp\">/.</span><span class=\"n\">cache</span><span class=\"bp\">/</span><span class=\"n\">mathlib</span><span class=\"bp\">/</span><span class=\"n\">b828f223bf7b5621.ltar</span> <span class=\"n\">not</span> <span class=\"n\">found</span>\n</code></pre></div>",
        "id": 410747568,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1704137286
    },
    {
        "content": "<p>this still seems to be the case, btw</p>",
        "id": 410771024,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1704154282
    },
    {
        "content": "<p>I'm investigating, but I agree that this needs someone to check up with azure, I think it's dropping files for some reason</p>",
        "id": 410772211,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704154914
    },
    {
        "content": "<p>And to make matters worse, I think no one in the admin team knows the keys either (<span class=\"user-mention\" data-user-id=\"110596\">@Rob Lewis</span>?)</p>",
        "id": 410772536,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704155109
    },
    {
        "content": "<p>The azure keys expire after a year, so I think it might have something to do with the new year...</p>",
        "id": 410772648,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704155168
    },
    {
        "content": "<p>Confirmed that the issue is that our azure account has expired. For now, the cache is read only which means all our uploads are failing. I don't think there is a quick fix, we may or may not need to switch providers.</p>",
        "id": 410775633,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704156970
    },
    {
        "content": "<p>What does the azure account host for those not in the know?</p>",
        "id": 410775962,
        "sender_full_name": "Newell Jensen",
        "timestamp": 1704157218
    },
    {
        "content": "<p>The thing that <code>lake exe cache get</code> downloads</p>",
        "id": 410776271,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704157379
    },
    {
        "content": "<p>blob storage for all the build artifacts of mathlib</p>",
        "id": 410776322,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704157406
    },
    {
        "content": "<p>For the time being, I think this means we'll have to do things the old fashioned way and just compile mathlib locally</p>",
        "id": 410776472,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704157467
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/The.20cache.20doesn't.20work/near/410776322\">said</a>:</p>\n<blockquote>\n<p>blob storage for all the build artifacts of mathlib</p>\n</blockquote>\n<p>Nothing else?  Even so, this breaks everything else that relies on this, which is probably most things like CI etc. right?</p>",
        "id": 410776582,
        "sender_full_name": "Newell Jensen",
        "timestamp": 1704157553
    },
    {
        "content": "<p>Note that you can still use <code>lake exe cache pack</code> and <code>lake exe cache unpack</code> to sync cache files on your local machine</p>",
        "id": 410776599,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704157563
    },
    {
        "content": "<p>CI isn't broken per se, it just has to compile all of mathlib every time now</p>",
        "id": 410776652,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704157592
    },
    {
        "content": "<p>or at least the part that hasn't been invalidated yet</p>",
        "id": 410776665,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704157611
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/The.20cache.20doesn't.20work/near/410776472\">said</a>:</p>\n<blockquote>\n<p>For the time being, I think this means we'll have to do things the old fashioned way and just compile mathlib locally</p>\n</blockquote>\n<p>As long as the cache can still be read, a short term workaround is to start all new branches against mathlib from last year.</p>",
        "id": 410780827,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1704160470
    },
    {
        "content": "<p>maybe we should make a tag for that</p>",
        "id": 410780983,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704160572
    },
    {
        "content": "<p>What's the last revision with cache?</p>",
        "id": 410794352,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1704171004
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/commit/0c9d4118caa615ee8c9592a1da2e3fd79d682cf8\">https://github.com/leanprover-community/mathlib4/commit/0c9d4118caa615ee8c9592a1da2e3fd79d682cf8</a></p>",
        "id": 410795838,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704172291
    },
    {
        "content": "<p>added as <code>v2024</code></p>",
        "id": 410795982,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704172414
    },
    {
        "content": "<p>I get a 403 error if I run <code>lake exe cache get</code> on that commit; maybe this is an unrelated transient issue</p>",
        "id": 410823553,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1704190415
    },
    {
        "content": "<p>happening to me as well, I don't think that was happening before</p>",
        "id": 410826493,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704191922
    },
    {
        "content": "<p>github also has the 403 error…</p>",
        "id": 410826733,
        "sender_full_name": "Antoine Chambert-Loir",
        "timestamp": 1704192023
    },
    {
        "content": "<p>according to logs there hasn't been any azure traffic for the past 30 minutes but it could be a server issue</p>",
        "id": 410828109,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704192742
    },
    {
        "content": "<p>What is going on???</p>",
        "id": 410847946,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1704203213
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110043\">@Gabriel Ebner</span> was the one who helped me with Azure access and keys ~1 year ago so I'm pinging him. Maybe he has some insight</p>",
        "id": 410848114,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1704203311
    },
    {
        "content": "<p>I double checked azure and I think this 403 thing is permanent, the account is now \"disabled\" (not \"read only\") and we're going to have to figure out how to renew or something to get access back</p>",
        "id": 410848273,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704203401
    },
    {
        "content": "<p>Who owns the Azure account?</p>",
        "id": 410848402,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1704203461
    },
    {
        "content": "<p>leanprover-community org</p>",
        "id": 410848453,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704203494
    },
    {
        "content": "<p>it was an MS sponsorship (donation)</p>",
        "id": 410848515,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704203524
    },
    {
        "content": "<p>I think you should make an announcement thread about this, operating like GitHub status</p>",
        "id": 410854888,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1704206381
    },
    {
        "content": "<p>Are the ltars available as a github artifact? For now I think we could make one copy of a reasonably recent one available with some instructions on how to install them</p>",
        "id": 410857097,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1704207275
    },
    {
        "content": "<p>Now all builds are <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/7387205923/job/20095417213\">failing at the \"get cache\" step</a>.</p>",
        "id": 410868970,
        "sender_full_name": "Junyan Xu",
        "timestamp": 1704212004
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"224323\">Junyan Xu</span> <a href=\"#narrow/stream/113488-general/topic/The.20cache.20doesn't.20work/near/410868970\">said</a>:</p>\n<blockquote>\n<p>Now all builds are <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/7387205923/job/20095417213\">failing at the \"get cache\" step</a>.</p>\n</blockquote>\n<p>That was true as of ~3 hours before you made that post</p>",
        "id": 410918776,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1704237062
    },
    {
        "content": "<p>FYI, we are working on getting this fixed. Stay tuned, hopefully things will be back online tomorrow <span aria-label=\"fingers crossed\" class=\"emoji emoji-1f91e\" role=\"img\" title=\"fingers crossed\">:fingers_crossed:</span></p>",
        "id": 410941092,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1704247443
    },
    {
        "content": "<p>Just mentioning that <a href=\"https://github.com/leanprover-community/mathlib4/pull/9391\">#9391</a> should be put back on the queue once CI is fixed.</p>",
        "id": 410970272,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704267838
    },
    {
        "content": "<p>For easy reference: what is the <code>lake</code> command to build (the olean files of) everything up to a specific file in Mathlib (when working on Mathlib)? I find the output of <code>lake --help build</code> somewhat confusing...</p>",
        "id": 410988587,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1704276913
    },
    {
        "content": "<p><code>lake build Mathlib.Your.Module</code>. Or open the file in your editor.</p>",
        "id": 410989966,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1704277636
    },
    {
        "content": "<p>Does opening the file in your editor now create oleans on your hard drive? (it didn't used to IIRC)</p>",
        "id": 411000294,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1704282406
    },
    {
        "content": "<p>Starting with Lean 4, yes</p>",
        "id": 411001152,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1704282838
    },
    {
        "content": "<p>after the confirmation</p>",
        "id": 411001277,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1704282875
    },
    {
        "content": "<p>I'm having the same (?) problem...since yesterday.  I'm on MacOS.   Have had no previous problems with this.      When I run lake exe cache get, OR lake update within a project I get 403 errors.       <br>\nLean (version 4.5.0-rc1, commit b614ff1d12bc, Release)<br>\nLake version 5.0.0-b614ff1 (Lean version 4.5.0-rc1)</p>",
        "id": 411030713,
        "sender_full_name": "Dan Dougherty",
        "timestamp": 1704294797
    },
    {
        "content": "<p>We are aware <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span> This will hopefully be resolved today or tomorrow.</p>",
        "id": 411030787,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704294836
    },
    {
        "content": "<p>If there's no resolution by today, I prepared a small work-around too.</p>",
        "id": 411030914,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1704294888
    },
    {
        "content": "<p>Thanks to the work of <span class=\"user-mention\" data-user-id=\"110024\">@Sebastian Ullrich</span> in <a href=\"https://github.com/leanprover-community/mathlib4/pull/9409\">#9409</a> and the pocketbook of the Lean FRO, the mathlib cache has moved from Azure to Cloudflare R2. Old commits will still not work however, and we are still looking into how to re-enable the Azure endpoint so that we don't break all the old caches. You should either update mathlib master, or rebase your mathlib branch onto master to be able to make use of the new cache.</p>",
        "id": 411038133,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704297741
    },
    {
        "content": "<p>The timeline for old commits returning may be very short -- AFAIK we're just waiting for an Azure support rep to click a button.</p>",
        "id": 411039010,
        "sender_full_name": "Rob Lewis",
        "timestamp": 1704297992
    },
    {
        "content": "<p>Old commits indeed should now work as well again, except for the ones in the last few days not uploaded while the cache was down</p>",
        "id": 411049237,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1704301907
    },
    {
        "content": "<p>What to do with these commits?</p>",
        "id": 411053049,
        "sender_full_name": "Josha Dekker",
        "timestamp": 1704303630
    },
    {
        "content": "<p>Don't use them :) Current master is fine, so projects depending on mathlib can just run <code>lake update</code> and mathlib branches created in the last couple of days can be rebased (just merging master is also fine).</p>",
        "id": 411054263,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1704304189
    },
    {
        "content": "<p>My PR <a href=\"https://github.com/leanprover-community/mathlib4/pull/9200\">#9200</a> was accepted yesterday, but building failed because of the cache issue. Should I make a new commit to this that changes nothing to restart the building process, or will this be dealt with automatically?</p>",
        "id": 411056827,
        "sender_full_name": "Josha Dekker",
        "timestamp": 1704305143
    },
    {
        "content": "<p>you'll have to merge master on your PR</p>",
        "id": 411056997,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1704305185
    },
    {
        "content": "<p>okay, will do!</p>",
        "id": 411057336,
        "sender_full_name": "Josha Dekker",
        "timestamp": 1704305284
    },
    {
        "content": "<p>Thanks for the work on this. Things are looking better, but I'm still not getting 100% success on the latest HEAD of master:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">lake</span> <span class=\"n\">exe</span> <span class=\"n\">cache</span> <span class=\"n\">get</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Cache.IO</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">Cache.IO</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Cache.Hashing</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Cache.Requests</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">Cache.Requests</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">5</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Cache.Main</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">Cache.Main</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">9</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Linking</span> <span class=\"n\">cache</span>\n<span class=\"n\">Attempting</span> <span class=\"n\">to</span> <span class=\"n\">download</span> <span class=\"mi\">4077</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">Downloaded</span><span class=\"o\">:</span> <span class=\"mi\">3889</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">attempted</span> <span class=\"mi\">4077</span><span class=\"bp\">/</span><span class=\"mi\">4077</span> <span class=\"bp\">=</span> <span class=\"mi\">100</span><span class=\"bp\">%</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">95</span><span class=\"bp\">%</span> <span class=\"n\">success</span><span class=\"o\">)</span>\n<span class=\"n\">Warning</span><span class=\"o\">:</span> <span class=\"n\">some</span> <span class=\"n\">files</span> <span class=\"n\">were</span> <span class=\"n\">not</span> <span class=\"n\">found</span> <span class=\"k\">in</span> <span class=\"n\">the</span> <span class=\"n\">cache.</span>\n<span class=\"n\">This</span> <span class=\"n\">usually</span> <span class=\"n\">means</span> <span class=\"n\">that</span> <span class=\"n\">your</span> <span class=\"kn\">local</span> <span class=\"n\">checkout</span> <span class=\"n\">of</span> <span class=\"n\">mathlib4</span> <span class=\"n\">has</span> <span class=\"n\">diverged</span> <span class=\"k\">from</span> <span class=\"n\">upstream.</span>\n<span class=\"n\">If</span> <span class=\"n\">you</span> <span class=\"n\">push</span> <span class=\"n\">your</span> <span class=\"n\">commits</span> <span class=\"n\">to</span> <span class=\"n\">a</span> <span class=\"n\">branch</span> <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">mathlib4</span> <span class=\"n\">repository</span><span class=\"o\">,</span> <span class=\"n\">CI</span> <span class=\"n\">will</span> <span class=\"n\">build</span> <span class=\"n\">the</span> <span class=\"n\">oleans</span> <span class=\"n\">and</span> <span class=\"n\">they</span> <span class=\"n\">will</span> <span class=\"n\">be</span> <span class=\"n\">available</span> <span class=\"n\">later.</span>\n<span class=\"n\">Decompressing</span> <span class=\"mi\">3889</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">unpacked</span> <span class=\"k\">in</span> <span class=\"mi\">3101</span> <span class=\"n\">ms</span>\n</code></pre></div>\n<p>Is there something else I need to do? I tried:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">lake</span> <span class=\"n\">exe</span> <span class=\"n\">cache</span> <span class=\"n\">get</span><span class=\"bp\">!</span>\n<span class=\"n\">Attempting</span> <span class=\"n\">to</span> <span class=\"n\">download</span> <span class=\"mi\">4077</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">Downloaded</span><span class=\"o\">:</span> <span class=\"mi\">3889</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span> <span class=\"o\">[</span><span class=\"n\">attempted</span> <span class=\"mi\">4077</span><span class=\"bp\">/</span><span class=\"mi\">4077</span> <span class=\"bp\">=</span> <span class=\"mi\">100</span><span class=\"bp\">%</span><span class=\"o\">]</span> <span class=\"o\">(</span><span class=\"mi\">95</span><span class=\"bp\">%</span> <span class=\"n\">success</span><span class=\"o\">)</span>\n<span class=\"n\">Warning</span><span class=\"o\">:</span> <span class=\"n\">some</span> <span class=\"n\">files</span> <span class=\"n\">were</span> <span class=\"n\">not</span> <span class=\"n\">found</span> <span class=\"k\">in</span> <span class=\"n\">the</span> <span class=\"n\">cache.</span>\n<span class=\"n\">This</span> <span class=\"n\">usually</span> <span class=\"n\">means</span> <span class=\"n\">that</span> <span class=\"n\">your</span> <span class=\"kn\">local</span> <span class=\"n\">checkout</span> <span class=\"n\">of</span> <span class=\"n\">mathlib4</span> <span class=\"n\">has</span> <span class=\"n\">diverged</span> <span class=\"k\">from</span> <span class=\"n\">upstream.</span>\n<span class=\"n\">If</span> <span class=\"n\">you</span> <span class=\"n\">push</span> <span class=\"n\">your</span> <span class=\"n\">commits</span> <span class=\"n\">to</span> <span class=\"n\">a</span> <span class=\"n\">branch</span> <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">mathlib4</span> <span class=\"n\">repository</span><span class=\"o\">,</span> <span class=\"n\">CI</span> <span class=\"n\">will</span> <span class=\"n\">build</span> <span class=\"n\">the</span> <span class=\"n\">oleans</span> <span class=\"n\">and</span> <span class=\"n\">they</span> <span class=\"n\">will</span> <span class=\"n\">be</span> <span class=\"n\">available</span> <span class=\"n\">later.</span>\n<span class=\"n\">Decompressing</span> <span class=\"mi\">3889</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">unpacked</span> <span class=\"k\">in</span> <span class=\"mi\">3352</span> <span class=\"n\">ms</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">git</span> <span class=\"n\">status</span>\n<span class=\"n\">On</span> <span class=\"n\">branch</span> <span class=\"n\">master</span>\n<span class=\"n\">Your</span> <span class=\"n\">branch</span> <span class=\"n\">is</span> <span class=\"n\">up</span> <span class=\"n\">to</span> <span class=\"n\">date</span> <span class=\"k\">with</span> <span class=\"bp\">'</span><span class=\"n\">origin</span><span class=\"bp\">/</span><span class=\"n\">master'.</span>\n\n<span class=\"n\">nothing</span> <span class=\"n\">to</span> <span class=\"n\">commit</span><span class=\"o\">,</span> <span class=\"n\">working</span> <span class=\"n\">tree</span> <span class=\"n\">clean</span>\n</code></pre></div>",
        "id": 411058167,
        "sender_full_name": "Christopher Hoskin",
        "timestamp": 1704305582
    },
    {
        "content": "<p>What's the first commit on <code>git log</code>?</p>",
        "id": 411058352,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1704305651
    },
    {
        "content": "<p>I just pulled; I'm on <code>e23b08714daf24b36bff71d3387f034cd19c1a38</code> and I'm seeing the same behaviour:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>...\ninfo: [6/9] Compiling Cache.Main\ninfo: [9/9] Linking cache\nAttempting to download 3678 file(s)\nDownloaded: 3490 file(s) [attempted 3678/3678 = 100%] (94% success)\nWarning: some files were not found in the cache.\nThis usually means that your local checkout of mathlib4 has diverged from upstream.\nIf you push your commits to a branch of the mathlib4 repository, CI will build the oleans and they will be available later.\nDecompressing 3889 file(s)\nunpacked in 40983 ms\nbuzzard@ebony:~/lean-projects/mathlib4$ lake build\n[3254/4075] Building Mathlib.Analysis.Calculus.FormalMultilinearSeries\n[3440/4075] Building Mathlib.RingTheory.AlgebraicIndependent\n[3891/4075] Building Mathlib.Analysis.Calculus.ContDiff.Defs\n[3891/4075] Building Mathlib.Analysis.Analytic.Basic\n[3892/4075] Building Mathlib.FieldTheory.IsAlgClosed.Classification\n^C\nbuzzard@ebony:~/lean-projects/mathlib4$\n</code></pre></div>",
        "id": 411058849,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1704305884
    },
    {
        "content": "<p>I'm preparing a cache reset which should hopefully fix these issues</p>",
        "id": 411058990,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704305964
    },
    {
        "content": "<p>I think there are some bad files that were accidentally uploaded during the initial test</p>",
        "id": 411059159,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704306049
    },
    {
        "content": "<p>What's the \"Lean FRO\"?</p>",
        "id": 411067492,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1704309604
    },
    {
        "content": "<p>google it :-)</p>",
        "id": 411067955,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1704309828
    },
    {
        "content": "<p>oh</p>",
        "id": 411068165,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1704309923
    },
    {
        "content": "<p>\"Lean Focused Research Organization\" Here is a link <a href=\"https://lean-fro.org/\">https://lean-fro.org/</a></p>",
        "id": 411091750,
        "sender_full_name": "Bolton Bailey",
        "timestamp": 1704320819
    },
    {
        "content": "<p>In <a href=\"https://github.com/leanprover-community/mathlib4/pull/9401\">#9401</a>, I can't seem to get a cache for the resulting build</p>",
        "id": 411093342,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1704321802
    },
    {
        "content": "<p>(it finds no matching files to download)</p>",
        "id": 411093470,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1704321863
    },
    {
        "content": "<p>Yeah something still seems to be a bit off with the cache, uploads don't seem to stick or something. Sebastian wrote <a href=\"https://github.com/leanprover-community/mathlib4/pull/9414\">#9414</a> to try to improve the \"check the cache\" step (which is supposed to catch this issue) but I think it might be the end of the day, it's been a long day</p>",
        "id": 411093863,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704322149
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> how did you get the Azure cache back?</p>",
        "id": 411123480,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1704340870
    },
    {
        "content": "<p>We paid up</p>",
        "id": 411123571,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704340898
    },
    {
        "content": "<p>Then when you move to Cloudflare for good you're going to cancel the Azure subscription? (And are you close to working out the Cloudflare kinks?)</p>",
        "id": 411123863,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1704340998
    },
    {
        "content": "<p>Probably not, the Azure links are holding up all our old commits and these show up in various mathlib references on the internet, but the cost should decrease to something negligible if daily activity moves off of it</p>",
        "id": 411125344,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704341887
    },
    {
        "content": "<p>I just pushed a partial revert of <a href=\"https://github.com/leanprover-community/mathlib4/pull/9409\">#9409</a>, so master uses Azure once more, which should fix the intermittent cache failures. We plan to return to Cloudflare once we figure out how to make it not reject some uploads with 400s</p>",
        "id": 411129629,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704344967
    },
    {
        "content": "<p>Why is this failing?<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/7407203971/job/20153052765\">https://github.com/leanprover-community/mathlib4/actions/runs/7407203971/job/20153052765</a></p>",
        "id": 411147998,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1704357611
    },
    {
        "content": "<p>There's no 403 but there's an uncaught exception; I see the same thing in <a href=\"https://github.com/leanprover-community/mathlib4/pull/9428\">#9428</a></p>",
        "id": 411149148,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1704358223
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"598052\">Jeremy Tan</span> <a href=\"#narrow/stream/113488-general/topic/The.20cache.20doesn't.20work/near/411147998\">said</a>:</p>\n<blockquote>\n<p>Why is this failing?<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/7407203971/job/20153052765\">https://github.com/leanprover-community/mathlib4/actions/runs/7407203971/job/20153052765</a></p>\n</blockquote>\n<p>I got the same error as you (locally, macOS Sonoma, curl 8.1.2).</p>\n<p>I think it's caused by this change:<br>\n<a href=\"https://github.com/leanprover-community/mathlib4/commit/7c0310106360d5bede3c6ce86ef6d369e5efb6f0#r136197383\">https://github.com/leanprover-community/mathlib4/commit/7c0310106360d5bede3c6ce86ef6d369e5efb6f0#r136197383</a></p>\n<p>The error only happens when leantar is out of date, because that's when the script calls <code>curl</code> to install it. That might be why <span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> didn't see the problem.</p>",
        "id": 411156973,
        "sender_full_name": "Chris Wong",
        "timestamp": 1704361701
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/9434\">#9434</a> should fix this – someone PTAL :)</p>",
        "id": 411159797,
        "sender_full_name": "Chris Wong",
        "timestamp": 1704362592
    },
    {
        "content": "<p>It's queued, thanks for the swift help!</p>",
        "id": 411162091,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1704363430
    },
    {
        "content": "<p>Ah no, the solution is to pass the <code>-s</code> flag there as in the other curl calls</p>",
        "id": 411221814,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704385825
    },
    {
        "content": "<p>although it sounds like <code>-sS</code> would be better</p>",
        "id": 411222310,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704385968
    },
    {
        "content": "<p>the trouble is that curl is not indicating failures via the exit code like it should in the multi-file situation</p>",
        "id": 411222401,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704386005
    },
    {
        "content": "<p>I don't know if anybody else noticed, but all the caches I get before The Great Cache Incident are invalid, making them virtually useless.</p>",
        "id": 411630793,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704660261
    },
    {
        "content": "<p>This is mostly a non-problem, but <span class=\"user-mention\" data-user-id=\"657719\">@Terence Tao</span> just mentioned needing them to work on PFR (since my bump to post-Great Cache Incident mathlib is currently stuck).</p>",
        "id": 411630827,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704660312
    },
    {
        "content": "<p>Can you elaborate?</p>",
        "id": 411631066,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704660545
    },
    {
        "content": "<p>the cache files are present but don't work?</p>",
        "id": 411631089,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704660561
    },
    {
        "content": "<p>Some cache files (for commits during the incident) were lost but old cache files should still work</p>",
        "id": 411631165,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704660608
    },
    {
        "content": "<p><a href=\"https://github.com/teorth/pfr/blob/master/lake-manifest.json#L52C12-L52C52\">We're talking about <code>ea70e843f6449df0777fbfebe222d09a083bd844</code></a>, well before the incident.</p>",
        "id": 411631188,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704660658
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110049\">Mario Carneiro</span> <a href=\"#narrow/stream/113488-general/topic/The.20cache.20doesn't.20work/near/411631089\">said</a>:</p>\n<blockquote>\n<p>the cache files are present but don't work?</p>\n</blockquote>\n<p>Yes, exactly. <code>lake exe cache get</code> runs smoothly, but then I need to rebuild all the files past the first 200 or so.</p>",
        "id": 411631212,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704660696
    },
    {
        "content": "<p>Weird, I am working on PFR right now and the cache is working. Maybe <code>lake exe cache get!</code> helps in case you got a poisoned local cache?</p>",
        "id": 411631301,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1704660764
    },
    {
        "content": "<p>I actually had this issue with the bump  branch which has a more recent Mathlib version.</p>",
        "id": 411631330,
        "sender_full_name": "Terence Tao",
        "timestamp": 1704660800
    },
    {
        "content": "<p>I am now confusion.</p>",
        "id": 411631337,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704660816
    },
    {
        "content": "<p>also the usual debugging procedure is to use <code>lake exe cache lookup</code> on the first file which is rebuilt</p>",
        "id": 411631342,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704660824
    },
    {
        "content": "<p>This is what happens when I try to update cache from PFR master branch (which has the older version of Mathlib):</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">PS</span> <span class=\"n\">C</span><span class=\"o\">:</span><span class=\"bp\">\\</span><span class=\"n\">Users</span><span class=\"bp\">\\</span><span class=\"n\">teort</span><span class=\"bp\">\\</span><span class=\"n\">Dropbox</span><span class=\"bp\">\\</span><span class=\"n\">Lean</span><span class=\"bp\">\\</span><span class=\"n\">pfr</span><span class=\"bp\">&gt;</span> <span class=\"n\">lake</span> <span class=\"n\">exe</span> <span class=\"n\">cache</span> <span class=\"n\">get</span><span class=\"bp\">!</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">mathlib</span><span class=\"o\">:</span> <span class=\"n\">updating</span> <span class=\"n\">repository</span> <span class=\"bp\">'.\\.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">\\</span><span class=\"n\">mathlib'</span> <span class=\"n\">to</span> <span class=\"n\">revision</span> <span class=\"bp\">'</span><span class=\"n\">ea70e843f6449df0777fbfebe222d09a083bd844'</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"bp\">&gt;</span> <span class=\"n\">git</span> <span class=\"n\">checkout</span> <span class=\"c1\">--detach ea70e843f6449df0777fbfebe222d09a083bd844    # in directory .\\.lake/packages\\mathlib</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">stderr</span><span class=\"o\">:</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">Your</span> <span class=\"kn\">local</span> <span class=\"n\">changes</span> <span class=\"n\">to</span> <span class=\"n\">the</span> <span class=\"n\">following</span> <span class=\"n\">files</span> <span class=\"n\">would</span> <span class=\"n\">be</span> <span class=\"n\">overwritten</span> <span class=\"kd\">by</span> <span class=\"n\">checkout</span><span class=\"o\">:</span>\n        <span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">RingTheory</span><span class=\"bp\">/</span><span class=\"n\">Finiteness.lean</span>\n<span class=\"n\">Please</span> <span class=\"n\">commit</span> <span class=\"n\">your</span> <span class=\"n\">changes</span> <span class=\"n\">or</span> <span class=\"n\">stash</span> <span class=\"n\">them</span> <span class=\"n\">before</span> <span class=\"n\">you</span> <span class=\"n\">switch</span> <span class=\"n\">branches.</span>\n<span class=\"n\">Aborting</span>\n<span class=\"n\">error</span><span class=\"o\">:</span> <span class=\"n\">external</span> <span class=\"n\">command</span> <span class=\"bp\">`</span><span class=\"n\">git</span><span class=\"bp\">`</span> <span class=\"n\">exited</span> <span class=\"k\">with</span> <span class=\"n\">c</span>\n</code></pre></div>",
        "id": 411631453,
        "sender_full_name": "Terence Tao",
        "timestamp": 1704660924
    },
    {
        "content": "<p>This looks like you touched a file you shouldn't have in your local copy of mathlib within PFR.</p>",
        "id": 411631560,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704661032
    },
    {
        "content": "<p>It does show that file touched in the last hour or so; I don't remember actually messing with it but perhaps it happened by accident.  But I can't seem to revert it back at all, git seems to think everything is just fine:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">PS</span> <span class=\"n\">C</span><span class=\"o\">:</span><span class=\"bp\">\\</span><span class=\"n\">Users</span><span class=\"bp\">\\</span><span class=\"n\">teort</span><span class=\"bp\">\\</span><span class=\"n\">Dropbox</span><span class=\"bp\">\\</span><span class=\"n\">Lean</span><span class=\"bp\">\\</span><span class=\"n\">pfr</span><span class=\"bp\">&gt;</span> <span class=\"n\">git</span> <span class=\"n\">pull</span> <span class=\"n\">origin</span> <span class=\"n\">master</span> <span class=\"bp\">-</span><span class=\"n\">r</span>\n<span class=\"n\">From</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github.com</span><span class=\"bp\">/</span><span class=\"n\">teorth</span><span class=\"bp\">/</span><span class=\"n\">pfr</span>\n <span class=\"bp\">*</span> <span class=\"n\">branch</span>            <span class=\"n\">master</span>     <span class=\"bp\">-&gt;</span> <span class=\"n\">FETCH_HEAD</span>\n<span class=\"n\">Already</span> <span class=\"n\">up</span> <span class=\"n\">to</span> <span class=\"n\">date.</span>\n<span class=\"n\">PS</span> <span class=\"n\">C</span><span class=\"o\">:</span><span class=\"bp\">\\</span><span class=\"n\">Users</span><span class=\"bp\">\\</span><span class=\"n\">teort</span><span class=\"bp\">\\</span><span class=\"n\">Dropbox</span><span class=\"bp\">\\</span><span class=\"n\">Lean</span><span class=\"bp\">\\</span><span class=\"n\">pfr</span><span class=\"bp\">&gt;</span> <span class=\"n\">git</span> <span class=\"n\">reset</span> <span class=\"n\">HEAD</span> <span class=\"c1\">--hard</span>\n<span class=\"n\">HEAD</span> <span class=\"n\">is</span> <span class=\"n\">now</span> <span class=\"n\">at</span> <span class=\"mi\">0725</span><span class=\"n\">e2a</span> <span class=\"n\">Merge</span> <span class=\"n\">pull</span> <span class=\"n\">request</span> <span class=\"bp\">#</span><span class=\"mi\">170</span> <span class=\"k\">from</span> <span class=\"n\">llllvvuu</span><span class=\"bp\">/</span><span class=\"n\">chore</span><span class=\"bp\">/</span><span class=\"n\">fix_typo_single_fibres</span>\n<span class=\"n\">PS</span> <span class=\"n\">C</span><span class=\"o\">:</span><span class=\"bp\">\\</span><span class=\"n\">Users</span><span class=\"bp\">\\</span><span class=\"n\">teort</span><span class=\"bp\">\\</span><span class=\"n\">Dropbox</span><span class=\"bp\">\\</span><span class=\"n\">Lean</span><span class=\"bp\">\\</span><span class=\"n\">pfr</span><span class=\"bp\">&gt;</span> <span class=\"n\">git</span> <span class=\"n\">stash</span>\n<span class=\"n\">No</span> <span class=\"kn\">local</span> <span class=\"n\">changes</span> <span class=\"n\">to</span> <span class=\"n\">save</span>\n<span class=\"n\">PS</span> <span class=\"n\">C</span><span class=\"o\">:</span><span class=\"bp\">\\</span><span class=\"n\">Users</span><span class=\"bp\">\\</span><span class=\"n\">teort</span><span class=\"bp\">\\</span><span class=\"n\">Dropbox</span><span class=\"bp\">\\</span><span class=\"n\">Lean</span><span class=\"bp\">\\</span><span class=\"n\">pfr</span><span class=\"bp\">&gt;</span> <span class=\"n\">git</span> <span class=\"n\">pull</span> <span class=\"n\">origin</span> <span class=\"n\">master</span>\n<span class=\"n\">From</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github.com</span><span class=\"bp\">/</span><span class=\"n\">teorth</span><span class=\"bp\">/</span><span class=\"n\">pfr</span>\n <span class=\"bp\">*</span> <span class=\"n\">branch</span>            <span class=\"n\">master</span>     <span class=\"bp\">-&gt;</span> <span class=\"n\">FETCH_HEAD</span>\n<span class=\"n\">Already</span> <span class=\"n\">up</span> <span class=\"n\">to</span> <span class=\"n\">date.</span>\n</code></pre></div>",
        "id": 411631692,
        "sender_full_name": "Terence Tao",
        "timestamp": 1704661191
    },
    {
        "content": "<p>Worst case I just nuke my local folder and start over, so I guess as long as it works for everyone else it's fine</p>",
        "id": 411631826,
        "sender_full_name": "Terence Tao",
        "timestamp": 1704661260
    },
    {
        "content": "<p>you have to go into <code>.lake/packages/mathlib</code> and use <code>git reset --hard HEAD</code> because that's another repo</p>",
        "id": 411631847,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704661272
    },
    {
        "content": "<p>or just delete <code>.lake</code></p>",
        "id": 411631857,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704661278
    },
    {
        "content": "<p>OK, it's still building some PFR files but I think I got back to a working copy of the master build (with a successful cache grab).  I was in the wrong folder when I tried to grab the cache manually so that helps explain why I had to rebuild Mathlib the last few times.</p>",
        "id": 411632461,
        "sender_full_name": "Terence Tao",
        "timestamp": 1704661826
    },
    {
        "content": "<p>About missing files from old commits, in case they are really necessary:</p>\n<ul>\n<li>If it's on <code>main</code>, someone with pushing rights could do <code>lake exe cache put</code> if they're present locally</li>\n<li>If it's on a dangling branch from an unmerged PR, pushing a merging commit (to get the new updates/fixes from <code>main</code>) to trigger CI should, in theory, force the upload of the rebuilt cache, filling the gaps of missing files</li>\n</ul>",
        "id": 411637214,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1704666385
    },
    {
        "content": "<p>Is the cache working now for everyone else, in a repo of mathlib itself? This is what I get:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>git<span class=\"w\"> </span>clone<span class=\"w\"> </span>https://github.com/leanprover-community/mathlib4\n<span class=\"nb\">cd</span><span class=\"w\"> </span>mathlib4/\ncurl<span class=\"w\"> </span>-L<span class=\"w\"> </span>-O<span class=\"w\"> </span>https://raw.githubusercontent.com/leanprover-community/mathlib4/master/lean-toolchain\nlake<span class=\"w\"> </span>update\nlake<span class=\"w\"> </span>exe<span class=\"w\"> </span>cache<span class=\"w\"> </span>get\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>Attempting to download 4141 file(s)\nDownloaded: 0 file(s) [attempted 4141/4141 = 100%] (0% success)\nWarning: some files were not found in the cache.\nThis usually means that your local checkout of mathlib4 has diverged from upstream.\nIf you push your commits to a branch of the mathlib4 repository, CI will build the oleans and they will be available later.\nNo cache files to decompress\n</code></pre></div>",
        "id": 416583846,
        "sender_full_name": "Richard Copley",
        "timestamp": 1705588523
    },
    {
        "content": "<p>The line <code>lake update</code> is wrong. If you do the same without this line, does it work fine?</p>",
        "id": 416584992,
        "sender_full_name": "Sébastien Gouëzel",
        "timestamp": 1705588843
    },
    {
        "content": "<p>It does. Thanks!</p>",
        "id": 416585473,
        "sender_full_name": "Richard Copley",
        "timestamp": 1705588984
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"400544\">@Richard Copley</span>, if you were following a document that suggested using <code>lake update</code>, please tell us about it so we can hunt it down and exterminate it. But we already know that <code>lake update</code> is overly tempting, and would like to make it more obscure. :-)</p>",
        "id": 416695750,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1705632006
    },
    {
        "content": "<p>We could have a post-update hook which fails if you don't set the <code>I_AM_A_MAINTAINER_AND_KNOW_WHAT_I_AM_DOING</code> environment variable, but I think that post-update hooks run too late to prevent the change to the lake manifest</p>",
        "id": 416695966,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1705632150
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Scott Morrison</span> <a href=\"#narrow/stream/113488-general/topic/The.20cache.20doesn't.20work/near/416695750\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"400544\">Richard Copley</span>, if you were following a document that suggested using <code>lake update</code>, please tell us about it so we can hunt it down and exterminate it. But we already know that <code>lake update</code> is overly tempting, and would like to make it more obscure. :-)</p>\n</blockquote>\n<p>I have the recipe above in a shell script. If I recall correctly those instructions were on <a href=\"https://leanprover-community.github.io/install/project.html\">Using Lake (build system)</a>, but that was days and days ago <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span>. The script seems to make sense and to work for my <em>projects</em> (assuming I want to update the dependencies to the commits specified in the toplevel <code>lakefile.lean</code>, which usually I do). I was applying it in the wrong situation, but until recently I seem to have got away with that for the most part.</p>",
        "id": 416697058,
        "sender_full_name": "Richard Copley",
        "timestamp": 1705632877
    },
    {
        "content": "<p>Is it just me or does the cache not work? I don't have a good repro, but it seems related to the recent update of the vscode extension</p>",
        "id": 434512347,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1713627706
    },
    {
        "content": "<p>Eg <code>lake exe cache get</code> gets cache for <code>Algebra.AddConstMap</code>, but you still have to rebuild files</p>",
        "id": 434512642,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1713627798
    },
    {
        "content": "<p>Haven't seen it, but also haven't updated the extension that I noticed</p>",
        "id": 434514361,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1713629226
    },
    {
        "content": "<p>Working fine for me.</p>",
        "id": 434540783,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713654641
    },
    {
        "content": "<p>It keeps on happening for me!</p>",
        "id": 434914838,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1713855225
    },
    {
        "content": "<p>Sadly I can't actually try from scratch because I can't delete the <code>.lake</code> folder on Gitpod anymore? <span aria-label=\"face with raised eyebrow\" class=\"emoji emoji-1f928\" role=\"img\" title=\"face with raised eyebrow\">:face_with_raised_eyebrow:</span> Is this expected?</p>",
        "id": 434914983,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1713855267
    },
    {
        "content": "<p>Is the problem that you accidentally made <code>.lake</code> read-only?</p>",
        "id": 434925890,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1713859089
    },
    {
        "content": "<p>How would I have done that?</p>",
        "id": 434926020,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1713859126
    },
    {
        "content": "<p><code>lake exe cache get!</code> does seem to fix my non-working cache sometimes</p>",
        "id": 434926068,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1713859147
    },
    {
        "content": "<p>I have had something similar, where after <code>lake exe cache get</code>, running <code>lake build</code> starts building somewhere low.  I found that after <code>rm -rf .lake/build/lib/Mathlib/*</code>, I can then run <code>lake exe cache get</code>, it downloads nothing and then <code>lake build</code> just works...</p>",
        "id": 434931392,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1713860903
    },
    {
        "content": "<p>Although, if you cannot remove stuff in <code>.lake</code>, this may not be too useful...</p>",
        "id": 434931448,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1713860924
    },
    {
        "content": "<p><code>chmod a-w .lake</code> or something?</p>",
        "id": 434948748,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1713866625
    },
    {
        "content": "<p>if you cannot add/remove stuff in <code>.lake</code> then neither can <code>cache</code> so this is very likely the problem</p>",
        "id": 435009646,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1713885736
    }
]