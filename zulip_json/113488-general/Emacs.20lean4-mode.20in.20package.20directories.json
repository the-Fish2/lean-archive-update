[
    {
        "content": "<p>Emacs lean4-mode and <code>lake build</code> cooperate well while editing the files of the top-level project, but visiting a file in a referenced package causes that file and all its dependencies to be rebuilt (and then rebuilt again, when returning to the top-level project). It's a pain! Anyone know why this happens, and how to work around or fix it?</p>",
        "id": 379855936,
        "sender_full_name": "Richard Copley",
        "timestamp": 1690651473
    },
    {
        "content": "<p>Yeah, I'm noticing this behavior too. It seems to have been a recent regression.</p>",
        "id": 379872380,
        "sender_full_name": "David Renshaw",
        "timestamp": 1690657220
    },
    {
        "content": "<p>If this is a recent regression, then you can try to <code>git bisect</code> it and find the offending commit.</p>",
        "id": 379898154,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1690669493
    },
    {
        "content": "<p>Great idea. But lsp-mode, lean4-mode and Lean 4 itself all change rapidly enough that finding compatible combinations is not a simple matter. I tried quite hard to get a bisection to work (I won't bore you with the details), and in my judgement it's not worth trying harder. It would be easier to get to the bottom of this the old-fashioned way, by understanding what goes wrong. At a guess, it's the lean4-mode developers who are best placed to do that, assuming they're interested.</p>",
        "id": 379921818,
        "sender_full_name": "Richard Copley",
        "timestamp": 1690682729
    },
    {
        "content": "<p>I believe the regression was in mathlib/lake/lean4, not in lean4-mode</p>",
        "id": 379924119,
        "sender_full_name": "David Renshaw",
        "timestamp": 1690684206
    },
    {
        "content": "<p>Do you know if there is a similar issue in VS Code?</p>",
        "id": 379925216,
        "sender_full_name": "Richard Copley",
        "timestamp": 1690684967
    },
    {
        "content": "<p>The behavior I'm seeing:</p>\n<ol>\n<li>I have a project that depends on mathlib4.</li>\n<li>I run <code>git clean -xffd</code> to clear out any local cache.</li>\n<li>I run <code>lake exe cache get</code> to download oleans</li>\n<li>I run <code>lake build</code></li>\n<li>I open a file in the project in emacs. Nothing needs to get rebuilt.</li>\n<li>The file has a reference to <code>Real.tan</code>.  I jump to definition on that.</li>\n<li>Then I see LSP building a bunch of files in <code>Std</code>, <code>Qq</code> and <code>Aesop</code>, (but not in <code>Mathlib</code>). This takes maybe 20 seconds and then it finishes.</li>\n</ol>",
        "id": 379925719,
        "sender_full_name": "David Renshaw",
        "timestamp": 1690685300
    },
    {
        "content": "<p>The building that happens in step 7 is what was surprising me, but on further reflection, I'm not so sure it's a regression.</p>",
        "id": 379925759,
        "sender_full_name": "David Renshaw",
        "timestamp": 1690685333
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"400544\">@Buster</span> sounds like maybe you were seeing a behavior that's more pathological than this</p>",
        "id": 379925919,
        "sender_full_name": "David Renshaw",
        "timestamp": 1690685418
    },
    {
        "content": "<p>I have not updated my lean4-mode or other emacs packages in a while, so it's possible that your issue comes from newer versions of those.</p>",
        "id": 379926013,
        "sender_full_name": "David Renshaw",
        "timestamp": 1690685482
    },
    {
        "content": "<p>I see the same up to step 6, then visit a file in mathlib (by following a reference, or by using <code>find-file</code>), and its dependencies (in mathlib) get recompiled. Anything from a few files to a few thousand files. I'm not sure I remember a time when this didn't happen. I do keep my packages up to date.</p>",
        "id": 379927725,
        "sender_full_name": "Richard Copley",
        "timestamp": 1690686584
    },
    {
        "content": "<p>Does <code>M-x lsp-describe-session</code> indicate that lsp-mode opened a new workspace for the dependency?</p>",
        "id": 379965714,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1690706682
    },
    {
        "content": "<p>Yes, it does.</p>",
        "id": 379982247,
        "sender_full_name": "Richard Copley",
        "timestamp": 1690711379
    },
    {
        "content": "<p>That's the issue then. It's not really something lean4-mode has any influence on.</p>",
        "id": 379994346,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1690714216
    },
    {
        "content": "<p>Thanks. Perhaps another angle of approach, then. It's a minor inconvenience to have two workspaces, each with its own lake process, but it wouldn't be so bad if lake did not rebuild the unmodified sources. It uses the same toolchain and reproduces the same oleans with the same filenames. Do you know if there's a good reason for lake to behave that way? If not, maybe it can be fixed.</p>",
        "id": 380022755,
        "sender_full_name": "Richard Copley",
        "timestamp": 1690720984
    },
    {
        "content": "<p>The dependency is a valid Lake package in itself, it is not Lake's fault that the editor decided to use two independent workspace roots</p>",
        "id": 380035586,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1690723901
    },
    {
        "content": "<p>Note that there is no guarantee that the two toolchains are identical, so even with a user-wide Lake cache this could lead to rebuilds</p>",
        "id": 380036300,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1690724061
    },
    {
        "content": "<p>Here's a fix for \"lean4-mode.el\":</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/lean4-mode.el b/lean4-mode.el</span>\n<span class=\"gh\">index 30d3d15..ac71446 100644</span>\n<span class=\"gd\">--- a/lean4-mode.el</span>\n<span class=\"gi\">+++ b/lean4-mode.el</span>\n<span class=\"gu\">@@ -190,6 +190,9 @@ This will allow us to use Emacs when a repo contains multiple lean packages.\"</span>\n<span class=\"w\"> </span>  (when-let ((file-name (buffer-file-name))\n<span class=\"w\"> </span>             (root (vc-find-root (buffer-file-name)\n<span class=\"w\"> </span>                                 \"lakefile.lean\")))\n<span class=\"gi\">+    (while (let ((parent (f-parent root)))</span>\n<span class=\"gi\">+             (when (string= (f-filename parent) \"lake-packages\")</span>\n<span class=\"gi\">+               (setq root (f-parent parent)))))</span>\n<span class=\"w\"> </span>    (lsp-workspace-folders-add root)))\n\n<span class=\"w\"> </span>;; Automode List\n<span class=\"gd\">--</span>\n</code></pre></div>\n<p>After finding the nearest ancestor directory containing a lakefile, if that directory's parent is named \"lake-packages\", step up two more directories (and check again).</p>\n<p>Your list of workspace folders in <code>~/.emacs.d/.lsp-session-v1</code> likely already contains package subdirectories. Restart Emacs and delete that file.</p>",
        "id": 382441228,
        "sender_full_name": "Richard Copley",
        "timestamp": 1691355982
    },
    {
        "content": "<p>Could you please open a PR?</p>",
        "id": 382473815,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1691373921
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span>, this was <a href=\"https://github.com/leanprover-community/lean4-mode/pull/48\">#48</a>. The issue persists, and I've just added an up-to-date reproducer to the PR. Can you review it, please? No rush, obviously.</p>",
        "id": 434362017,
        "sender_full_name": "Richard Copley",
        "timestamp": 1713532969
    },
    {
        "content": "<p>Thanks! Merged</p>",
        "id": 434470820,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1713589765
    },
    {
        "content": "<p>If you have other PRs to <code>lean4-mode</code> you want to get merged fast, then please ping me here (with @ mention) on Zulip.</p>",
        "id": 434552189,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1713666773
    },
    {
        "content": "<p>Thanks!</p>",
        "id": 434581518,
        "sender_full_name": "Richard Copley",
        "timestamp": 1713698524
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"400544\">@Richard Copley</span> It looks like you know about Emacs more than I do. Recently, I tried Emacs (v30.0.50)+LSP-mod(20240501.110)+lean4-mode(<code>master</code>) on a new machine, and I'm getting the following error whenever I open a <code>.lean</code> file:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">LSP</span> <span class=\"o\">::</span> <span class=\"n\">The</span> <span class=\"n\">following</span> <span class=\"n\">servers</span> <span class=\"n\">support</span> <span class=\"n\">current</span> <span class=\"n\">file</span> <span class=\"n\">but</span> <span class=\"k\">do</span> <span class=\"n\">not</span> <span class=\"k\">have</span> <span class=\"n\">automatic</span> <span class=\"n\">installation</span><span class=\"o\">:</span> <span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">lsp</span>\n<span class=\"n\">You</span> <span class=\"n\">may</span> <span class=\"n\">find</span> <span class=\"n\">the</span> <span class=\"n\">installation</span> <span class=\"n\">instructions</span> <span class=\"n\">at</span><span class=\"bp\">&lt;...&gt;</span>\n</code></pre></div>",
        "id": 436564128,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1714593737
    },
    {
        "content": "<p>Do you know why this can appear?</p>",
        "id": 436564143,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1714593745
    },
    {
        "content": "<p>I manually run <code>(require 'lean4-mode)</code> before opening the file to make sure that it's already loaded.</p>",
        "id": 436564246,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1714593786
    },
    {
        "content": "<p>I've seen it, but not recently. If I'm remembering right, I don't think there was a bug. Some little thing, like making sure <code>elan</code> is on the path (the environment variable in the emacs process's environment, and probably also the <code>exec-path</code> elisp variable). Does <code>Meta-Shift-!</code> <code>lake --version</code> <code>RET</code> show something sensible? (It needs to be after 3.1.0. Current version is 5.0.0.)</p>\n<p>There is a strange piece of code in that remembers the path to the server in a variable <code>lean4-rootdir</code> when first starting the server. To clear the cache <code>(setq lean4-rootdir nil)</code> (or kill Emacs).</p>",
        "id": 436566621,
        "sender_full_name": "Richard Copley",
        "timestamp": 1714594871
    },
    {
        "content": "<p>That code was touched in <a href=\"https://github.com/leanprover-community/lean4-mode/pull/51\">#51</a> so if there's a bug now, that's where to look first. Let me know</p>",
        "id": 436567070,
        "sender_full_name": "Richard Copley",
        "timestamp": 1714595073
    },
    {
        "content": "<p>Indeed, <code>elan</code> was not in the PATH of <code>emacs</code> (because it was started by systemd). Thanks!</p>",
        "id": 436568402,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1714595730
    },
    {
        "content": "<p>BTW, did you ever try running Emacs+Lean on a remote repository (e.g., via tramp)?</p>",
        "id": 436568828,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1714595906
    },
    {
        "content": "<p>I'm running it in a terminal via <code>mosh</code> for now.</p>",
        "id": 436569708,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1714596237
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"214703\">Yury G. Kudryashov</span> <a href=\"#narrow/stream/113488-general/topic/Emacs.20lean4-mode.20in.20package.20directories/near/436568828\">said</a>:</p>\n<blockquote>\n<p>BTW, did you ever try running Emacs+Lean on a remote repository (e.g., via tramp)?</p>\n</blockquote>\n<p>I always assumed it wasn't worth trying, but actually it probably should be possible. It doesn't seem to work though. (That's with Emacs on Windows and a project in Linux (on WSL), via tramp and plink/ssh.) I usually work locally but if not, I use a terminal too.</p>",
        "id": 436571242,
        "sender_full_name": "Richard Copley",
        "timestamp": 1714596879
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"214703\">@Yury G. Kudryashov</span>, lean4-mode PR <a href=\"https://github.com/leanprover-community/lean4-mode/pull/64\">64</a> handles the switch to TOML config files, by searching for \"lean-toolchain\" instead of \"lakefile.lean\" when locating the project root directory, which is what the VS Code extension does I think. One could argue it's a fix for PR 48. Can you review please?</p>",
        "id": 438418598,
        "sender_full_name": "Richard Copley",
        "timestamp": 1715623187
    },
    {
        "content": "<p>Thanks! Merged.</p>",
        "id": 438460003,
        "sender_full_name": "Yury G. Kudryashov",
        "timestamp": 1715638940
    }
]