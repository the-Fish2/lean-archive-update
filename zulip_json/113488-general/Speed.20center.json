[
    {
        "content": "<p>I have a few questions reagrding the speed center (<a href=\"http://speed.lean-fro.org/\">http://speed.lean-fro.org/</a>).</p>\n<ol>\n<li>(How) can I get the comparison between two specific runs?</li>\n<li>(How) can I extract the n files that gained/lost the most in terms of either instructions or percentage? (I can sort the output of the comparison in the browser by clicking on column heads, but this does not work for the comparison column). Alternatively, is there a way to export the comparison into a csv file or similar?</li>\n</ol>\n<p>Answers would be helpful in speeding up the workflow with efforts like <a href=\"https://github.com/leanprover-community/mathlib4/pull/12778\">#12778</a>.</p>",
        "id": 437947588,
        "sender_full_name": "Michael Stoll",
        "timestamp": 1715330950
    },
    {
        "content": "<p>Extracting the diff between two particular runs requires some non-intuitive clicking around!</p>\n<p>You might like my recently written script:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">#!/</span><span class=\"n\">bin</span><span class=\"bp\">/</span><span class=\"n\">bash</span>\n\n<span class=\"bp\">#</span> <span class=\"n\">Written</span> <span class=\"kd\">by</span> <span class=\"n\">GPT</span> <span class=\"n\">at</span>\n<span class=\"bp\">#</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">chat.openai.com</span><span class=\"bp\">/</span><span class=\"n\">share</span><span class=\"bp\">/</span><span class=\"mi\">01</span><span class=\"n\">cd5ab9</span><span class=\"bp\">-</span><span class=\"mi\">077</span><span class=\"n\">f</span><span class=\"bp\">-</span><span class=\"mi\">4700</span><span class=\"bp\">-</span><span class=\"n\">be7b</span><span class=\"bp\">-</span><span class=\"mi\">771</span><span class=\"n\">fbd133de2</span>\n\n<span class=\"bp\">#</span> <span class=\"n\">URL</span> <span class=\"n\">base</span> <span class=\"n\">for</span> <span class=\"n\">requests</span>\n<span class=\"n\">base_url</span><span class=\"bp\">=</span><span class=\"s2\">\"http://speed.lean-fro.org/mathlib4\"</span>\n<span class=\"n\">commit_endpoint</span><span class=\"bp\">=</span><span class=\"s2\">\"/api/queue/commit/e7b27246-a3e6-496a-b552-ff4b45c7236e\"</span>\n<span class=\"n\">run_endpoint</span><span class=\"bp\">=</span><span class=\"s2\">\"/api/run/e7b27246-a3e6-496a-b552-ff4b45c7236e\"</span>\n\n<span class=\"bp\">#</span> <span class=\"n\">Basic</span> <span class=\"n\">auth</span> <span class=\"n\">credentials</span>\n<span class=\"n\">auth_credentials</span><span class=\"bp\">=</span><span class=\"s2\">\"admin:password-goes-here\"</span>\n\n<span class=\"bp\">#</span> <span class=\"n\">Handle</span> <span class=\"n\">command</span> <span class=\"n\">line</span> <span class=\"n\">arguments</span>\n<span class=\"k\">if</span> <span class=\"o\">[</span> <span class=\"bp\">$#</span> <span class=\"bp\">-</span><span class=\"n\">eq</span> <span class=\"mi\">0</span> <span class=\"o\">]</span><span class=\"bp\">;</span> <span class=\"k\">then</span>\n    <span class=\"bp\">#</span> <span class=\"n\">No</span> <span class=\"n\">identifiers</span> <span class=\"n\">provided</span><span class=\"o\">,</span> <span class=\"n\">use</span> <span class=\"n\">the</span> <span class=\"n\">hash</span> <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">current</span> <span class=\"n\">checkout</span>\n    <span class=\"n\">git_hashes</span><span class=\"bp\">=</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">git</span> <span class=\"n\">rev</span><span class=\"bp\">-</span><span class=\"n\">parse</span> <span class=\"n\">HEAD</span><span class=\"o\">))</span>\n<span class=\"n\">elif</span> <span class=\"o\">[</span> <span class=\"bp\">$#</span> <span class=\"bp\">-</span><span class=\"n\">eq</span> <span class=\"mi\">2</span> <span class=\"o\">]</span><span class=\"bp\">;</span> <span class=\"k\">then</span>\n    <span class=\"bp\">#</span> <span class=\"n\">Two</span> <span class=\"n\">identifiers</span> <span class=\"n\">provided</span><span class=\"o\">,</span> <span class=\"n\">special</span> <span class=\"n\">processing</span>\n    <span class=\"n\">hash1</span><span class=\"bp\">=$</span><span class=\"o\">(</span><span class=\"n\">git</span> <span class=\"n\">rev</span><span class=\"bp\">-</span><span class=\"n\">parse</span> <span class=\"s2\">\"$1\"</span><span class=\"o\">)</span>\n    <span class=\"n\">hash2</span><span class=\"bp\">=$</span><span class=\"o\">(</span><span class=\"n\">git</span> <span class=\"n\">rev</span><span class=\"bp\">-</span><span class=\"n\">parse</span> <span class=\"s2\">\"$2\"</span><span class=\"o\">)</span>\n    <span class=\"n\">git_hashes</span><span class=\"bp\">=</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"n\">hash1</span> <span class=\"bp\">$</span><span class=\"n\">hash2</span><span class=\"o\">)</span>\n\n    <span class=\"bp\">#</span> <span class=\"n\">Make</span> <span class=\"n\">the</span> <span class=\"n\">GET</span> <span class=\"n\">request</span> <span class=\"n\">and</span> <span class=\"n\">extract</span> <span class=\"n\">the</span> <span class=\"n\">run</span> <span class=\"n\">id</span> <span class=\"n\">using</span> <span class=\"n\">jq</span>\n    <span class=\"n\">response</span><span class=\"bp\">=$</span><span class=\"o\">(</span><span class=\"n\">curl</span> <span class=\"bp\">-</span><span class=\"n\">s</span> <span class=\"s2\">\"$base_url$run_endpoint?hash=$hash1\"</span> <span class=\"bp\">-</span><span class=\"n\">u</span> <span class=\"s2\">\"$auth_credentials\"</span><span class=\"o\">)</span>\n    <span class=\"n\">run_id</span><span class=\"bp\">=$</span><span class=\"o\">(</span><span class=\"n\">echo</span> <span class=\"s2\">\"$response\"</span> <span class=\"bp\">|</span> <span class=\"n\">jq</span> <span class=\"bp\">-</span><span class=\"n\">r</span> <span class=\"bp\">'.</span><span class=\"n\">run.id'</span><span class=\"o\">)</span>\n\n    <span class=\"bp\">#</span> <span class=\"n\">Print</span> <span class=\"n\">run</span> <span class=\"n\">id</span> <span class=\"n\">information</span>\n    <span class=\"n\">echo</span> <span class=\"s2\">\"Run id for #$1 is $run_id\"</span>\n\n    <span class=\"bp\">#</span> <span class=\"n\">Build</span> <span class=\"n\">and</span> <span class=\"n\">print</span> <span class=\"n\">the</span> <span class=\"n\">special</span> <span class=\"n\">URL</span>\n    <span class=\"n\">compare_url</span><span class=\"bp\">=</span><span class=\"s2\">\"$base_url/compare/$run_id/to/e7b27246-a3e6-496a-b552-ff4b45c7236e?hash2=$hash2\"</span>\n    <span class=\"n\">echo</span> <span class=\"s2\">\"Compare URL: $compare_url\"</span>\n<span class=\"k\">else</span>\n    <span class=\"bp\">#</span> <span class=\"n\">Resolve</span> <span class=\"n\">each</span> <span class=\"n\">provided</span> <span class=\"n\">identifier</span> <span class=\"n\">to</span> <span class=\"n\">its</span> <span class=\"n\">hash</span>\n    <span class=\"n\">for</span> <span class=\"n\">id</span> <span class=\"k\">in</span> <span class=\"s2\">\"$@\"</span><span class=\"bp\">;</span> <span class=\"k\">do</span>\n        <span class=\"n\">git_hashes</span><span class=\"bp\">+=</span><span class=\"o\">(</span><span class=\"bp\">$</span><span class=\"o\">(</span><span class=\"n\">git</span> <span class=\"n\">rev</span><span class=\"bp\">-</span><span class=\"n\">parse</span> <span class=\"s2\">\"$id\"</span><span class=\"o\">))</span>\n    <span class=\"n\">done</span>\n<span class=\"n\">fi</span>\n\n<span class=\"bp\">#</span> <span class=\"n\">Run</span> <span class=\"n\">the</span> <span class=\"n\">POST</span> <span class=\"n\">request</span> <span class=\"n\">for</span> <span class=\"n\">each</span> <span class=\"n\">resolved</span> <span class=\"n\">git</span> <span class=\"n\">hash</span>\n<span class=\"n\">for</span> <span class=\"n\">hash</span> <span class=\"k\">in</span> <span class=\"s2\">\"${git_hashes[@]}\"</span><span class=\"bp\">;</span> <span class=\"k\">do</span>\n    <span class=\"n\">curl</span> <span class=\"bp\">-</span><span class=\"n\">X</span> <span class=\"n\">POST</span> <span class=\"s2\">\"$base_url$commit_endpoint/$hash\"</span> <span class=\"bp\">-</span><span class=\"n\">u</span> <span class=\"s2\">\"$auth_credentials\"</span>\n    <span class=\"n\">echo</span> <span class=\"s2\">\"\"</span>  <span class=\"bp\">#</span> <span class=\"n\">This</span> <span class=\"n\">will</span> <span class=\"n\">output</span> <span class=\"n\">a</span> <span class=\"n\">new</span> <span class=\"n\">line</span> <span class=\"n\">after</span> <span class=\"n\">each</span> <span class=\"n\">curl</span> <span class=\"n\">command</span>\n<span class=\"n\">done</span>\n\n<span class=\"bp\">#</span> <span class=\"n\">Echo</span> <span class=\"n\">the</span> <span class=\"n\">URL</span> <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">queue</span> <span class=\"n\">on</span> <span class=\"n\">a</span> <span class=\"n\">new</span> <span class=\"n\">line</span>\n<span class=\"n\">echo</span> <span class=\"s2\">\"$base_url/queue\"</span>\n</code></pre></div>\n<p>Now, this will require some adaptation for people without the admin password, but the intention is:</p>\n<p><code>./speed gitid1 gitid2</code> will enqueue the named commits, and generate the URL that (some time later perhaps) will show the comparison.</p>",
        "id": 437950677,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1715332382
    },
    {
        "content": "<p>Unfortunately it appears to require an API lookup to go from two git revisions to the comparison URL, even if all the benchmarks already exist.</p>",
        "id": 437950750,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1715332419
    },
    {
        "content": "<p>If you already have the two runs open, you can just change <code>http://speed.lean-fro.org/mathlib4/run-detail/&lt;ID1&gt;</code> to <code>http://speed.lean-fro.org/mathlib4/compare/&lt;ID1&gt;/to/&lt;ID2&gt;</code>. <code>http://speed.lean-fro.org/mathlib4/api/compare/6fe7454c-&lt;ID1&gt;/to/&lt;ID2&gt;?all_values=true</code> is the corresponding JSON.</p>",
        "id": 437954974,
        "sender_full_name": "Sebastian Ullrich",
        "timestamp": 1715334401
    }
]