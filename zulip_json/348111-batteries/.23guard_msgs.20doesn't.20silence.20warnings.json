[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span> On std main I'm seeing warnings from the test files, even though they have a <code>#guard_msgs</code> that should suppress it:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Std.Tactic.GuardMsgs</span>\n\n<span class=\"sd\">/-- warning: unused variable `α` [linter.unusedVariables] -/</span>\n<span class=\"bp\">#</span><span class=\"n\">guard_msgs</span> <span class=\"k\">in</span>\n<span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"o\">:=</span> <span class=\"mi\">0</span>\n      <span class=\"c1\">-- ^ warning still given</span>\n</code></pre></div>",
        "id": 423320667,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1708921231
    },
    {
        "content": "<p>Can warnings be transmitted through the infotrees?</p>\n<p>Even if I modify <code>#guard_msgs</code> to just erase the message log entirely, that warning still gets through.</p>",
        "id": 423321889,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1708922118
    },
    {
        "content": "<p>I see the linter just logs a warning.</p>\n<p>Is this linter running more than once somehow? Once during the scope of <code>#guard_msgs</code>, and then again afterwards?</p>",
        "id": 423322201,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1708922348
    },
    {
        "content": "<p>Here's a <code>#guard_msgs</code>-free example of the problem:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"kn\">import</span> <span class=\"n\">Lean.Elab.Command</span>\n\n<span class=\"kn\">open</span> <span class=\"n\">Lean</span> <span class=\"n\">Elab</span> <span class=\"n\">Command</span>\n\n<span class=\"n\">elab</span> <span class=\"s2\">\"#without_messages \"</span> <span class=\"n\">cmd</span><span class=\"o\">:</span><span class=\"n\">command</span> <span class=\"o\">:</span> <span class=\"n\">command</span> <span class=\"bp\">=&gt;</span> <span class=\"k\">do</span>\n  <span class=\"n\">elabCommandTopLevel</span> <span class=\"n\">cmd</span>\n  <span class=\"n\">modify</span> <span class=\"k\">fun</span> <span class=\"n\">st</span> <span class=\"bp\">=&gt;</span> <span class=\"o\">{</span><span class=\"n\">st</span> <span class=\"k\">with</span> <span class=\"n\">messages</span> <span class=\"o\">:=</span> <span class=\"o\">{}}</span>\n\n<span class=\"bp\">#</span><span class=\"n\">without_messages</span>\n<span class=\"kd\">def</span> <span class=\"n\">foo</span> <span class=\"o\">(</span><span class=\"n\">α</span> <span class=\"o\">:</span> <span class=\"kt\">Type</span><span class=\"o\">)</span> <span class=\"o\">:</span> <span class=\"n\">Nat</span> <span class=\"o\">:=</span> <span class=\"mi\">0</span>\n      <span class=\"c1\">-- ^ warning still given</span>\n</code></pre></div>",
        "id": 423323096,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1708923009
    },
    {
        "content": "<p>Changing that to <code>modify fun st =&gt; {st with messages := {}, infoState := {}}</code> suppresses it, so I guess there are messages in the infoState? (Edit: or maybe that just unlinks the messages from a source position, causing them to not display?)</p>",
        "id": 423323178,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1708923081
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"306601\">Kyle Miller</span> <a href=\"#narrow/stream/348111-std4/topic/.23guard_msgs.20doesn't.20silence.20warnings/near/423322201\">said</a>:</p>\n<blockquote>\n<p>Is this linter running more than once somehow? Once during the scope of <code>#guard_msgs</code>, and then again afterwards?</p>\n</blockquote>\n<p>This was very close, but I didn't understand until Sebastian pointed out the issue. <code>#guard_msgs</code> is itself a command, so it gets linted. This explains why clearing the infoState suppresses the error: the unused variables linter makes use of the info trees.</p>\n<p>There are a couple solutions:</p>\n<ol>\n<li>register an <code>unusedVariablesIgnoreFn</code> for <code>#guard_msgs</code>.</li>\n<li>somehow design a protocol to have commands be able to turn off the <code>runLinters</code> call after they run.</li>\n</ol>",
        "id": 423534679,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1709011210
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"306601\">@Kyle Miller</span>, could you spell out a bit more what option 1. means?</p>",
        "id": 433633940,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713318526
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> <a href=\"https://github.com/leanprover/lean4/pull/3931\">lean4#3931</a></p>",
        "id": 433640929,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1713323840
    },
    {
        "content": "<p>It would be better to figure out the right way to make <code>#guard_msgs</code> not be subject to linters, but in the meantime fixing how it interacts with the unused variables linter would be a big help.</p>",
        "id": 433641928,
        "sender_full_name": "Kyle Miller",
        "timestamp": 1713324590
    },
    {
        "content": "<p>Great, thanks!</p>",
        "id": 433642079,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1713324660
    }
]