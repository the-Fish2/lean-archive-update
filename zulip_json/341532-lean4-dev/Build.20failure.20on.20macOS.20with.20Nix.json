[
    {
        "content": "<p>Has anyone else encountered this issue while building the target <code>.#packages.x86_64-darwin.leanc</code> in recent commits using Nix on macOS? </p>\n<p>The <a href=\"https://github.com/leanprover/lean4/issues/3810\">issue</a> occurred with invalid linker flags for the target <code>libInit_shared</code>.<br>\nI have a <a href=\"https://github.com/leanprover/lean4/pull/3811\">draft PR here</a> that doesn't completely solve the problem.</p>\n<p>I think it has something to do with the linker flags while building <code>libInit.a</code> because the log shows this warning when building <code>libInit_shared</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">leanc</span><span class=\"bp\">&gt;</span> <span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"n\">directory</span> <span class=\"n\">not</span> <span class=\"n\">found</span> <span class=\"n\">for</span> <span class=\"n\">option</span> <span class=\"bp\">'-</span><span class=\"n\">L</span><span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">v2y691apvl5y0crkwlzvpfkplvh09qx2</span><span class=\"bp\">-</span><span class=\"n\">lean</span><span class=\"bp\">-</span><span class=\"n\">bin</span><span class=\"bp\">-</span><span class=\"n\">tools</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">lean'</span>\n<span class=\"n\">leanc</span><span class=\"bp\">&gt;</span> <span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"n\">ignoring</span> <span class=\"n\">file</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">m5mkq2bbq66z4xxyzprr39nlx80dbl0a</span><span class=\"bp\">-</span><span class=\"n\">Lean</span><span class=\"bp\">-</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libLean.a</span><span class=\"o\">,</span> <span class=\"n\">building</span> <span class=\"n\">for</span> <span class=\"n\">macOS</span><span class=\"bp\">-</span><span class=\"n\">x86_64</span> <span class=\"n\">but</span> <span class=\"n\">attempting</span> <span class=\"n\">to</span> <span class=\"n\">link</span> <span class=\"k\">with</span> <span class=\"n\">file</span> <span class=\"n\">built</span> <span class=\"n\">for</span> <span class=\"n\">unknown</span><span class=\"bp\">-</span><span class=\"n\">unsupported</span> <span class=\"n\">file</span> <span class=\"n\">format</span> <span class=\"o\">(</span> <span class=\"mi\">0x21</span> <span class=\"mi\">0x3C</span> <span class=\"mi\">0x74</span> <span class=\"mi\">0x68</span> <span class=\"mi\">0x69</span> <span class=\"mi\">0x6E</span> <span class=\"mi\">0x3E</span> <span class=\"mi\">0x0A</span> <span class=\"mi\">0x2F</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"o\">)</span>\n<span class=\"n\">leanc</span><span class=\"bp\">&gt;</span> <span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"n\">ignoring</span> <span class=\"n\">file</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">xdzls0mjd8y2nb2fasrb8xlbyp3l9fx0</span><span class=\"bp\">-</span><span class=\"n\">Lake</span><span class=\"bp\">-</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libLake.a</span><span class=\"o\">,</span> <span class=\"n\">building</span> <span class=\"n\">for</span> <span class=\"n\">macOS</span><span class=\"bp\">-</span><span class=\"n\">x86_64</span> <span class=\"n\">but</span> <span class=\"n\">attempting</span> <span class=\"n\">to</span> <span class=\"n\">link</span> <span class=\"k\">with</span> <span class=\"n\">file</span> <span class=\"n\">built</span> <span class=\"n\">for</span> <span class=\"n\">unknown</span><span class=\"bp\">-</span><span class=\"n\">unsupported</span> <span class=\"n\">file</span> <span class=\"n\">format</span> <span class=\"o\">(</span> <span class=\"mi\">0x21</span> <span class=\"mi\">0x3C</span> <span class=\"mi\">0x74</span> <span class=\"mi\">0x68</span> <span class=\"mi\">0x69</span> <span class=\"mi\">0x6E</span> <span class=\"mi\">0x3E</span> <span class=\"mi\">0x0A</span> <span class=\"mi\">0x2F</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"o\">)</span>\n<span class=\"n\">leanc</span><span class=\"bp\">&gt;</span> <span class=\"n\">ld</span><span class=\"o\">:</span> <span class=\"n\">warning</span><span class=\"o\">:</span> <span class=\"n\">ignoring</span> <span class=\"n\">file</span> <span class=\"bp\">/</span><span class=\"n\">nix</span><span class=\"bp\">/</span><span class=\"n\">store</span><span class=\"bp\">/</span><span class=\"n\">n8pzs12zzpd55h7zff6xqss0nv0dckmk</span><span class=\"bp\">-</span><span class=\"n\">Init</span><span class=\"bp\">-</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">libInit.a</span><span class=\"o\">,</span> <span class=\"n\">building</span> <span class=\"n\">for</span> <span class=\"n\">macOS</span><span class=\"bp\">-</span><span class=\"n\">x86_64</span> <span class=\"n\">but</span> <span class=\"n\">attempting</span> <span class=\"n\">to</span> <span class=\"n\">link</span> <span class=\"k\">with</span> <span class=\"n\">file</span> <span class=\"n\">built</span> <span class=\"n\">for</span> <span class=\"n\">unknown</span><span class=\"bp\">-</span><span class=\"n\">unsupported</span> <span class=\"n\">file</span> <span class=\"n\">format</span> <span class=\"o\">(</span> <span class=\"mi\">0x21</span> <span class=\"mi\">0x3C</span> <span class=\"mi\">0x74</span> <span class=\"mi\">0x68</span> <span class=\"mi\">0x69</span> <span class=\"mi\">0x6E</span> <span class=\"mi\">0x3E</span> <span class=\"mi\">0x0A</span> <span class=\"mi\">0x2F</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"mi\">0x20</span> <span class=\"o\">)</span>\n</code></pre></div>\n<p>The build failure occurs further downstream when building <code>leanc</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">leanc</span><span class=\"bp\">&gt;</span> <span class=\"n\">Undefined</span> <span class=\"n\">symbols</span> <span class=\"n\">for</span> <span class=\"n\">architecture</span> <span class=\"n\">x86_64</span><span class=\"o\">:</span>\n<span class=\"n\">leanc</span><span class=\"bp\">&gt;</span>   <span class=\"s2\">\"_initialize_Init\"</span><span class=\"o\">,</span> <span class=\"n\">referenced</span> <span class=\"k\">from</span><span class=\"o\">:</span>\n<span class=\"n\">leanc</span><span class=\"bp\">&gt;</span>       <span class=\"n\">_initialize_Leanc</span> <span class=\"k\">in</span> <span class=\"n\">Leanc.o</span>\n<span class=\"n\">leanc</span><span class=\"bp\">&gt;</span>   <span class=\"s2\">\"_initialize_Lean_Compiler_FFI\"</span><span class=\"o\">,</span> <span class=\"n\">referenced</span> <span class=\"k\">from</span><span class=\"o\">:</span>\n<span class=\"n\">leanc</span><span class=\"bp\">&gt;</span>       <span class=\"n\">_initialize_Leanc</span> <span class=\"k\">in</span> <span class=\"n\">Leanc.o</span>\n<span class=\"bp\">...</span>\n</code></pre></div>\n<p>but I think its a issue because the undefined symbols such as <code>_initialize_Init</code> indeed shows up in <code>libInit.a</code></p>",
        "id": 430633545,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1711992435
    },
    {
        "content": "<p>The split of <code>leanshared</code> into <code>libInit_shared</code> and <code>leanshared</code> happened on <a href=\"https://github.com/leanprover/lean4/commit/8193af33e397ed3452ba8ab071014625d0ed53a7\">this commit</a> by Sebastian</p>",
        "id": 430646070,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1711997322
    },
    {
        "content": "<p>I've fixed most of the missing symbol errors except for this one: <code>_lean_initialize</code></p>",
        "id": 431845228,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1712546676
    },
    {
        "content": "<p>I'm stuck. I tried to mimic the <code>packages.nix</code> file before Sebastian's change but it still could not compile</p>",
        "id": 433359931,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1713205969
    },
    {
        "content": "<p>I fixed it!: <a href=\"https://github.com/leanprover/lean4/pull/3811\">https://github.com/leanprover/lean4/pull/3811</a></p>",
        "id": 447639154,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1719544694
    },
    {
        "content": "<p>if you're a macOS nix user please try this branch out and see if it works. It compiles on my machine</p>",
        "id": 447639187,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1719544722
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"599027\">@Leni Aniva</span> works for me!</p>",
        "id": 447715998,
        "sender_full_name": "Wojciech Nawrocki",
        "timestamp": 1719567552
    },
    {
        "content": "<p>merged into master. Hopefully we get this patch in 4.9.0</p>",
        "id": 447920637,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1719635067
    },
    {
        "content": "<p>This will land in v4.10.0-rc1, which Mathlib will (hopefully) move to in a few days.</p>",
        "id": 447934676,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719642048
    },
    {
        "content": "<p>(Although I guess since it only touches nix configuration, I can backport it if someone tells me it is valuable!)</p>",
        "id": 447934717,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719642098
    },
    {
        "content": "<p>(done)</p>",
        "id": 447938273,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1719643891
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/341532-lean4-dev/topic/Build.20failure.20on.20macOS.20with.20Nix/near/447934717\">said</a>:</p>\n<blockquote>\n<p>(Although I guess since it only touches nix configuration, I can backport it if someone tells me it is valuable!)</p>\n</blockquote>\n<p>did you backport it? Its very useful for us using macOS</p>",
        "id": 448200614,
        "sender_full_name": "Leni Aniva",
        "timestamp": 1719799104
    },
    {
        "content": "<p>I didn't, sorry.</p>",
        "id": 448204742,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719800284
    }
]