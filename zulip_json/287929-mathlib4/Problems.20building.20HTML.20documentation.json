[
    {
        "content": "<p>Dear all, </p>\n<p>I would like to improve the Mathlib4 documentation a bit, but I am running into trouble. According to <a href=\"https://github.com/leanprover-community/mathlib4\">https://github.com/leanprover-community/mathlib4</a> I can build HTML documentation (and thereby see my changes) using</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Kdoc</span><span class=\"bp\">=</span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"o\">:</span><span class=\"n\">docs</span>\n</code></pre></div>\n<p>but that does not work:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">error</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">unknown</span><span class=\"w\"> </span><span class=\"n\">library</span><span class=\"w\"> </span><span class=\"n\">facet</span><span class=\"w\"> </span><span class=\"ss\">`docs</span><span class=\"bp\">`</span>\n</code></pre></div>\n<p>I would be grateful for any hint or advice.</p>\n<p>Best,</p>\n<p>Stefan.</p>",
        "id": 446780321,
        "sender_full_name": "Stefan Kebekus",
        "timestamp": 1719293273
    },
    {
        "content": "<p>The html documentation files are autogenerated from the Mathlib source code.  So, usually, improving the documentation means modifying the doc-strings.  Is this what you are trying to do?</p>",
        "id": 446787921,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1719296265
    },
    {
        "content": "<p>In particular, you should not need to build the docs locally, but directly edit the <code>.lean</code> files and then a bot refreshes the documentation on a schedule.</p>",
        "id": 446788040,
        "sender_full_name": "Damiano Testa",
        "timestamp": 1719296313
    },
    {
        "content": "<p>On this subject, the README is wrong about updating dependencies in Mathlib. It currently says:</p>\n<blockquote>\n<p>If you are a mathlib contributor and want to update dependencies, use <code>lake update -Kdoc=on</code>. This will update the <code>lake-manifest.json</code> file correctly. You will need to make a PR after committing the changes to this file.</p>\n</blockquote>\n<p>But one should <em>not</em> include <code>-Kdoc=on</code> here, because we do not keep the doc-gen dependencies in our lake-manifest.json, because only automatic processes should ever be running doc-gen!</p>",
        "id": 446790158,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719297216
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14109\">#14109</a></p>",
        "id": 446790547,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719297371
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"679664\">@Stefan Kebekus</span>, I agree with <span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span>'s response that probably you should not be running doc-gen yourself: it's unnecessary and better left to automation, unless you are changing specific things about the layout or behaviour of the documentation pages, rather than just the content.</p>",
        "id": 446790679,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719297431
    },
    {
        "content": "<p>I think it would be helpful if there was an easy way to check that your documentation changes render as expected, though</p>",
        "id": 446791304,
        "sender_full_name": "Ruben Van de Velde",
        "timestamp": 1719297693
    },
    {
        "content": "<p>That said, I'm guessing the instructions are mean to actually be:</p>\n<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">R</span><span class=\"w\"> </span><span class=\"bp\">-</span><span class=\"n\">Kdoc</span><span class=\"bp\">=</span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">update</span><span class=\"w\"> </span><span class=\"n\">doc</span><span class=\"bp\">-</span><span class=\"n\">gen4</span>\n<span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"o\">:</span><span class=\"n\">docs</span>\n</code></pre></div>\n<p>(but then make sure <em>not</em> to commit your <code>lake-manifest.json</code> in your next commit!)</p>",
        "id": 446791315,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719297701
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"321459\">@Damiano Testa</span> <span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> Thank you, as always, for the quick and helpful replies. </p>\n<p>I understand from your answers that GitHub will build the documentation automatically. Still, I feel that the issue should be addressed:</p>\n<ul>\n<li>There are settings [experimenting with Markdown tables] where iterations via GitHub could be lengthy and painful.</li>\n<li>Unless I made a mistake running lake [which is totally possible], I feel that the documentation in README.md should be correct or else be deleted. Perhaps we could replace the current text with a warning 'Do not try to build HTML docs yourself' and a 'Here's how to do that in GitHub'?</li>\n</ul>\n<p>What do you think? Does that make sense?</p>",
        "id": 446791321,
        "sender_full_name": "Stefan Kebekus",
        "timestamp": 1719297704
    },
    {
        "content": "<p>Our messages passed each other. :-) I'm just running those commands now, and once I see how long they take to run I will update the README.</p>",
        "id": 446791447,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719297744
    },
    {
        "content": "<p>I have to run away now, but should be back in the evening.</p>",
        "id": 446791529,
        "sender_full_name": "Stefan Kebekus",
        "timestamp": 1719297784
    },
    {
        "content": "<p>Unfortunately it will still be pretty lengthy and painful running locally. Building the docs is a nontrivial task, from what I understand greater than just building mathlib from scratch, so &gt;20minutes even on a big machine.</p>",
        "id": 446791578,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719297809
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307953\">Ruben Van de Velde</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Problems.20building.20HTML.20documentation/near/446791304\">said</a>:</p>\n<blockquote>\n<p>I think it would be helpful if there was an easy way to check that your documentation changes render as expected, though</p>\n</blockquote>\n<p><a href=\"https://observablehq.com/@bryangingechen/github-lean-doc-preview?collection=@bryangingechen/lean\">Bryan's Observable notebook</a> is a thing, but for Lean 3 currently. It should still be mostly accurate</p>",
        "id": 446792019,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1719297975
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Kim Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Problems.20building.20HTML.20documentation/near/446791578\">said</a>:</p>\n<blockquote>\n<p>Unfortunately it will still be pretty lengthy and painful running locally. Building the docs is a nontrivial task, from what I understand greater than just building mathlib from scratch, so &gt;20minutes even on a big machine.</p>\n</blockquote>\n<p>Mathlib takes less than 20 minutes to compile on a big machine? The current run times for doc-gen in its CI are round about 12 min</p>",
        "id": 446800424,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1719301079
    },
    {
        "content": "<p>Oh and of course note that thanks to lake doc-gen gets incremental builds for free so I would at least hope that rebuilds that only change individual files are fast.</p>",
        "id": 446804664,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1719302491
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Lean4\"><pre><span></span><code><span class=\"n\">lake</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"n\">Mathlib</span><span class=\"o\">:</span><span class=\"n\">docs</span><span class=\"w\">  </span><span class=\"mf\">21147.62</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">user</span><span class=\"w\"> </span><span class=\"mf\">4743.04</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">system</span><span class=\"w\"> </span><span class=\"mi\">1901</span><span class=\"bp\">%</span><span class=\"w\"> </span><span class=\"n\">cpu</span><span class=\"w\"> </span><span class=\"mi\">22</span><span class=\"o\">:</span><span class=\"mf\">41.92</span><span class=\"w\"> </span><span class=\"n\">total</span>\n</code></pre></div>",
        "id": 446805147,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719302641
    },
    {
        "content": "<p>Sad, maybe Apple Silicon and doc-gen don't like each other.</p>",
        "id": 446805307,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719302679
    },
    {
        "content": "<p>I based my time on this one <a href=\"https://github.com/leanprover-community/mathlib4_docs/actions/runs/9654318504/job/26628315358\">https://github.com/leanprover-community/mathlib4_docs/actions/runs/9654318504/job/26628315358</a>, maybe that machine is just fancier than yours <span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span></p>",
        "id": 446805402,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1719302701
    },
    {
        "content": "<p>Note that the <code>lake -R -Kdoc=on update doc-gen4</code> command required to setup doc-gen4 locally means that you can't use a cache from CI and have to do a local build.</p>",
        "id": 446805469,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719302721
    },
    {
        "content": "<p>Somehow that is not happening in the CI run you linked to, however...?</p>",
        "id": 446805697,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719302782
    },
    {
        "content": "<p>Ah yes, the CI cleverly cheats around that by creating a project that requires mathlib instead of playing with the conditional dependencies in mathlib's lakefile.</p>",
        "id": 446805752,
        "sender_full_name": "Henrik Böving",
        "timestamp": 1719302802
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/14114\">#14114</a> fixes the README</p>",
        "id": 446819036,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1719306357
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110087\">@Kim Morrison</span> Thank you for fixing this. With your help, I could generate the documentation and submit my first documentation-improving PR today.</p>",
        "id": 447151787,
        "sender_full_name": "Stefan Kebekus",
        "timestamp": 1719389426
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"387244\">@Yaël Dillies</span> <a href=\"https://observablehq.com/@bryangingechen/github-lean-doc-preview?collection=@bryangingechen/lean\">Bryan's Observable notebook</a> did indeed work well for me. Thank you for the link.</p>",
        "id": 447151878,
        "sender_full_name": "Stefan Kebekus",
        "timestamp": 1719389459
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"679664\">Stefan Kebekus</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Problems.20building.20HTML.20documentation/near/447151878\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"387244\">Yaël Dillies</span> <a href=\"https://observablehq.com/@bryangingechen/github-lean-doc-preview?collection=@bryangingechen/lean\">Bryan's Observable notebook</a> did indeed work well for me. Thank you for the link.</p>\n</blockquote>\n<p>Glad to hear the notebook is still useful!</p>\n<p>Be advised that there may be differences between how doc-gen4 processes LaTeX in markdown and how the notebook works. When development of doc-gen4 has stabilized, I'm planning to create a lean4 version of the notebook at some point but until then make sure to double-check the generated output (especially for LaTeX) on the mathlib4_docs page or a local build.</p>\n<p>Feel free to ping me if you notice any discrepancies, of course.</p>",
        "id": 447210329,
        "sender_full_name": "Bryan Gin-ge Chen",
        "timestamp": 1719406054
    }
]