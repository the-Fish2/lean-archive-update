[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"110049\">@Mario Carneiro</span> It's most likely the Std bump that causes the slowdown</p>\n<p>Testing on <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/7574508760\">https://github.com/leanprover-community/mathlib4/actions/runs/7574508760</a> took 1m 14s<br>\nTesting on the immediately succeeding bump <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/7577745057\">https://github.com/leanprover-community/mathlib4/actions/runs/7577745057</a> took 3m 34s</p>",
        "id": 417549488,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1706053821
    },
    {
        "content": "<p>I'm suspecting <code>std_exact?</code></p>",
        "id": 417549744,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706053979
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover/std4/compare/1d85fd7db28700b28043d6370dd1ebc426de4d5d...1972e073b3e6bc0776ad5b544bfa7db7fc3f7c36\">https://github.com/leanprover/std4/compare/1d85fd7db28700b28043d6370dd1ebc426de4d5d...1972e073b3e6bc0776ad5b544bfa7db7fc3f7c36</a></p>",
        "id": 417549889,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706054054
    },
    {
        "content": "<p>the only thing in there which looks like it could affect performance is <a href=\"https://github.com/leanprover/std4/pull/527\">std#527</a> (cc: <span class=\"user-mention\" data-user-id=\"110087\">@Scott Morrison</span> )</p>",
        "id": 417549989,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706054133
    },
    {
        "content": "<p>Mathlib commits are d8b1dddbc5a6bbaef465befedc9ffdcc35e1a30f (before, fast) and b71c5f26d2d017eac8f6c3403db93603ce7dd95c (after, slow).</p>",
        "id": 417572374,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1706069233
    },
    {
        "content": "<p>hyperfine reports no essential timing difference in test/LibrarySearch/basic.lean between those commits.</p>",
        "id": 417572403,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1706069262
    },
    {
        "content": "<p>I'll leave hyperfine running against <code>make test</code>, but for now I'm skeptical? <span class=\"user-mention\" data-user-id=\"598052\">@Jeremy Tan</span> , has this persisted across later CI runs?</p>",
        "id": 417572562,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1706069372
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Scott Morrison</span> <a href=\"#narrow/stream/287929-mathlib4/topic/Testing.20slowdown/near/417572562\">said</a>:</p>\n<blockquote>\n<p>has this persisted across later CI runs?</p>\n</blockquote>\n<p>Yes: in the latest staging commit <a href=\"https://github.com/leanprover-community/mathlib4/actions/runs/7635237217/job/20800326296\">https://github.com/leanprover-community/mathlib4/actions/runs/7635237217/job/20800326296</a> testing took 4 minutes</p>",
        "id": 417577373,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1706073384
    },
    {
        "content": "<p>maybe we should print the results of <code>time lake env lean</code> to the logs</p>",
        "id": 417577587,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1706073589
    },
    {
        "content": "<p>hyperfine confirms it is real:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"n\">kim</span><span class=\"bp\">@</span><span class=\"n\">carica</span> <span class=\"n\">mathlib4</span><span class=\"bp\">-</span><span class=\"mi\">2</span> <span class=\"bp\">%</span> <span class=\"n\">git</span> <span class=\"n\">checkout</span> <span class=\"n\">b71c5f26d2d017eac8f6c3403db93603ce7dd95c</span> <span class=\"bp\">&amp;&amp;</span> <span class=\"n\">lake</span> <span class=\"n\">exe</span> <span class=\"n\">cache</span> <span class=\"n\">get</span> <span class=\"bp\">&amp;&amp;</span> <span class=\"n\">lake</span> <span class=\"n\">build</span> <span class=\"bp\">&amp;&amp;</span> <span class=\"n\">hyperfine</span> <span class=\"s2\">\"make test\"</span>\n<span class=\"n\">Previous</span> <span class=\"n\">HEAD</span> <span class=\"n\">position</span> <span class=\"n\">was</span> <span class=\"n\">d8b1dddbc5</span> <span class=\"n\">feat</span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">Ring</span><span class=\"bp\">/</span><span class=\"n\">CentroidHom</span><span class=\"o\">):</span> <span class=\"n\">central</span> <span class=\"n\">iff</span> <span class=\"n\">mul</span> <span class=\"n\">op</span> <span class=\"n\">commute</span> <span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"mi\">8663</span><span class=\"o\">)</span>\n<span class=\"n\">HEAD</span> <span class=\"n\">is</span> <span class=\"n\">now</span> <span class=\"n\">at</span> <span class=\"n\">b71c5f26d2</span> <span class=\"n\">chore</span><span class=\"o\">:</span> <span class=\"n\">bump</span> <span class=\"n\">Std</span> <span class=\"n\">to</span> <span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">std4</span><span class=\"bp\">#</span><span class=\"mi\">541</span> <span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"mi\">9828</span><span class=\"o\">)</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">std</span><span class=\"o\">:</span> <span class=\"n\">updating</span> <span class=\"n\">repository</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">std'</span> <span class=\"n\">to</span> <span class=\"n\">revision</span> <span class=\"bp\">'</span><span class=\"mi\">1972</span><span class=\"n\">e073b3e6bc0776ad5b544bfa7db7fc3f7c36'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">aesop</span><span class=\"o\">:</span> <span class=\"n\">updating</span> <span class=\"n\">repository</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">aesop'</span> <span class=\"n\">to</span> <span class=\"n\">revision</span> <span class=\"bp\">'</span><span class=\"mi\">1</span><span class=\"n\">c638703ed1c0c42aed2687acbeda67cec801454'</span>\n<span class=\"n\">No</span> <span class=\"n\">files</span> <span class=\"n\">to</span> <span class=\"n\">download</span>\n<span class=\"n\">Decompressing</span> <span class=\"mi\">4143</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">unpacked</span> <span class=\"k\">in</span> <span class=\"mi\">3499</span> <span class=\"n\">ms</span>\n<span class=\"n\">Benchmark</span> <span class=\"mi\">1</span><span class=\"o\">:</span> <span class=\"n\">make</span> <span class=\"n\">test</span>\n  <span class=\"n\">Time</span> <span class=\"o\">(</span><span class=\"n\">mean</span> <span class=\"bp\">±</span> <span class=\"n\">σ</span><span class=\"o\">):</span>     <span class=\"mi\">296</span><span class=\"bp\">.</span><span class=\"mi\">807</span> <span class=\"n\">s</span> <span class=\"bp\">±</span>  <span class=\"mi\">1</span><span class=\"bp\">.</span><span class=\"mi\">392</span> <span class=\"n\">s</span>    <span class=\"o\">[</span><span class=\"n\">User</span><span class=\"o\">:</span> <span class=\"mi\">258</span><span class=\"bp\">.</span><span class=\"mi\">841</span> <span class=\"n\">s</span><span class=\"o\">,</span> <span class=\"n\">System</span><span class=\"o\">:</span> <span class=\"mi\">59</span><span class=\"bp\">.</span><span class=\"mi\">151</span> <span class=\"n\">s</span><span class=\"o\">]</span>\n  <span class=\"n\">Range</span> <span class=\"o\">(</span><span class=\"n\">min</span> <span class=\"bp\">…</span> <span class=\"n\">max</span><span class=\"o\">):</span>   <span class=\"mi\">295</span><span class=\"bp\">.</span><span class=\"mi\">400</span> <span class=\"n\">s</span> <span class=\"bp\">…</span> <span class=\"mi\">298</span><span class=\"bp\">.</span><span class=\"mi\">805</span> <span class=\"n\">s</span>    <span class=\"mi\">10</span> <span class=\"n\">runs</span>\n\n<span class=\"n\">kim</span><span class=\"bp\">@</span><span class=\"n\">carica</span> <span class=\"n\">mathlib4</span><span class=\"bp\">-</span><span class=\"mi\">2</span> <span class=\"bp\">%</span> <span class=\"n\">git</span> <span class=\"n\">checkout</span> <span class=\"n\">d8b1dddbc5a6bbaef465befedc9ffdcc35e1a30f</span> <span class=\"bp\">&amp;&amp;</span> <span class=\"n\">lake</span> <span class=\"n\">exe</span> <span class=\"n\">cache</span> <span class=\"n\">get</span> <span class=\"bp\">&amp;&amp;</span> <span class=\"n\">lake</span> <span class=\"n\">build</span> <span class=\"bp\">&amp;&amp;</span> <span class=\"n\">hyperfine</span> <span class=\"s2\">\"make test\"</span>\n<span class=\"n\">Previous</span> <span class=\"n\">HEAD</span> <span class=\"n\">position</span> <span class=\"n\">was</span> <span class=\"n\">b71c5f26d2</span> <span class=\"n\">chore</span><span class=\"o\">:</span> <span class=\"n\">bump</span> <span class=\"n\">Std</span> <span class=\"n\">to</span> <span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">std4</span><span class=\"bp\">#</span><span class=\"mi\">541</span> <span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"mi\">9828</span><span class=\"o\">)</span>\n<span class=\"n\">HEAD</span> <span class=\"n\">is</span> <span class=\"n\">now</span> <span class=\"n\">at</span> <span class=\"n\">d8b1dddbc5</span> <span class=\"n\">feat</span><span class=\"o\">(</span><span class=\"n\">Algebra</span><span class=\"bp\">/</span><span class=\"n\">Ring</span><span class=\"bp\">/</span><span class=\"n\">CentroidHom</span><span class=\"o\">):</span> <span class=\"n\">central</span> <span class=\"n\">iff</span> <span class=\"n\">mul</span> <span class=\"n\">op</span> <span class=\"n\">commute</span> <span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"mi\">8663</span><span class=\"o\">)</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">std</span><span class=\"o\">:</span> <span class=\"n\">updating</span> <span class=\"n\">repository</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">std'</span> <span class=\"n\">to</span> <span class=\"n\">revision</span> <span class=\"bp\">'</span><span class=\"mi\">1</span><span class=\"n\">d85fd7db28700b28043d6370dd1ebc426de4d5d'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">aesop</span><span class=\"o\">:</span> <span class=\"n\">updating</span> <span class=\"n\">repository</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">aesop'</span> <span class=\"n\">to</span> <span class=\"n\">revision</span> <span class=\"bp\">'</span><span class=\"mi\">2</span><span class=\"n\">ae78a474ddf0a39bc2afb9f9f284d2e64f48a70'</span>\n<span class=\"n\">No</span> <span class=\"n\">files</span> <span class=\"n\">to</span> <span class=\"n\">download</span>\n<span class=\"n\">Decompressing</span> <span class=\"mi\">4142</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">unpacked</span> <span class=\"k\">in</span> <span class=\"mi\">3524</span> <span class=\"n\">ms</span>\n<span class=\"n\">Benchmark</span> <span class=\"mi\">1</span><span class=\"o\">:</span> <span class=\"n\">make</span> <span class=\"n\">test</span>\n  <span class=\"n\">Time</span> <span class=\"o\">(</span><span class=\"n\">mean</span> <span class=\"bp\">±</span> <span class=\"n\">σ</span><span class=\"o\">):</span>     <span class=\"mi\">214</span><span class=\"bp\">.</span><span class=\"mi\">860</span> <span class=\"n\">s</span> <span class=\"bp\">±</span>  <span class=\"mi\">4</span><span class=\"bp\">.</span><span class=\"mi\">340</span> <span class=\"n\">s</span>    <span class=\"o\">[</span><span class=\"n\">User</span><span class=\"o\">:</span> <span class=\"mi\">176</span><span class=\"bp\">.</span><span class=\"mi\">060</span> <span class=\"n\">s</span><span class=\"o\">,</span> <span class=\"n\">System</span><span class=\"o\">:</span> <span class=\"mi\">59</span><span class=\"bp\">.</span><span class=\"mi\">337</span> <span class=\"n\">s</span><span class=\"o\">]</span>\n  <span class=\"n\">Range</span> <span class=\"o\">(</span><span class=\"n\">min</span> <span class=\"bp\">…</span> <span class=\"n\">max</span><span class=\"o\">):</span>   <span class=\"mi\">211</span><span class=\"bp\">.</span><span class=\"mi\">233</span> <span class=\"n\">s</span> <span class=\"bp\">…</span> <span class=\"mi\">222</span><span class=\"bp\">.</span><span class=\"mi\">768</span> <span class=\"n\">s</span>    <span class=\"mi\">10</span> <span class=\"n\">runs</span>\n</code></pre></div>\n<p>I'm not going to have a change to look at this until next Monday, if anyone wants to investigate!</p>",
        "id": 417593758,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1706084308
    }
]