[
    {
        "content": "<p>Uff, 10min delay for lean4checker on every mathlib CI run. Is that worth it? We don’t expect that to fail normally, do we; it’s not really checking the PR at hand, but rather hunts for bugs in <code>lean</code>/<code>lean4checker</code>?</p>\n<p>Could this be a separate CI job, running after a successful build job, that just runs <code>cache get ; lean4checker</code> so that users get the <span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span>  earlier and PRs can be merged faster? Or only run on <code>master</code>?</p>",
        "id": 411231152,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1704389324
    },
    {
        "content": "<p>In some sense it's the most important part of the process</p>",
        "id": 411231860,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704389619
    },
    {
        "content": "<p>because there is a hell of a lot of hope for the best thinking in our build tools</p>",
        "id": 411231914,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704389644
    },
    {
        "content": "<p>It's true that errors in that stage are generally errors in lean though, unless you write some adversarial code</p>",
        "id": 411232063,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704389712
    },
    {
        "content": "<p>I think it would be ideal to parallelize the linting testing and lean4checker steps, or indeed everything that is done post main build / olean creation</p>",
        "id": 411235304,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1704391059
    },
    {
        "content": "<p>I feel like it's important to run every so often but I agree it's highly unlikely to fail.</p>",
        "id": 411263515,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1704403340
    },
    {
        "content": "<p>Unfortunately parallelising a big refactor, as we can only parallelize jobs, not steps.</p>",
        "id": 411291834,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1704417881
    },
    {
        "content": "<p>(I guess we could <em>combine</em> steps into one, and do command line parallelization?)</p>",
        "id": 411291864,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1704417902
    },
    {
        "content": "<p>Using jobs is then inconvenient as we need to manually transfer the build artifacts between jobs. Even if we do this by just adding lots of calls to <code>cache get</code>, it is probably still a win. But this ugliness is why I haven't attempted this.</p>",
        "id": 411291934,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1704417953
    },
    {
        "content": "<p>I would prefer that we keep running <code>lean4checker</code> if at all possible. It very very rarely fails, but when it does we would like to know as soon as possible!</p>",
        "id": 411292047,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1704418007
    },
    {
        "content": "<p>I think the <code>cache get</code> parallelization is a reasonable approach here, though explicitly transferring the cache would be more robust to network issues</p>",
        "id": 411292421,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1704418216
    },
    {
        "content": "<p><code>cache get</code> first, and then manual transfer later if it seems helpful?</p>",
        "id": 411292910,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1704418556
    },
    {
        "content": "<p>Scott, could we just run <code>lean4checker</code> once a day on master? Or is that not frequent enough? It would save lots of CI time.</p>",
        "id": 411300831,
        "sender_full_name": "Jireh Loreaux",
        "timestamp": 1704423115
    },
    {
        "content": "<p>Where will failures go?</p>",
        "id": 411302050,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1704423852
    },
    {
        "content": "<p>To a Zulip thread, of course</p>",
        "id": 411302466,
        "sender_full_name": "Jeremy Tan",
        "timestamp": 1704424051
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"197836\">Jireh Loreaux</span> <a href=\"#narrow/stream/287929-mathlib4/topic/lean4checker.20CI.20job/near/411300831\">said</a>:</p>\n<blockquote>\n<p>Scott, could we just run <code>lean4checker</code> once a day on master? Or is that not frequent enough? It would save lots of CI time.</p>\n</blockquote>\n<p>What about running it only in staging commits?</p>",
        "id": 411302617,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704424122
    },
    {
        "content": "<p>Okay, I think I would be okay with checking master every 24 hours, particularly if someone else can implement it. :-) I agree CI is too slow still.</p>",
        "id": 411302632,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1704424133
    },
    {
        "content": "<p>I like the always-green property, as I might have mentioned in another thread :)</p>",
        "id": 411302665,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1704424155
    },
    {
        "content": "<p>Yeah I was coming on this thread to suggest just this: only run <code>lean4checker</code> on staging commits, so that we don't waste CI time in PRs.</p>",
        "id": 411324311,
        "sender_full_name": "Yaël Dillies",
        "timestamp": 1704441162
    },
    {
        "content": "<p>Why are people so worried about something taking ten minutes, out of interest?</p>",
        "id": 411335987,
        "sender_full_name": "Kevin Buzzard",
        "timestamp": 1704447659
    },
    {
        "content": "<p>For example when I have a draft PR, and I want to mark it as ready for review or merging or so, but not before I know for sure that CI is green.  I keep checking the status until it’s green.</p>\n<p>Like yesterday, when I wanted to get nightly-testing working again, a minute less CI time is a minute less until I am “done”.</p>",
        "id": 411336822,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1704448029
    },
    {
        "content": "<p>I think this is something that mergify lets me do automatically, I'll have a look into supporting something like this.</p>",
        "id": 411348704,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1704452351
    },
    {
        "content": "<p>(Joachim's workflow)</p>",
        "id": 411348714,
        "sender_full_name": "Eric Rodriguez",
        "timestamp": 1704452358
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/lean4checker.20CI.20job/near/411335987\">said</a>:</p>\n<blockquote>\n<p>Why are people so worried about something taking ten minutes, out of interest?</p>\n</blockquote>\n<p>Think <code>10 * n_total_commits * cost_per_minute_in_$</code></p>",
        "id": 411352175,
        "sender_full_name": "Arthur Paulino",
        "timestamp": 1704453831
    },
    {
        "content": "<p>That too. Also <code>* cost_per_minute_in_CO₂</code>.<br>\n(Not that it matters much next to all those AI stuff happening, I guess)</p>",
        "id": 411357835,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1704456285
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110038\">Kevin Buzzard</span> <a href=\"#narrow/stream/287929-mathlib4/topic/lean4checker.20CI.20job/near/411335987\">said</a>:</p>\n<blockquote>\n<p>Why are people so worried about something taking ten minutes, out of interest?</p>\n</blockquote>\n<p>At least for me I notice this the most when testing new features for CI itself (like reviewdog, leaff), there I often make a commit that doesn't change mathlib at all, but then I have to wait 20 minutes (for lint + testing + checker) to find out I made a typo in my script...</p>",
        "id": 411371603,
        "sender_full_name": "Alex J. Best",
        "timestamp": 1704462334
    },
    {
        "content": "<p>Testing CI features right now, so while I have a break of 10mins I thought I come back to this thread ;-)</p>",
        "id": 412591677,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1705081526
    }
]