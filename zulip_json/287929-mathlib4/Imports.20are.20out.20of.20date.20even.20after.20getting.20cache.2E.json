[
    {
        "content": "<p>Trying to work on one of my PRs, just pushed it and got a build failure. Was going to try and diagnose it but even when I do <code>lake exe cache get!</code> it tells me that the imports are out of date and must be rebuilt. But I'm getting 4080/4120 cache files. What could be going on?</p>",
        "id": 412554351,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1705069571
    },
    {
        "content": "<p>Is that <a href=\"https://github.com/leanprover-community/mathlib4/pull/9571\">#9571</a> (<a href=\"https://github.com/leanprover-community/mathlib4/tree/snoc_cons_optimise\">branch#snoc_cons_optimise</a>)?</p>",
        "id": 412555087,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1705069785
    },
    {
        "content": "<p>No, <a href=\"https://github.com/leanprover-community/mathlib4/pull/9145\">#9145</a></p>",
        "id": 412555126,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1705069800
    },
    {
        "content": "<p><a href=\"https://github.com/leanprover-community/mathlib4/pull/9571\">#9571</a> is broken but not because of a merge, I just haven't got round to fixing it yet.</p>",
        "id": 412555264,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1705069837
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 412555488,
        "sender_full_name": "Josha Dekker",
        "timestamp": 1705069917
    },
    {
        "content": "<p>I see the same thing, but \"Rebuild Imports\" takes just a second here (and needs to be done only once)</p>",
        "id": 412555814,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1705070019
    },
    {
        "content": "<p>Oh, I didn't actually press it out of fear :P</p>",
        "id": 412556004,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1705070071
    },
    {
        "content": "<p>That has crashed my computer before</p>",
        "id": 412556068,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1705070091
    },
    {
        "content": "<p>That worked. Thanks!</p>",
        "id": 412556412,
        "sender_full_name": "Wrenna Robson",
        "timestamp": 1705070200
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"330967\">Wrenna Robson</span> has marked this topic as resolved.</p>",
        "id": 412556444,
        "sender_full_name": "Notification Bot",
        "timestamp": 1705070212
    },
    {
        "content": "<p>The only thing that gets rebuilt is <code>ImportGraphs.Import</code>, and I think this is a new dependency. Maybe it isn't being cached properly?</p>",
        "id": 412556803,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1705070326
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"385895\">@Jon Eugster</span></p>",
        "id": 412556916,
        "sender_full_name": "Mauricio Collares",
        "timestamp": 1705070368
    },
    {
        "content": "<p><code>ImportGraph</code> is in another repo and its not cached at all currently. (it contains <code>lake exe graph</code> and some commands, mentioned below, which were in mathlib previously)</p>\n<p>I asked <span class=\"user-mention silent\" data-user-id=\"110524\">Scott Morrison</span> about this and he claimed there should be no problem with cache. Maybe that's not true?</p>\n<p>There's no necessity for <code>ImportGraph.Imports</code> to be imported in mathlib except for having the commands like <code>#find_home</code> and <code>#minimize_imports</code> still available in mathlib without adding the import manually.</p>\n<p>How are other projects like <code>aesop</code> or proof-widgets cached? Maybe that should be done for the import-graph too?</p>\n<p><a href=\"https://github.com/leanprover-community/import-graph\">https://github.com/leanprover-community/import-graph</a></p>",
        "id": 412722193,
        "sender_full_name": "Jon Eugster",
        "timestamp": 1705163171
    },
    {
        "content": "<p>Sorry about the bad information, <code>cache</code> does need an update.</p>",
        "id": 412772807,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1705199421
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"110087\">Scott Morrison</span> has marked this topic as unresolved.</p>",
        "id": 412772811,
        "sender_full_name": "Notification Bot",
        "timestamp": 1705199428
    },
    {
        "content": "<p>If you search for <code>aesop</code> with the <code>Cache/</code> directory of Mathlib you will find the function that needs a line added!</p>",
        "id": 412772839,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1705199453
    },
    {
        "content": "<p>This is an unfortunate consequence of <code>cache</code> being a giant (lovely, essential) hack. :-)</p>",
        "id": 412772869,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1705199485
    },
    {
        "content": "<p>why is <code>ImportGraph</code> a dependency of mathlib in the first place? surely it isn't imported by anything</p>",
        "id": 412773418,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1705199893
    },
    {
        "content": "<p>we really need dev-dependencies...</p>",
        "id": 412773485,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1705199951
    },
    {
        "content": "<p>Similarly <code>lean4-cli</code> is only used by auxiliary utilities.</p>",
        "id": 412774094,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1705200450
    },
    {
        "content": "<p>Is lean4-cli not used by <code>cache get</code>?</p>",
        "id": 412808737,
        "sender_full_name": "Eric Wieser",
        "timestamp": 1705233292
    },
    {
        "content": "<p>No, cache just handles command line arguments manually.</p>",
        "id": 412811355,
        "sender_full_name": "Kim Morrison",
        "timestamp": 1705235778
    },
    {
        "content": "<p>But <code>ImportGraph</code> <em>is</em> imported, by <code>Mathlib.Tactic.Common</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Lean\"><pre><span></span><code><span class=\"bp\">~/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"bp\">$</span> <span class=\"n\">git</span> <span class=\"n\">log</span> <span class=\"bp\">-</span><span class=\"n\">n</span> <span class=\"mi\">1</span>\n<span class=\"n\">commit</span> <span class=\"mi\">5964134838</span><span class=\"n\">f12fb0ea6fde72764f6d985c312842</span> <span class=\"o\">(</span><span class=\"n\">HEAD</span> <span class=\"bp\">-&gt;</span> <span class=\"n\">master</span><span class=\"o\">,</span> <span class=\"n\">origin</span><span class=\"bp\">/</span><span class=\"n\">staging</span><span class=\"o\">,</span> <span class=\"n\">origin</span><span class=\"bp\">/</span><span class=\"n\">master</span><span class=\"o\">,</span> <span class=\"n\">origin</span><span class=\"bp\">/</span><span class=\"n\">HEAD</span><span class=\"o\">)</span>\n<span class=\"n\">Author</span><span class=\"o\">:</span> <span class=\"n\">Kyle</span> <span class=\"n\">Miller</span> <span class=\"bp\">&lt;</span><span class=\"n\">kmill31415</span><span class=\"bp\">@</span><span class=\"n\">gmail.com</span><span class=\"bp\">&gt;</span>\n<span class=\"n\">Date</span><span class=\"o\">:</span>   <span class=\"n\">Mon</span> <span class=\"n\">Jan</span> <span class=\"mi\">15</span> <span class=\"mi\">11</span><span class=\"o\">:</span><span class=\"mi\">29</span><span class=\"o\">:</span><span class=\"mi\">49</span> <span class=\"mi\">2024</span> <span class=\"bp\">+</span><span class=\"mi\">0000</span>\n\n    <span class=\"n\">refactor</span><span class=\"o\">:</span> <span class=\"n\">make</span> <span class=\"bp\">`</span><span class=\"n\">SimpleGraph.chromaticNumber</span><span class=\"bp\">`</span> <span class=\"n\">be</span> <span class=\"bp\">`</span><span class=\"n\">ENat</span><span class=\"bp\">`-</span><span class=\"n\">valued</span> <span class=\"o\">(</span><span class=\"bp\">#</span><span class=\"mi\">8883</span><span class=\"o\">)</span>\n\n    <span class=\"n\">This</span> <span class=\"n\">removes</span> <span class=\"n\">an</span> <span class=\"n\">awkwardness</span> <span class=\"n\">of</span> <span class=\"n\">the</span> <span class=\"n\">API</span><span class=\"o\">,</span> <span class=\"n\">where</span> <span class=\"n\">theorems</span> <span class=\"n\">had</span> <span class=\"n\">to</span> <span class=\"kn\">include</span> <span class=\"n\">colorability</span> <span class=\"n\">hypotheses.</span> <span class=\"n\">This</span> <span class=\"n\">trades</span> <span class=\"n\">that</span> <span class=\"n\">awkwardness</span> <span class=\"n\">for</span> <span class=\"n\">a</span> <span class=\"n\">smaller</span> <span class=\"n\">one</span><span class=\"o\">,</span> <span class=\"n\">which</span> <span class=\"n\">is</span> <span class=\"n\">that</span> <span class=\"n\">one</span> <span class=\"n\">writes</span> <span class=\"bp\">`</span><span class=\"n\">G.Colorable</span> <span class=\"o\">(</span><span class=\"n\">ENat.toNat</span> <span class=\"n\">G.chromaticNumber</span><span class=\"o\">)</span><span class=\"bp\">`</span> <span class=\"n\">rather</span> <span class=\"n\">than</span> <span class=\"bp\">`</span><span class=\"n\">G.Colorable</span> <span class=\"n\">G.chromaticNumber</span><span class=\"bp\">`.</span>\n\n    <span class=\"n\">It</span> <span class=\"n\">would</span> <span class=\"n\">be</span> <span class=\"n\">good</span> <span class=\"n\">to</span> <span class=\"k\">have</span> <span class=\"n\">a</span> <span class=\"n\">followup</span> <span class=\"n\">refactoring</span> <span class=\"n\">PR</span> <span class=\"n\">to</span> <span class=\"n\">more</span> <span class=\"n\">carefully</span> <span class=\"n\">evaluate</span> <span class=\"n\">the</span> <span class=\"n\">API</span> <span class=\"n\">after</span> <span class=\"n\">this</span> <span class=\"n\">change.</span>\n\n<span class=\"bp\">~/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"bp\">$</span> <span class=\"n\">rm</span> <span class=\"bp\">-</span><span class=\"n\">rf</span> <span class=\"bp\">.</span><span class=\"n\">lake</span>\n<span class=\"bp\">~/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"bp\">$</span> <span class=\"n\">lake</span> <span class=\"n\">exec</span> <span class=\"n\">cache</span> <span class=\"n\">unpack</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">Cli</span><span class=\"o\">:</span> <span class=\"n\">cloning</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github.com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">/</span><span class=\"n\">lean4</span><span class=\"bp\">-</span><span class=\"n\">cli</span> <span class=\"n\">to</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">Cli'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"n\">importGraph</span><span class=\"o\">:</span> <span class=\"n\">cloning</span> <span class=\"n\">https</span><span class=\"o\">:</span><span class=\"bp\">//</span><span class=\"n\">github.com</span><span class=\"bp\">/</span><span class=\"n\">leanprover</span><span class=\"bp\">-</span><span class=\"n\">community</span><span class=\"bp\">/</span><span class=\"kn\">import</span><span class=\"bp\">-</span><span class=\"n\">graph.git</span> <span class=\"n\">to</span> <span class=\"bp\">'./.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">importGraph'</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Downloading</span> <span class=\"n\">proofwidgets</span> <span class=\"n\">cloud</span> <span class=\"n\">release</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">0</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Unpacking</span> <span class=\"n\">proofwidgets</span> <span class=\"n\">cloud</span> <span class=\"n\">release</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Cache.IO</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">Cache.IO</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">2</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Cache.Hashing</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">Cache.Hashing</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">3</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Cache.Requests</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">Cache.Requests</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">4</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">Cache.Main</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">6</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Compiling</span> <span class=\"n\">Cache.Main</span>\n<span class=\"n\">info</span><span class=\"o\">:</span> <span class=\"o\">[</span><span class=\"mi\">9</span><span class=\"bp\">/</span><span class=\"mi\">9</span><span class=\"o\">]</span> <span class=\"n\">Linking</span> <span class=\"n\">cache</span>\n<span class=\"n\">Decompressing</span> <span class=\"mi\">4120</span> <span class=\"n\">file</span><span class=\"o\">(</span><span class=\"n\">s</span><span class=\"o\">)</span>\n<span class=\"n\">unpacked</span> <span class=\"k\">in</span> <span class=\"mi\">7537</span> <span class=\"n\">ms</span>\n<span class=\"bp\">~/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"bp\">$</span> <span class=\"n\">ls</span> <span class=\"bp\">.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">importGraph</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">ImportGraph</span><span class=\"bp\">/</span><span class=\"n\">Imports.olean</span>\n<span class=\"n\">ls</span><span class=\"o\">:</span> <span class=\"n\">Zugriff</span> <span class=\"n\">auf</span> <span class=\"bp\">'.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">packages</span><span class=\"bp\">/</span><span class=\"n\">importGraph</span><span class=\"bp\">/.</span><span class=\"n\">lake</span><span class=\"bp\">/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lib</span><span class=\"bp\">/</span><span class=\"n\">ImportGraph</span><span class=\"bp\">/</span><span class=\"n\">Imports.olean'</span> <span class=\"n\">nicht</span> <span class=\"n\">m</span><span class=\"bp\">ö</span><span class=\"n\">glich</span><span class=\"o\">:</span> <span class=\"n\">No</span> <span class=\"n\">such</span> <span class=\"n\">file</span> <span class=\"n\">or</span> <span class=\"n\">directory</span>\n<span class=\"bp\">~/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"bp\">$</span> <span class=\"n\">find</span> <span class=\"n\">Imports.olean</span>\n<span class=\"n\">find</span><span class=\"o\">:</span> <span class=\"bp\">‘</span><span class=\"n\">Imports.olean</span><span class=\"bp\">’</span><span class=\"o\">:</span> <span class=\"n\">No</span> <span class=\"n\">such</span> <span class=\"n\">file</span> <span class=\"n\">or</span> <span class=\"n\">directory</span>\n<span class=\"bp\">~/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"bp\">$</span> <span class=\"n\">git</span> <span class=\"n\">grep</span> <span class=\"n\">ImportGraph</span>\n<span class=\"n\">Mathlib</span><span class=\"bp\">/</span><span class=\"n\">Tactic</span><span class=\"bp\">/</span><span class=\"n\">Common.lean</span><span class=\"o\">:</span><span class=\"kn\">import</span> <span class=\"n\">ImportGraph.Imports</span>\n<span class=\"bp\">~/</span><span class=\"n\">build</span><span class=\"bp\">/</span><span class=\"n\">lean</span><span class=\"bp\">/</span><span class=\"n\">mathlib4</span> <span class=\"bp\">$</span> <span class=\"n\">lake</span> <span class=\"n\">build</span> <span class=\"n\">Mathlib.Tactic.Common</span>\n<span class=\"o\">[</span><span class=\"mi\">115</span><span class=\"bp\">/</span><span class=\"mi\">193</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">ImportGraph.RequiredModules</span>\n<span class=\"o\">[</span><span class=\"mi\">433</span><span class=\"bp\">/</span><span class=\"mi\">435</span><span class=\"o\">]</span> <span class=\"n\">Building</span> <span class=\"n\">ImportGraph.Imports</span>\n</code></pre></div>",
        "id": 412957768,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1705325457
    },
    {
        "content": "<p>Plausible fix: <a href=\"https://github.com/leanprover-community/mathlib4/pull/9760\">https://github.com/leanprover-community/mathlib4/pull/9760</a></p>",
        "id": 412958343,
        "sender_full_name": "Joachim Breitner",
        "timestamp": 1705325670
    }
]